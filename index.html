<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase åº«å­˜ç®¡ç†æ‡‰ç”¨ç¨‹å¼</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

    <style>
        /* ä¿æŒåŸæœ‰çš„ Quagga æƒæå™¨æ¨£å¼ */
        #interactive.viewport {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }
        #interactive.viewport canvas, video {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        #interactive.viewport .drawingBuffer {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        .drawingBuffer > canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        .laser-box {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 10px;
            margin-left: -40%;
            margin-top: -5px;
            background: red;
            opacity: 0.5;
            box-shadow: 0 0 10px red;
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            from { opacity: 0.5; }
            to { opacity: 0.8; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const { createClient } = supabase;

        // ----------------------------------------------------------------------
        // 1. è¨­å®š Supabase
        // ----------------------------------------------------------------------
        const SUPABASE_URL = 'https://edtoegcycroomrcebywq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkdG9lZ2N5Y3Jvb21yY2VieXdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMjczMzcsImV4cCI6MjA3OTgwMzMzN30.PFVzPDIhxrxW47lDaUW-3aQtD_QbwJcn2muENJRra_s';
        const COMMON_CURRENCIES = ['USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'HKD', 'TWD', 'CNY', 'VND', 'SGD']; 

        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ----------------------------------------------------------------------
        // 2. è¼”åŠ©å‡½å¼
        // ----------------------------------------------------------------------

        // æ ¼å¼åŒ–è²¨å¹£
        const formatCurrency = (amount, currencyCode = 'USD') => {
            if (typeof amount !== 'number' || isNaN(amount)) return '';
            try {
                const formatter = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currencyCode,
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2,
                });
                return formatter.format(amount);
            } catch (e) {
                return `${currencyCode} ${amount.toFixed(2)}`;
            }
        };

        // æ ¼å¼åŒ–æ™‚é–“æˆ³
        const formatTimestamp = (timestamp) => {
            if (!timestamp) return '-';
            try {
                // å°‡ ISO 8601 æ ¼å¼çš„å­—ä¸²è½‰æ›æˆ Date ç‰©ä»¶
                return new Date(timestamp).toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false,
                });
            } catch (e) {
                return timestamp; // è¿”å›åŸå§‹å€¼ä»¥é˜²è§£æéŒ¯èª¤
            }
        };


// èšåˆåº«å­˜æ•¸æ“š (ä¿®æ­£ç‰ˆæœ¬)
        const aggregateInventoryData = (inventory = [], stockOuts = []) => {
            const grouped = {};
            const stockOutMap = {};

            // 1. è™•ç†å‡ºåº«æ•¸æ“š
            stockOuts.forEach(out => {
                const key = out.barcode;
                stockOutMap[key] = (stockOutMap[key] || 0) + out.quantity;
            });

            // 2. è™•ç†å…¥åº«æ•¸æ“šä¸¦èšåˆ
            inventory.forEach(item => {
                const key = item.barcode;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        barcode: item.barcode,
                        name: item.name,
                        category: item.category,
                        totalInStock: 0,
                        totalCost: 0,
                        avgCost: 0,
                        avgPurchasePrice: 0, // æ–°å¢ï¼šå¹³å‡è³¼å…¥åƒ¹
                        maxPrice: 0,         // æ–°å¢ï¼šæœ€é«˜åƒ¹
                        minPrice: 0,         // æ–°å¢ï¼šæœ€ä½åƒ¹
                        currentStock: 0,
                    };
                }
                // totalInStock ç¨å¾Œæœƒé‡æ–°è¨ˆç®—ï¼Œé€™è£¡åƒ…ç”¨ä¾†åˆå§‹åŒ–
            });

            // 3. è¨ˆç®—å¹³å‡æˆæœ¬ã€å¹³å‡è³¼å…¥åƒ¹ã€æœ€é«˜/æœ€ä½åƒ¹å’Œå‰©é¤˜åº«å­˜
            Object.values(grouped).forEach(item => {
                const uniquePurchaseRecords = inventory.filter(inv => inv.barcode === item.barcode);
                
                // æ’é™¤åƒ¹æ ¼ç‚º 0 çš„ã€Œè´ˆå“ã€è¨˜éŒ„
                const validPurchaseRecords = uniquePurchaseRecords.filter(rec => (rec.price || 0) > 0);

                item.totalInStock = uniquePurchaseRecords.length; // ç¸½å…¥åº«æ•¸é‡ (åŒ…å«è´ˆå“)
                
                // ç¸½æˆæœ¬ (åŒ…å«è´ˆå“)
                item.totalCost = uniquePurchaseRecords.reduce((sum, rec) => sum + (rec.price || 0), 0);
                
                // ç¾æ™‚å¹³å‡æˆæœ¬ (ç¸½æˆæœ¬ / ç¸½æ•¸é‡)
                item.avgCost = item.totalInStock > 0 ? item.totalCost / item.totalInStock : 0;
                
                // è¨ˆç®—å¹³å‡è³¼å…¥åƒ¹ (æ’é™¤è´ˆå“)
                if (validPurchaseRecords.length > 0) {
                    const validTotalCost = validPurchaseRecords.reduce((sum, rec) => sum + rec.price, 0);
                    item.avgPurchasePrice = validTotalCost / validPurchaseRecords.length;
                    
                    // è¨ˆç®—æœ€é«˜åƒ¹ (å¾æœ‰æ•ˆè³¼å…¥è¨˜éŒ„ä¸­å–æœ€å¤§å€¼)
                    item.maxPrice = Math.max(...validPurchaseRecords.map(rec => rec.price));
                    
                    // è¨ˆç®—æœ€ä½åƒ¹ (å¾æœ‰æ•ˆè³¼å…¥è¨˜éŒ„ä¸­å–æœ€å°å€¼ï¼Œæ’é™¤ 0)
                    item.minPrice = Math.min(...validPurchaseRecords.map(rec => rec.price));
                } else {
                    item.avgPurchasePrice = 0;
                    item.maxPrice = 0;
                    item.minPrice = 0; 
                }
                
                const totalOut = stockOutMap[item.barcode] || 0;
                item.currentStock = item.totalInStock - totalOut;
            });

            return Object.values(grouped);
        };

        // ----------------------------------------------------------------------
        // 3. Supabase èº«ä»½é©—è­‰/ç™»å…¥çµ„ä»¶ (AuthForm)
        // ----------------------------------------------------------------------
        const AuthForm = ({ supabaseClient }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLogin, setIsLogin] = useState(true);
            const [message, setMessage] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMessage('');

                try {
                    if (isLogin) {
                        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                    } else {
                        const { error } = await supabaseClient.auth.signUp({ email, password });
                        if (error) throw error;
                        setMessage('è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥æ‚¨çš„é›»å­éƒµä»¶ä»¥ç¢ºèªå¸³æˆ¶ï¼Œç„¶å¾Œç™»å…¥ã€‚');
                    }
                } catch (error) {
                    const displayMessage = error.message || 'æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥é›»å­éƒµä»¶/å¯†ç¢¼ã€‚';
                    setMessage(displayMessage);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                        <h1 className="text-3xl font-bold text-center mb-6 text-gray-800">
                            {isLogin ? 'ç™»å…¥' : 'è¨»å†Š'}
                        </h1>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                    placeholder="your@email.com"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">å¯†ç¢¼</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                    placeholder="è‡³å°‘ 6 ä½å­—å…ƒ"
                                />
                            </div>
                            {message && (
                                <p className={`p-3 text-sm rounded-lg ${message.includes('æˆåŠŸ') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {message}
                                </p>
                            )}
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50"
                            >
                                {loading ? 'è™•ç†ä¸­...' : (isLogin ? 'ç™»å…¥' : 'è¨»å†Š')}
                            </button>
                        </form>
                        <div className="mt-6 text-center">
                            <button
                                onClick={() => setIsLogin(!isLogin)}
                                className="text-sm text-blue-600 hover:text-blue-800 transition duration-150"
                            >
                                {isLogin ? 'é‚„æ²’æœ‰å¸³æˆ¶ï¼Ÿé»æ­¤è¨»å†Š' : 'å·²ç¶“æœ‰å¸³æˆ¶äº†ï¼Ÿé»æ­¤ç™»å…¥'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 4. BarcodeScanner çµ„ä»¶
        // ----------------------------------------------------------------------
        const BarcodeScanner = ({ onDetected }) => {
            const [error, setError] = useState(null);
            const scannerRef = React.useRef(null);

            useEffect(() => {
                if (!Quagga) return;

                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: scannerRef.current,
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment" 
                        },
                    },
                    decoder: {
                        readers: ["ean_reader", "upc_reader", "code_128_reader", "code_39_reader"]
                    },
                }, (err) => {
                    if (err) {
                        setError(`ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: ${err.message}`);
                        return;
                    }
                    Quagga.start();
                });

                Quagga.onDetected((data) => {
                    if (data && data.codeResult && data.codeResult.code) {
                        onDetected(data.codeResult.code);
                        Quagga.stop();
                    }
                });

                return () => {
                    Quagga.stop();
                };
            }, [onDetected]);

            return (
                <div className="relative">
                    {error ? (
                        <div className="p-4 text-center text-red-600 bg-red-50">{error}</div>
                    ) : (
                        <div id="interactive" className="viewport" ref={scannerRef}>
                            <div className="laser-box"></div>
                        </div>
                    )}
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 5. å–®ç­†äº¤æ˜“ç·¨è¼¯/åˆªé™¤çµ„ä»¶ (TransactionRow)
        // ----------------------------------------------------------------------
        const TransactionRow = ({ record, onUpdated, userId }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editData, setEditData] = useState({
                price: record.price || 0,
                currency: record.currency || 'HKD',
                store: record.store || '', // Supabase ä½¿ç”¨ store æ¬„ä½
                quantity: Math.abs(record.quantity),
            });
            const [saving, setSaving] = useState(false);
            const [message, setMessage] = useState('');

            const isPurchase = record.type === 'PURCHASE';
            const tableName = isPurchase ? 'inventory_items' : 'stock_outs';

            // è™•ç†å„²å­˜å–®ç­†ç´€éŒ„
            const handleSave = async () => {
                if (isPurchase && (editData.price < 0 || !editData.currency)) {
                    setMessage('å–®åƒ¹èˆ‡è²¨å¹£ç‚ºå¿…å¡«');
                    return;
                }
                if (!isPurchase && (editData.quantity <= 0)) {
                    setMessage('å‡ºåº«æ•¸é‡å¿…é ˆå¤§æ–¼ 0');
                    return;
                }
                setSaving(true);
                setMessage('');
                try {
                    const updateObj = isPurchase
                        ? {
                            price: parseFloat(editData.price),
                            currency: editData.currency.toUpperCase().trim(),
                            store: editData.store.trim() || null,
                          }
                        : { quantity: parseInt(editData.quantity) };
                    
                    const { error } = await supabaseClient
                        .from(tableName) 
                        .update(updateObj)
                        .eq('id', record.id)
                        .eq('user_id', userId); 

                    if (error) throw error;
                    setMessage('å·²æ›´æ–°ï¼');
                    setIsEditing(false);
                    onUpdated?.(); // é€šçŸ¥çˆ¶å±¤åˆ·æ–°æ•¸æ“š
                } catch (err) {
                    console.error(err);
                    setMessage('æ›´æ–°å¤±æ•—');
                } finally {
                    setSaving(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };

            // è™•ç†åˆªé™¤å–®ç­†ç´€éŒ„
            const handleDelete = async () => {
                if (!window.confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™ç­†${isPurchase ? 'è³¼å…¥' : 'å‡ºåº«'}ç´€éŒ„å—ï¼Ÿ`)) return;
                setSaving(true);
                setMessage('');
                try {
                    const { error } = await supabaseClient
                        .from(tableName) 
                        .delete()
                        .eq('id', record.id)
                        .eq('user_id', userId);

                    if (error) throw error;
                    setMessage('å·²åˆªé™¤ï¼');
                    onUpdated?.();
                } catch (err) {
                    console.error(err);
                    setMessage('åˆªé™¤å¤±æ•—');
                } finally {
                    setSaving(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };

            if (isEditing) {
                return (
                    <tr className="bg-yellow-50">
                        <td className="px-4 py-2"><span className={`px-2 py-1 text-xs rounded-full ${isPurchase ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{isPurchase ? 'è³¼å…¥' : 'å‡ºåº«'}</span></td>
                        <td className="px-4 py-2">
                            {isPurchase ? '+1' : (
                                <input type="number" min="1" value={editData.quantity} onChange={e => setEditData({ ...editData, quantity: e.target.value })} className="w-20 px-2 py-1 border rounded" />
                            )}
                        </td>
                        <td className="px-4 py-2">
                            {isPurchase ? (
                                <input type="number" step="0.01" value={editData.price} onChange={e => setEditData({ ...editData, price: e.target.value })} className="w-24 px-2 py-1 border rounded" />
                            ) : '-'}
                        </td>
                        <td className="px-4 py-2">
                            {isPurchase ? (
                                <select value={editData.currency} onChange={e => setEditData({ ...editData, currency: e.target.value })} className="px-2 py-1 border rounded text-sm">
                                    {COMMON_CURRENCIES.map(code => (<option key={code} value={code}>{code}</option>))}
                                </select>
                            ) : '-'}
                        </td>
                        <td className="px-4 py-2">
                            {isPurchase ? (
                                <input type="text" value={editData.store} onChange={e => setEditData({ ...editData, store: e.target.value })} className="w-full px-2 py-1 border rounded" placeholder="åº—åæˆ–å…¶ä»–å‚™è¨»" />
                            ) : record.store}
                        </td>
                        <td className="px-4 py-2 text-xs text-gray-500">{formatTimestamp(record.created_at)}</td>
                        <td className="px-4 py-2 text-xs">
                            <div className="flex items-center gap-2">
                                <button onClick={handleSave} disabled={saving} className="text-green-600 font-bold hover:text-green-800">å„²å­˜</button>
                                <button onClick={() => setIsEditing(false)} className="text-gray-500 hover:text-gray-700">å–æ¶ˆ</button>
                            </div>
                            {message && <span className="block text-xs mt-1 text-green-600">{message}</span>}
                        </td>
                    </tr>
                );
            }

            // ä¸€èˆ¬é¡¯ç¤ºæ¨¡å¼
            return (
                <tr className="hover:bg-gray-50">
                    <td className="px-4 py-2">
                        <span className={`px-2 py-1 text-xs rounded-full ${isPurchase ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                            {isPurchase ? 'è³¼å…¥' : 'å‡ºåº«'}
                        </span>
                    </td>
                    <td className={`px-4 py-2 font-semibold ${record.type === 'PURCHASE' ? 'text-green-700' : 'text-red-700'}`}>
                        {record.type === 'PURCHASE' ? '+1' : `-${record.quantity}`}
                    </td>
                    <td className="px-4 py-2">
                        {record.type === 'PURCHASE' ? (
                            record.price > 0 ? (
                                <span className="font-medium text-green-700">
                                    {formatCurrency(record.price, record.currency)}
                                </span>
                            ) : (
                                <span className="text-purple-600 font-medium">è´ˆå“</span>
                            )
                        ) : (
                            <span className="text-gray-400">-</span>
                        )}
                    </td>
                    <td className="px-4 py-2">{record.currency || '-'}</td>
                    <td className="px-4 py-2">{record.store || '-'}</td>
                    <td className="px-4 py-2 text-xs text-gray-500">{formatTimestamp(record.created_at)}</td>
                    <td className="px-4 py-2 text-xs">
                        <div className="flex items-center gap-3">
                            <button
                                onClick={() => setIsEditing(true)}
                                className="text-blue-600 hover:text-blue-800 font-medium"
                            >
                                ç·¨è¼¯
                            </button>
                            <button
                                onClick={handleDelete}
                                className="text-red-600 hover:text-red-800 font-medium"
                            >
                                åˆªé™¤
                            </button>
                        </div>
                    </td>
                </tr>
            );
        };

        // ----------------------------------------------------------------------
        // 6.1. å¿«é€Ÿå–è²¨/å‡ºåº«é¢æ¿ (QuickStockOutPanel)
        // ----------------------------------------------------------------------
        const QuickStockOutPanel = ({ item, currentStock, userId, refreshData }) => {
            const [takeOutQuantity, setTakeOutQuantity] = useState(1);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            const handleTakeOut = async () => {
                const qty = parseInt(takeOutQuantity, 10);
                if (isNaN(qty) || qty <= 0) {
                    setMessage('è«‹è¼¸å…¥æ­£ç¢ºçš„æ•¸é‡');
                    return;
                }
                if (qty > currentStock) {
                    setMessage(`å‡ºåº«æ•¸é‡ä¸èƒ½å¤§æ–¼ç›®å‰åº«å­˜ ${currentStock} ä»¶`);
                    return;
                }

                setLoading(true);
                setMessage('');
                try {
                    const newStockOut = {
                        user_id: userId,
                        barcode: item.barcode,
                        name: item.name,
                        quantity: qty,
                        // store: '', // ä¿æŒä¸€è‡´ï¼Œæš«æ™‚ä¸è¨˜éŒ„å‚™è¨»
                    };

                    const { error } = await supabaseClient
                        .from('stock_outs') 
                        .insert([newStockOut]);

                    if (error) throw error;

                    setMessage(`æˆåŠŸå‡ºåº« ${qty} ä»¶ï¼`);
                    setTakeOutQuantity(1);
                    refreshData?.();
                    
                } catch (err) {
                    console.error("Supabase Stock Out Error:", err);
                    setMessage('å‡ºåº«å¤±æ•—');
                } finally {
                    setLoading(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };
            
            return (
                <div className="p-4 bg-red-50 border border-red-200 rounded-lg shadow-sm">
                    <h4 className="text-lg font-semibold text-red-700 mb-3">ğŸ“¦ å¿«é€Ÿå–è²¨ / å‡ºåº«</h4>
                    <div className="flex items-center gap-4">
                        <input
                            type="number"
                            min="1"
                            max={currentStock}
                            value={takeOutQuantity}
                            onChange={(e) => setTakeOutQuantity(Math.max(1, parseInt(e.target.value) || 1))}
                            className="w-24 p-2 border border-red-300 rounded-lg text-center"
                            disabled={currentStock <= 0}
                        />
                        <button
                            onClick={handleTakeOut}
                            disabled={loading || currentStock <= 0 || takeOutQuantity > currentStock}
                            className="flex-grow py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-300 disabled:opacity-50"
                        >
                            {loading ? 'è™•ç†ä¸­...' : `å–è²¨å‡ºåº« (${currentStock} å‰©é¤˜)`}
                        </button>
                    </div>
                    {message && <p className={`mt-2 text-sm ${message.includes('æˆåŠŸ') ? 'text-green-700' : 'text-red-700'}`}>{message}</p>}
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 6.2. å¿«é€Ÿè£œè²¨/å…¥åº«é¢æ¿ (QuickStockInPanel)
        // ----------------------------------------------------------------------
        const QuickStockInPanel = ({ item, settings, userId, refreshData }) => {
            const [addQuantity, setAddQuantity] = useState(1);
            const [addPrice, setAddPrice] = useState(''); // å–®ä»¶åƒ¹æ ¼
            const [addCurrency, setAddCurrency] = useState(settings.currency);
            const [addStore, setAddStore] = useState(''); // å‚™è¨»
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            const isValidPrice = addPrice !== '' && !isNaN(addPrice) && parseFloat(addPrice) >= 0;

            const handleAddStock = async () => {
                const qty = parseInt(addQuantity, 10);
                if (isNaN(qty) || qty <= 0 || !isValidPrice || !addCurrency) {
                    setMessage('è«‹æª¢æŸ¥æ•¸é‡ã€å–®åƒ¹å’Œè²¨å¹£æ˜¯å¦å¡«å¯«æ­£ç¢º');
                    return;
                }

                setLoading(true);
                setMessage('');
                
                const itemTemplate = {
                    user_id: userId,
                    name: item.name,
                    barcode: item.barcode,
                    category: item.category, 
                    price: parseFloat(addPrice), 
                    currency: addCurrency, 
                    store: addStore.trim() || null, 
                };

                try {
                    const itemsToInsert = Array.from({ length: qty }, () => ({
                        ...itemTemplate
                    }));

                    const { error } = await supabaseClient
                        .from('inventory_items') 
                        .insert(itemsToInsert);

                    if (error) throw error;

                    setMessage(`æˆåŠŸè£œè²¨ ${qty} ä»¶ï¼`);
                    setAddQuantity(1);
                    setAddPrice('');
                    setAddStore('');
                    refreshData?.();
                } catch (err) {
                    console.error("Supabase Insert Error:", err);
                    setMessage('è£œè²¨å¤±æ•—');
                } finally {
                    setLoading(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };

            return (
                <div className="p-4 bg-green-50 border border-green-200 rounded-lg shadow-sm">
                    <h4 className="text-lg font-semibold text-green-700 mb-3">ğŸ›’ å¿«é€Ÿè£œè²¨ / å…¥åº«</h4>
                    
                    <div className="grid grid-cols-1 sm:grid-cols-4 gap-2 mb-3">
                        {/* æ•¸é‡ */}
                        <div>
                            <label className="block text-xs font-medium text-gray-700">æ•¸é‡*</label>
                            <input
                                type="number"
                                min="1"
                                value={addQuantity}
                                onChange={(e) => setAddQuantity(Math.max(1, parseInt(e.target.value) || 1))}
                                className="w-full p-1 border border-green-300 rounded-lg text-center"
                            />
                        </div>
                        {/* åƒ¹æ ¼ */}
                        <div>
                            <label className="block text-xs font-medium text-gray-700">å–®åƒ¹*</label>
                            <input
                                type="number"
                                step="0.01"
                                value={addPrice}
                                onChange={(e) => setAddPrice(e.target.value)}
                                className={`w-full p-1 border rounded-lg text-center ${isValidPrice ? 'border-green-300' : 'border-red-400'}`}
                                placeholder="0.00"
                            />
                        </div>
                        {/* è²¨å¹£ */}
                        <div>
                            <label className="block text-xs font-medium text-gray-700">è²¨å¹£*</label>
                            <select
                                value={addCurrency}
                                onChange={(e) => setAddCurrency(e.target.value)}
                                className="w-full p-1 border border-green-300 rounded-lg text-sm"
                            >
                                {COMMON_CURRENCIES.map(code => (
                                    <option key={code} value={code}>{code}</option>
                                ))}
                            </select>
                        </div>
                         {/* å‚™è¨»/åº—å */}
                        <div className="col-span-1">
                            <label className="block text-xs font-medium text-gray-700">å‚™è¨»/åº—å</label>
                            <input
                                type="text"
                                value={addStore}
                                onChange={(e) => setAddStore(e.target.value)}
                                className="w-full p-1 border border-green-300 rounded-lg"
                                placeholder="å¯é¸"
                            />
                        </div>
                    </div>

                    <button
                        onClick={handleAddStock}
                        disabled={loading || !isValidPrice || addQuantity <= 0}
                        className="w-full py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-300 disabled:opacity-50 text-sm"
                    >
                        {loading ? 'è™•ç†ä¸­...' : 'ç¢ºèªè£œè²¨å…¥åº«'}
                    </button>
                    {message && <p className={`mt-2 text-sm ${message.includes('æˆåŠŸ') ? 'text-green-700' : 'text-red-700'}`}>{message}</p>}
                </div>
            );
        };
        

        // ----------------------------------------------------------------------
        // 7. è©³ç´°æ˜ç´°å½ˆçª— (DetailModal) - åŒ…å«æ‰€æœ‰ç·¨è¼¯å’Œå¿«é€Ÿæ“ä½œåŠŸèƒ½
        // ----------------------------------------------------------------------
        const DetailModal = ({ item, inventory, stockOuts, onClose, settings, userId, refreshData }) => {
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            // ç·¨è¼¯ç‹€æ…‹
            const [isEditingName, setIsEditingName] = useState(false);
            const [isEditingBarcode, setIsEditingBarcode] = useState(false);
            const [isEditingCategory, setIsEditingCategory] = useState(false);
            const [editName, setEditName] = useState(item.name);
            const [editBarcode, setEditBarcode] = useState(item.barcode);
            const [editCategory, setEditCategory] = useState(item.category);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            
            // äº¤æ˜“æ­·å²è¨˜éŒ„ (ä¿æŒä¸è®Š)
            const transactionHistory = useMemo(() => {
                const purchases = inventory
                    .filter(rec => rec.barcode === item.barcode)
                    .map(rec => ({
                        id: rec.id, type: 'PURCHASE', quantity: 1, price: rec.price, currency: rec.currency, store: rec.store, created_at: rec.created_at,
                    }));
                const stockOutsForBarcode = stockOuts
                    .filter(out => out.barcode === item.barcode)
                    .map(out => ({
                        id: out.id, type: 'STOCK_OUT', quantity: out.quantity, price: 0, currency: settings.currency, store: out.store, created_at: out.created_at,
                    }));
                
                // åˆä½µä¸¦æŒ‰æ™‚é–“é™åºæ’åˆ— (Supabase ä½¿ç”¨ created_at)
                return [...purchases, ...stockOutsForBarcode].sort((a, b) => {
                    return new Date(b.created_at) - new Date(a.created_at);
                });
            }, [inventory, stockOuts, item.barcode, settings.currency]);


            // â”€â”€ 1. ä¿®æ”¹åç¨± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const handleUpdateName = async () => {
                if (editName.trim() === '' || editName === item.name) {
                    setIsEditingName(false);
                    return;
                }
                setLoading(true);
                setMessage('');
                try {
                    const { error: invError } = await supabaseClient
                        .from('inventory_items')
                        .update({ name: editName.trim() })
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);
                    
                    if (invError) throw invError;
                    
                    await supabaseClient
                        .from('stock_outs')
                        .update({ name: editName.trim() })
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);

                    setMessage('é …ç›®åç¨±å·²æ›´æ–°ï¼');
                    setIsEditingName(false);
                    refreshData?.(); 
                } catch (err) {
                    console.error(err);
                    setMessage('æ›´æ–°åç¨±å¤±æ•—');
                } finally {
                    setLoading(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };

            // â”€â”€ 2. ä¿®æ”¹æ¢ç¢¼ï¼ˆå…¨éƒ¨ç›¸é—œè¨˜éŒ„ä¸€èµ·æ”¹ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const handleUpdateBarcode = async () => {
                const newBarcode = editBarcode.trim();
                if (newBarcode === '' || newBarcode === item.barcode) {
                    setIsEditingBarcode(false);
                    return;
                }
                setLoading(true);
                setMessage('');
                try {
                    const { error: invError } = await supabaseClient
                        .from('inventory_items')
                        .update({ barcode: newBarcode })
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);
                    if (invError) throw invError;

                    const { error: outError } = await supabaseClient
                        .from('stock_outs')
                        .update({ barcode: newBarcode })
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);
                    if (outError) throw outError;

                    setMessage(`æ¢ç¢¼å·²è®Šæ›´ç‚º ${newBarcode}ï¼`);
                    setIsEditingBarcode(false);
                    refreshData?.();
                    onClose(); 
                } catch (err) {
                    console.error(err);
                    setMessage('è®Šæ›´æ¢ç¢¼å¤±æ•—');
                } finally {
                    setLoading(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };
            
            // â”€â”€ 3. ä¿®æ”¹åˆ†é¡ï¼ˆå…¨éƒ¨ç›¸é—œè¨˜éŒ„ä¸€èµ·æ”¹ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const handleUpdateCategory = async () => {
                if (editCategory === item.category) {
                    setIsEditingCategory(false);
                    return;
                }
                setLoading(true);
                setMessage('');
                try {
                    const { error } = await supabaseClient
                        .from('inventory_items')
                        .update({ category: editCategory })
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);

                    if (error) throw error;
                    
                    setMessage('åˆ†é¡å·²æ›´æ–°ï¼');
                    setIsEditingCategory(false);
                    refreshData?.();
                } catch (err) {
                    console.error(err);
                    setMessage('æ›´æ–°åˆ†é¡å¤±æ•—');
                } finally {
                    setLoading(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };


            // â”€â”€ 4. åˆªé™¤æ•´å€‹æ¢ç¢¼é …ç›® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const handleDeleteAll = async () => {
                if (!window.confirm('âš ï¸ ç¢ºå®šè¦ã€Œæ°¸ä¹…åˆªé™¤ã€é€™å€‹æ¢ç¢¼çš„æ‰€æœ‰è³¼å…¥èˆ‡å‡ºåº«ç´€éŒ„å—ï¼Ÿ\næ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) return;

                setLoading(true);
                setMessage('');

                try {
                    const { error: invError } = await supabaseClient
                        .from('inventory_items')
                        .delete()
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);
                    if (invError) throw invError;

                    const { error: outError } = await supabaseClient
                        .from('stock_outs')
                        .delete()
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);
                    if (outError) throw outError;

                    setMessage('å·²æ°¸ä¹…åˆªé™¤æ­¤æ¢ç¢¼çš„æ‰€æœ‰ç´€éŒ„ï¼');
                    onClose(); 
                    refreshData?.(); 
                } catch (err) {
                    console.error("åˆªé™¤å¤±æ•—:", err);
                    setMessage('åˆªé™¤å¤±æ•—ï¼š' + err.message);
                } finally {
                    setLoading(false);
                    setShowDeleteConfirm(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };


            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            
                            {/* é ‚éƒ¨æ¨™é¡Œèˆ‡æ§åˆ¶é … */}
                            <div className="flex justify-between items-start border-b pb-4 mb-4">
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-800">
                                        é …ç›®æ˜ç´°ï¼š
                                        {isEditingName ? (
                                            <input 
                                                value={editName} 
                                                onChange={(e) => setEditName(e.target.value)}
                                                onBlur={handleUpdateName}
                                                onKeyDown={(e) => {if (e.key === 'Enter') handleUpdateName()}}
                                                className="border-b border-blue-500 p-1 text-xl font-bold inline-block w-60"
                                                autoFocus
                                            />
                                        ) : (
                                            <span 
                                                className="cursor-pointer hover:bg-yellow-100 p-1 rounded transition"
                                                onClick={() => {setEditName(item.name); setIsEditingName(true);}}
                                            >
                                                {item.name}
                                            </span>
                                        )}
                                    </h2>
                                    <p className="text-sm text-gray-600 mt-1">
                                        æ¢ç¢¼: 
                                        {isEditingBarcode ? (
                                            <input 
                                                value={editBarcode} 
                                                onChange={(e) => setEditBarcode(e.target.value)}
                                                onBlur={handleUpdateBarcode}
                                                onKeyDown={(e) => {if (e.key === 'Enter') handleUpdateBarcode()}}
                                                className="border-b border-blue-500 p-1 text-sm inline-block w-40"
                                                autoFocus
                                            />
                                        ) : (
                                            <span 
                                                className="cursor-pointer hover:bg-yellow-100 p-1 rounded transition"
                                                onClick={() => {setEditBarcode(item.barcode); setIsEditingBarcode(true);}}
                                            >
                                                {item.barcode}
                                            </span>
                                        )}
                                    </p>
                                </div>
                                <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-3xl leading-none">Ã—</button>
                            </div>

                            {message && (
                                <p className={`mb-4 p-3 text-sm rounded-lg ${message.includes('æˆåŠŸ') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {message}
                                </p>
                            )}
                            
                            {/* ç¸½è¦½è³‡è¨Šå€å¡Š */}
                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 text-center">
                                <div className="p-4 bg-blue-50 rounded-lg">
                                    <p className="text-xs text-gray-600">ç¾æœ‰åº«å­˜</p>
                                    <p className="text-2xl font-bold text-blue-800">{item.currentStock}</p>
                                </div>
                                <div className="p-4 bg-green-50 rounded-lg">
                                    <p className="text-xs text-gray-600">å¹³å‡æˆæœ¬</p>
                                    <p className="text-xl font-bold text-green-800">{formatCurrency(item.avgCost, settings.currency)}</p>
                                </div>
                                <div className="p-4 bg-gray-50 rounded-lg flex flex-col justify-center">
                                    <p className="text-xs text-gray-600">åˆ†é¡</p>
                                    {isEditingCategory ? (
                                        <select
                                            value={editCategory}
                                            onChange={(e) => setEditCategory(e.target.value)}
                                            onBlur={handleUpdateCategory}
                                            className="mt-1 p-1 border border-blue-500 rounded text-center text-md font-bold"
                                            autoFocus
                                        >
                                            {settings.categories.map(cat => (
                                                <option key={cat} value={cat}>{cat}</option>
                                            ))}
                                        </select>
                                    ) : (
                                        <p 
                                            className="text-xl font-bold text-gray-800 cursor-pointer hover:bg-yellow-100 p-1 rounded transition"
                                            onClick={() => {setEditCategory(item.category); setIsEditingCategory(true);}}
                                        >
                                            {item.category}
                                        </p>
                                    )}
                                </div>
                            </div>
                            
                            {/* âœ… æ–°å¢ï¼šå¿«é€Ÿå–è²¨èˆ‡è£œè²¨é¢æ¿ */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                                <QuickStockOutPanel 
                                    item={item} 
                                    currentStock={item.currentStock} 
                                    userId={userId} 
                                    refreshData={refreshData}
                                />
                                <QuickStockInPanel
                                    item={item}
                                    settings={settings}
                                    userId={userId}
                                    refreshData={refreshData}
                                />
                            </div>

                            <h3 className="text-xl font-semibold mb-3 border-b pb-2 text-gray-700">äº¤æ˜“æ­·å²è¨˜éŒ„</h3>
                            
                            {/* äº¤æ˜“æ˜ç´°è¡¨æ ¼ */}
                            <div className="overflow-x-auto border rounded-lg">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">é¡å‹</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ•¸é‡</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å–®åƒ¹/æˆæœ¬</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">è²¨å¹£</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å‚™è¨»/åº—å</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ™‚é–“</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {transactionHistory.length === 0 ? (
                                            <tr><td colSpan="7" className="px-6 py-4 text-center text-gray-500">ç„¡è©³ç´°äº¤æ˜“è¨˜éŒ„ã€‚</td></tr>
                                        ) : (
                                            transactionHistory.map((record) => (
                                                <TransactionRow 
                                                    key={record.id} 
                                                    record={record} 
                                                    onUpdated={refreshData} // æ¯æ¬¡æ›´æ–°å¾Œé‡æ–°è¼‰å…¥æ•¸æ“š
                                                    userId={userId}
                                                />
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* åº•éƒ¨æ“ä½œæŒ‰éˆ• */}
                        <div className="p-4 bg-gray-50 border-t flex justify-between items-center">
                            <button
                                onClick={handleDeleteAll}
                                disabled={loading}
                                className="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-300 disabled:opacity-50 text-sm"
                            >
                                æ°¸ä¹…åˆªé™¤æ­¤æ¢ç¢¼æ‰€æœ‰ç´€éŒ„
                            </button>
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-300"
                            >
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 8. æ‡‰ç”¨ç¨‹å¼ä¸»é«”ï¼šApp çµ„ä»¶ (ä¿®æ­£äº† Hooks çš„èª¿ç”¨é †åº)
        // ----------------------------------------------------------------------
        const App = () => {
            // --- ç‹€æ…‹ Hooks (å¿…é ˆåœ¨çµ„ä»¶é ‚éƒ¨) ---
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('inventory'); 

            // Data States
            const [inventory, setInventory] = useState([]); 
            const [stockOuts, setStockOuts] = useState([]);
            const [settings, setSettings] = useState(null); 
            const [selectedItem, setSelectedItem] = useState(null); // ç”¨æ–¼æ˜ç´°å½ˆçª—

            // Derived State
            const userId = session?.user?.id || null;
            
            // è™•ç†è³‡æ–™ç²å–å’Œè¨‚é–±çš„å‡½å¼ (useCallback)
            const fetchInitialData = useCallback(async () => {
                if (!userId) return;

                // Fetch Inventory Items (inventory_items table)
                const { data: invData, error: invError } = await supabaseClient
                    .from('inventory_items') 
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false }); // ç¢ºä¿æœ€æ–°çš„è¨˜éŒ„åœ¨å‰é¢
                if (invError) console.error("Error fetching inventory:", invError);
                else setInventory(invData);

                // Fetch Stock Outs (stock_outs table)
                const { data: outData, error: outError } = await supabaseClient
                    .from('stock_outs') 
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });
                if (outError) console.error("Error fetching stock outs:", outError);
                else setStockOuts(outData);

                // Fetch Settings (user_settings table)
                const { data: settingsData, error: settingsError } = await supabaseClient
                    .from('user_settings') 
                    .select('*')
                    .eq('user_id', userId)
                    .maybeSingle(); 
                    
                if (settingsError && settingsError.code !== 'PGRST116') { 
                        console.error("Error fetching settings:", settingsError);
                } else if (settingsData) {
                    let categoriesArray = settingsData.categories;
                    if (typeof categoriesArray === 'string') {
                        categoriesArray = categoriesArray.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    }
                    setSettings({ ...settingsData, categories: categoriesArray || [] });

                } else {
                     setSettings({ categories: ['é›»å­ç”¢å“', 'æœè£', 'é£Ÿå“', 'æ›¸ç±', 'å…¶ä»–'], currency: 'HKD', user_id: userId });
                }
            }, [userId]);


            // 1. Supabase èº«ä»½é©—è­‰ç›£è½ (useEffect)
            useEffect(() => {
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    setLoading(false);
                });

                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(
                    (_event, session) => {
                        setSession(session);
                        setLoading(false);
                    }
                );

                return () => subscription.unsubscribe();
            }, []);


            // 2. Supabase å³æ™‚æ•¸æ“šè¨‚é–±/åˆå§‹è¼‰å…¥ (useEffect)
            useEffect(() => {
                if (!userId) return;

                fetchInitialData();

                // Setup Realtime Subscriptions
                // é€™è£¡çš„è¨‚é–±åƒ…ç”¨æ–¼è§¸ç™¼é‡æ–°ç²å–è³‡æ–™ï¼Œä»¥ç¢ºä¿ç·¨è¼¯æ“ä½œå¾Œçš„æ•¸æ“šåˆ·æ–°
                const inventorySubscription = supabaseClient
                    .channel('inventory_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'inventory_items', filter: `user_id=eq.${userId}` }, 
                        (payload) => {
                             fetchInitialData(); 
                        }
                    )
                    .subscribe();

                const stockOutsSubscription = supabaseClient
                    .channel('stock_outs_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'stock_outs', filter: `user_id=eq.${userId}` }, 
                        (payload) => {
                             fetchInitialData(); 
                        }
                    )
                    .subscribe();

                const settingsSubscription = supabaseClient
                    .channel('settings_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'user_settings', filter: `user_id=eq.${userId}` }, 
                        (payload) => {
                             fetchInitialData(); 
                        }
                    )
                    .subscribe();

                return () => {
                    supabaseClient.removeChannel(inventorySubscription);
                    supabaseClient.removeChannel(stockOutsSubscription);
                    supabaseClient.removeChannel(settingsSubscription);
                };
            }, [userId, fetchInitialData]); // ä¾è³´ fetchInitialData

            // --- æ´¾ç”Ÿç‹€æ…‹ Hooks (ä¿®æ­£ï¼šç§»åˆ°æ¢ä»¶åˆ¤æ–·ä¹‹å‰) ---
            // èšåˆæ•¸æ“š
            const overviewData = useMemo(() => aggregateInventoryData(inventory, stockOuts), [inventory, stockOuts]);

            // å°‹æ‰¾é¸ä¸­çš„é …ç›®ï¼ˆå¦‚æœæ•¸æ“šåˆ·æ–°äº†ï¼Œéœ€è¦é‡æ–°åŒ¹é…ï¼‰
            const currentSelectedItem = useMemo(() => {
                if (!selectedItem) return null;
                // ä½¿ç”¨æœ€æ–°çš„ overviewData ä¾†åŒ¹é… selectedItemï¼Œç¢ºä¿æ•¸æ“šæœ€æ–°
                const latestItem = overviewData.find(item => item.barcode === selectedItem.barcode);
                
                // å¦‚æœåœ¨ overviewData ä¸­æ‰¾ä¸åˆ°ï¼ˆä¾‹å¦‚ï¼šè©²é …ç›®åº«å­˜å·²ç‚ºé›¶ä¸”è¢«éæ¿¾ï¼Œä½† DetailModal é‚„é–‹è‘—ï¼‰ï¼Œå‰‡ä½¿ç”¨ selectedItem èˆŠæ•¸æ“š
                return latestItem || selectedItem;
            }, [selectedItem, overviewData]);


            const handleLogout = async () => {
                await supabaseClient.auth.signOut();
            };

            // --- æ¢ä»¶æ¸²æŸ“ (åœ¨ Hooks èª¿ç”¨ä¹‹å¾Œ) ---
            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
                    </div>
                );
            }

            if (!session) {
                return <AuthForm supabaseClient={supabaseClient} />;
            }
            
            // ----------------------------------------------------------------------
            // 9. çµ„ä»¶ - åº«å­˜æ¦‚è¦½ (InventoryOverview) (ä¿æŒä¸è®Š)
            // ----------------------------------------------------------------------
            const InventoryOverview = ({ settings, overviewData, setSelectedItem }) => {
                const [filterText, setFilterText] = useState('');
                const [filterCategory, setFilterCategory] = useState('All'); 
                const [sortKey, setSortKey] = useState('currentStock');
                const [sortDirection, setSortDirection] = useState('desc');

                const categories = Array.isArray(settings.categories) ? settings.categories : (settings.categories || '').split(',').map(s => s.trim());
                
                const filteredAndSortedData = useMemo(() => {
                    let data = overviewData.filter(item => {
                        const textMatch = item.name.toLowerCase().includes(filterText.toLowerCase()) ||
                                          item.barcode.includes(filterText);
                        
                        const categoryMatch = filterCategory === 'All' || item.category === filterCategory;

                        return textMatch && categoryMatch;
                    });

                    data.sort((a, b) => {
                        const valA = a[sortKey];
                        const valB = b[sortKey];
                        let comparison = 0;

                        if (typeof valA === 'string') {
                            comparison = valA.localeCompare(valB);
                        } else {
                            comparison = valA - valB;
                        }

                        return sortDirection === 'asc' ? comparison : comparison * -1;
                    });
                    return data;
                }, [overviewData, filterText, sortKey, sortDirection, filterCategory]);

                const handleSort = (key) => {
                    if (sortKey === key) {
                        setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                    } else {
                        setSortKey(key);
                        setSortDirection('asc');
                    }
                };

                const totalValue = filteredAndSortedData.reduce((sum, item) => sum + (item.currentStock * item.avgCost), 0);

                const getSortIndicator = (key) => {
                    if (sortKey === key) {
                        return sortDirection === 'asc' ? ' â–²' : ' â–¼';
                    }
                    return '';
                };

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-md">
                            <h3 className="text-xl font-semibold text-gray-800">
                                ç¸½åº«å­˜åƒ¹å€¼: <span className="text-blue-600">{formatCurrency(totalValue, settings.currency)}</span>
                            </h3>
                            <div className="flex gap-4">
                                {/* åˆ†é¡ç¯©é¸å™¨ (Select) */}
                                <select
                                    value={filterCategory}
                                    onChange={(e) => setFilterCategory(e.target.value)}
                                    className="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                >
                                    <option value="All">æ‰€æœ‰åˆ†é¡</option>
                                    {categories.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                                <input
                                    type="text"
                                    placeholder="ğŸ” æœå°‹å“åæˆ–æ¢ç¢¼..."
                                    value={filterText}
                                    onChange={(e) => setFilterText(e.target.value)}
                                    className="p-2 border border-gray-300 rounded-lg w-64 focus:ring-blue-500 focus:border-blue-500"
                                />
                            </div>
                        </div>

                        <div className="overflow-x-auto bg-white rounded-xl shadow-md">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        {['åç¨±', 'æ¢ç¢¼', 'é¡åˆ¥', 'ç¾æœ‰åº«å­˜', 'å¹³å‡è³¼å…¥åƒ¹', 'æœ€é«˜åƒ¹', 'æœ€ä½åƒ¹', 'ç¸½æˆæœ¬'].map((header, index) => {
                                        const keyMap = ['name', 'barcode', 'category', 'currentStock', 'avgPurchasePrice', 'maxPrice', 'minPrice', 'totalCost'];
                                        const key = keyMap[index];
                                        // æ³¨æ„ï¼šé€™è£¡å°‡ avgCost æ›¿æ›ç‚º avgPurchasePrice
                                        const isNumeric = ['currentStock', 'avgPurchasePrice', 'maxPrice', 'minPrice', 'totalCost'].includes(key); 

                                        return (
                                            <th
                                                key={key}
                                                onClick={() => handleSort(key)}
                                                className={`px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer transition duration-150 hover:bg-gray-100 ${isNumeric ? 'text-right' : ''}`}
                                            >
                                                {header}
                                                {getSortIndicator(key)}
                                            </th>
                                        );
                                    })}
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredAndSortedData.length === 0 ? (
                                        <tr>
                                            <td colSpan="6" className="px-6 py-4 text-center text-gray-500">
                                                {overviewData.length === 0 ? 'ç›®å‰æ²’æœ‰ä»»ä½•åº«å­˜é …ç›®ã€‚' : 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é …ç›®ã€‚'}
                                            </td>
                                        </tr>
                                    ) : (
                                        filteredAndSortedData.map((item) => (
                                        <tr key={item.barcode} className={`${item.currentStock === 0 ? 'bg-red-50 text-gray-500' : 'hover:bg-gray-50'}`}>
                                            <td 
                                                className="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 hover:text-blue-800 cursor-pointer underline" 
                                                onClick={() => setSelectedItem(item)} 
                                            >
                                                {item.name}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.barcode}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.category}</td>
                                            <td className={`px-6 py-4 whitespace-nowrap text-sm font-bold text-right ${item.currentStock === 0 ? 'text-red-600' : 'text-green-600'}`}>
                                                {item.currentStock}
                                            </td>
                                            
                                            {/* ğŸ“Œ æ–°å¢ï¼šå¹³å‡è³¼å…¥åƒ¹ */}
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800 text-right">
                                                {formatCurrency(item.avgPurchasePrice, settings.currency)}
                                            </td>
                                            
                                            {/* ğŸ“Œ æ–°å¢ï¼šæœ€é«˜åƒ¹ */}
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right">
                                                {item.maxPrice > 0 ? formatCurrency(item.maxPrice, settings.currency) : '-'}
                                            </td>
                                            
                                            {/* ğŸ“Œ æ–°å¢ï¼šæœ€ä½åƒ¹ */}
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right">
                                                {item.minPrice > 0 ? formatCurrency(item.minPrice, settings.currency) : '-'}
                                            </td>

                                            {/* ç¸½æˆæœ¬ (ä»¥ç¾æ™‚å¹³å‡æˆæœ¬ (avgCost) è¨ˆç®—ç¸½åƒ¹å€¼) */}
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800 text-right">
                                                {formatCurrency(item.avgCost * item.currentStock, settings.currency)}
                                            </td>
                                        </tr>
                                    ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            // ----------------------------------------------------------------------
            // 10. çµ„ä»¶ - æ–°å¢åŠ  (AddItemForm) (ä¿æŒä¸è®Š)
            // ----------------------------------------------------------------------
            const AddItemForm = ({ supabaseClient, userId, categories, defaultCurrency, onSuccess }) => {
                const [name, setName] = useState('');
                const [barcode, setBarcode] = useState('');
                const [category, setCategory] = useState(categories[0] || '');
                const [price, setPrice] = useState(0); 
                const [itemCurrency, setItemCurrency] = useState(defaultCurrency); 
                const [quantity, setQuantity] = useState(1);
                const [message, setMessage] = useState('');
                const [loading, setLoading] = useState(false);
                const [showScanner, setShowScanner] = useState(false);
                
                // ç²å–æœ€æ–°çš„ category åˆ—è¡¨
                useEffect(() => {
                    if (categories.length > 0 && !categories.includes(category)) {
                        setCategory(categories[0]);
                    } else if (categories.length > 0 && category === '') {
                        setCategory(categories[0]);
                    }
                }, [categories, category]);


                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (!name || !barcode || quantity <= 0 || price < 0) {
                        setMessage('è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½ä¸¦ç¢ºä¿æ•¸å€¼æ­£ç¢ºã€‚');
                        return;
                    }

                    setLoading(true);
                    setMessage('');
                    
                    const itemTemplate = {
                        user_id: userId,
                        name: name.trim(),
                        barcode: barcode.trim(),
                        category,
                        price: parseFloat(price), 
                        currency: itemCurrency, 
                        store: '', // æ–°å¢æ™‚å‚™è¨»æ¬„ä½æš«æ™‚ç•™ç©º
                    };

                    try {
                        const itemsToInsert = Array.from({ length: parseInt(quantity, 10) }, () => ({
                            ...itemTemplate
                        }));

                        const { error } = await supabaseClient
                            .from('inventory_items') 
                            .insert(itemsToInsert);

                        if (error) throw error;

                        setMessage(`æˆåŠŸæ–°å¢ ${quantity} ä»¶ã€Œ${name}ã€ï¼`);
                        setName('');
                        setBarcode('');
                        setPrice(0);
                        setItemCurrency(defaultCurrency); 
                        setQuantity(1);
                        setTimeout(() => {
                            setMessage('');
                            onSuccess(); 
                        }, 3000);

                    } catch (err) {
                        console.error("Supabase Insert Error:", err);
                        setMessage('æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™è¨­å®šã€‚');
                    } finally {
                        setLoading(false);
                    }
                };

                return (
                    <div className="p-6 bg-white shadow-xl rounded-2xl">
                        <h2 className="text-2xl font-bold mb-6 text-gray-800">æ–°å¢åº«å­˜é …ç›®</h2>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* æ¢ç¢¼èˆ‡æƒæ */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">æ¢ç¢¼ (Bar Code) <span className="text-red-500">*</span></label>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={barcode}
                                        onChange={(e) => setBarcode(e.target.value)}
                                        className="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="è¼¸å…¥æˆ–æƒææ¢ç¢¼"
                                        required
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setShowScanner(true)}
                                        className="px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow flex items-center gap-2"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                                        æƒæ
                                    </button>
                                </div>
                            </div>
                            
                            {/* åç¨± */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">å“å <span className="text-red-500">*</span></label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="è¼¸å…¥å•†å“åç¨±"
                                    required
                                />
                            </div>

                            {/* é¡åˆ¥ */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">é¡åˆ¥</label>
                                <select
                                    value={category}
                                    onChange={(e) => setCategory(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                >
                                    {categories.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="flex space-x-4">
                                {/* æˆæœ¬ (Price) */}
                                <div className="flex-1">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">å–®ä»¶æˆæœ¬/è³¼å…¥åƒ¹æ ¼ <span className="text-red-500">*</span></label>
                                    <input
                                        type="number"
                                        min="0"
                                        step="0.01"
                                        value={price}
                                        onChange={(e) => setPrice(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    />
                                </div>

                                {/* è²¨å¹£é¸æ“‡ (Select) */}
                                <div className="w-1/4"> 
                                    <label className="block text-sm font-medium text-gray-700 mb-1">è²¨å¹£ <span className="text-red-500">*</span></label>
                                    <select
                                        value={itemCurrency}
                                        onChange={(e) => setItemCurrency(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    >
                                        {COMMON_CURRENCIES.map(code => (
                                            <option key={code} value={code}>{code}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* æ•¸é‡ */}
                                <div className="flex-1">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">æ•¸é‡ <span className="text-red-500">*</span></label>
                                    <input
                                        type="number"
                                        min="1"
                                        value={quantity}
                                        onChange={(e) => setQuantity(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    />
                                </div>
                            </div>

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50"
                            >
                                {loading ? 'æ–°å¢ä¸­...' : 'ç¢ºèªå…¥åº«'}
                            </button>
                        </form>

                        {message && (
                            <div className={`mt-4 p-3 rounded-lg text-sm font-medium text-center ${message.includes('æˆåŠŸ') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                {message}
                            </div>
                        )}

                        {/* æ¢ç¢¼æƒæå™¨ Modal (ä¸è®Š) */}
                        {showScanner && (
                            <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
                                    <div className="bg-gray-900 p-4 flex justify-between items-center">
                                        <h3 className="text-white text-lg font-bold">æƒææ¢ç¢¼</h3>
                                        <button onClick={() => setShowScanner(false)} className="text-white text-3xl leading-none">Ã—</button>
                                    </div>
                                    <BarcodeScanner
                                        onDetected={(code) => {
                                            setBarcode(code);
                                            setShowScanner(false);
                                        }}
                                    />
                                    <div className="p-4 text-center text-sm text-gray-600">
                                        å°‡æ¢ç¢¼å°æº–ç•«é¢ä¸­å¤®æ–¹æ¡†å³å¯è‡ªå‹•è¾¨è­˜
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // ----------------------------------------------------------------------
            // 11. çµ„ä»¶ - è¨­å®šé¢æ¿ (SettingsPanel) (ä¿æŒä¸è®Š)
            // ----------------------------------------------------------------------
            const SettingsPanel = ({ supabaseClient, userId, currentSettings, handleLogout, setActiveTab }) => {
                const [categoriesInput, setCategoriesInput] = useState(
                    Array.isArray(currentSettings.categories) 
                        ? currentSettings.categories.join(', ')
                        : (currentSettings.categories || '').toString()
                );
                const [currency, setCurrency] = useState(currentSettings.currency);
                const [message, setMessage] = useState('');
                const [loading, setLoading] = useState(false);

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    setLoading(true);
                    setMessage('');

                    // è™•ç† Supabase çš„ TEXT[] æ ¼å¼
                    const newCategories = categoriesInput.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    if (newCategories.length === 0) {
                        setMessage('é¡åˆ¥åˆ—è¡¨ä¸èƒ½ç‚ºç©ºã€‚');
                        setLoading(false);
                        return;
                    }

                    const newSettings = {
                        user_id: userId,
                        categories: newCategories,
                        currency: currency,
                    };

                    try {
                        const { error } = await supabaseClient
                            .from('user_settings') 
                            .upsert(newSettings, { onConflict: 'user_id' }); 

                        if (error) throw error;

                        setMessage('è¨­å®šå·²æˆåŠŸå„²å­˜ï¼');
                        setTimeout(() => setMessage(''), 3000);
                    } catch (err) {
                        console.error("Supabase Settings Error:", err);
                        setMessage('å„²å­˜è¨­å®šå¤±æ•—ã€‚');
                    } finally {
                        setLoading(false);
                    }
                };

                return (
                    <div className="p-6 bg-white shadow-xl rounded-2xl space-y-8">
                        <h2 className="text-2xl font-bold text-gray-800 border-b pb-4">æ‡‰ç”¨ç¨‹å¼è¨­å®š</h2>

                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* è²¨å¹£è¨­å®š - ä½¿ç”¨ä¸‹æ‹‰é¸å–® */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    é è¨­è²¨å¹£ä»£ç¢¼ (ç”¨æ–¼æˆæœ¬/ç¸½å€¼)
                                </label>
                                <select
                                    value={currency}
                                    onChange={(e) => setCurrency(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                >
                                    {COMMON_CURRENCIES.map(code => (
                                        <option key={code} value={code}>{code}</option>
                                    ))}
                                </select>
                                <p className="mt-1 text-xs text-gray-500">è«‹é¸æ“‡ä¸‰ä½å­—æ¯ä»£ç¢¼ã€‚</p>
                            </div>

                            {/* é¡åˆ¥è¨­å®š - ä¿æŒ TEXTAREAï¼Œä½†å„ªåŒ–èªªæ˜ */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    åº«å­˜é¡åˆ¥åˆ—è¡¨ (ä»¥é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ï¼šé›»å­ç”¢å“, æœè£)
                                </label>
                                <textarea
                                    rows="3"
                                    value={categoriesInput}
                                    onChange={(e) => setCategoriesInput(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="é›»å­ç”¢å“, æ›¸ç±, å…¶ä»–"
                                    required
                                />
                                <p className="mt-1 text-xs text-gray-500">é€™äº›é¡åˆ¥æœƒé¡¯ç¤ºåœ¨æ–°å¢é …ç›®è¡¨å–®ä¸­ã€‚</p>
                            </div>

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 disabled:opacity-50"
                            >
                                {loading ? 'å„²å­˜ä¸­...' : 'å„²å­˜è¨­å®š'}
                            </button>

                            {message && (
                                <div className={`p-3 text-sm rounded-lg text-center ${message.includes('æˆåŠŸ') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                    {message}
                                </div>
                            )}
                        </form>

                        {/* å¸³æˆ¶æ“ä½œ */}
                        <div className="border-t pt-6 mt-6 space-y-4">
                            <h3 className="text-xl font-semibold text-gray-800">å¸³æˆ¶ç®¡ç†</h3>
                            <p className="text-sm text-gray-600">æ‡‰ç”¨ç¨‹å¼ ID/Supabase URL: <code className="bg-gray-200 p-1 rounded text-xs">...</code></p>
                            <button
                                onClick={handleLogout}
                                className="w-full py-2 px-4 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-300"
                            >
                                ç™»å‡º
                            </button>
                        </div>
                    </div>
                );
            };


            // ----------------------------------------------------------------------
            // 12. çµ„ä»¶ - å‡ºåº«é é¢ (StockOutPage) (ä¿æŒä¸è®Š)
            // ----------------------------------------------------------------------
            const StockOutPage = ({ supabaseClient, userId, inventory, stockOuts, setActiveTab }) => {
                const [barcode, setBarcode] = useState('');
                const [name, setName] = useState('');
                const [quantity, setQuantity] = useState(1);
                const [showScanner, setShowScanner] = useState(false);
                const [message, setMessage] = useState('');
                const [loading, setLoading] = useState(false);

                // å»ºç«‹ã€Œåç¨± â†’ æ¢ç¢¼ã€çš„æ˜ å°„è¡¨ï¼ˆåªåŒ…å«ç›®å‰æœ‰åº«å­˜çš„é …ç›®ï¼‰
                const nameToBarcodeMap = useMemo(() => {
                    const map = {};
                    const grouped = aggregateInventoryData(inventory, stockOuts);
                    grouped.forEach(item => {
                        if (item.currentStock > 0) {
                            if (!map[item.name]) {
                                map[item.name] = item.barcode;
                            } else if (map[item.name] !== item.barcode) {
                                map[item.name] = null; // æ¨™è¨˜ç‚ºä¸å”¯ä¸€
                            }
                        }
                    });
                    return map;
                }, [inventory, stockOuts]);

                // ç•¶ barcode æ”¹è®Š â†’ è‡ªå‹•å¡«åç¨±
                useEffect(() => {
                    if (!barcode) {
                        setName('');
                        return;
                    }
                    const grouped = aggregateInventoryData(inventory, stockOuts);
                    const found = grouped.find(g => g.barcode === barcode);
                    if (found) {
                        setName(found.name);
                    } else {
                        setName('');
                    }
                }, [barcode, inventory, stockOuts]);

                // ç•¶åç¨±æ”¹è®Š â†’ è‡ªå‹•å¡«æ¢ç¢¼ï¼ˆåƒ…åœ¨åç¨±å”¯ä¸€å°æ‡‰æ™‚ï¼‰
                useEffect(() => {
                    if (!name) {
                        setBarcode('');
                        return;
                    }
                    const possibleBarcode = nameToBarcodeMap[name];
                    if (possibleBarcode) {
                        setBarcode(possibleBarcode);
                    }
                }, [name, nameToBarcodeMap]);

                // è¨ˆç®—ç›®å‰åº«å­˜é‡
                const currentStock = useMemo(() => {
                    const grouped = aggregateInventoryData(inventory, stockOuts);
                    const item = grouped.find(g => g.barcode === barcode);
                    return item ? item.currentStock : 0;
                }, [barcode, inventory, stockOuts]);

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (!barcode) {
                        setMessage('è«‹è¼¸å…¥æˆ–æƒææ¢ç¢¼');
                        return;
                    }
                    if (!name) {
                        setMessage('è«‹è¼¸å…¥é …ç›®åç¨±');
                        return;
                    }
                    const qty = parseInt(quantity, 10);
                    if (isNaN(qty) || qty <= 0) {
                        setMessage('è«‹è¼¸å…¥æ­£ç¢ºçš„å‡ºåº«æ•¸é‡');
                        return;
                    }
                    if (qty > currentStock) {
                        setMessage(`å‡ºåº«æ•¸é‡ä¸èƒ½å¤§æ–¼ç›®å‰åº«å­˜ ${currentStock} ä»¶`);
                        return;
                    }
                    setLoading(true);
                    setMessage('');
                    
                    const newStockOut = {
                        user_id: userId,
                        barcode: barcode.trim(),
                        name: name.trim(),
                        quantity: qty,
                        // store: '', // Supabase è¡¨æ ¼ä¸­æ²’æœ‰ store æ¬„ä½ï¼Œå¦‚æœéœ€è¦å‚™è¨»è«‹åœ¨ stock_outs å¢åŠ 
                    };

                    try {
                        const { error } = await supabaseClient
                            .from('stock_outs') 
                            .insert([newStockOut]);

                        if (error) throw error;

                        setMessage(`æˆåŠŸå‡ºåº« ${qty} ä»¶ã€Œ${name}ã€`);
                        setBarcode('');
                        setName('');
                        setQuantity(1);
                        setTimeout(() => {
                            setMessage('');
                            setActiveTab('inventory');
                        }, 4000);
                    } catch (err) {
                        console.error("Supabase Stock Out Error:", err);
                        setMessage('å‡ºåº«å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡');
                    } finally {
                        setLoading(false);
                    }
                };

                return (
                    <div className="p-6 bg-white shadow-xl rounded-2xl">
                        <h2 className="text-2xl font-bold mb-6 text-gray-800">å‡ºåº« / å–è²¨</h2>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* åç¨±è¼¸å…¥æ¡† */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    åç¨± <span className="text-red-500">*</span>
                                </label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="è¼¸å…¥å“åï¼ˆæœƒè‡ªå‹•å¸¶å‡ºæ¢ç¢¼ï¼‰"
                                    required
                                />
                                {name && nameToBarcodeMap[name] === null && (
                                    <p className="text-xs text-orange-600 mt-1">
                                        â€» æ­¤å“åå°æ‡‰å¤šå€‹æ¢ç¢¼ï¼Œè«‹æƒææˆ–æ‰‹å‹•è¼¸å…¥æ­£ç¢ºæ¢ç¢¼
                                    </p>
                                )}
                            </div>

                            {/* æ¢ç¢¼ */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    æ¢ç¢¼ (Bar Code) <span className="text-red-500">*</span>
                                </label>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={barcode}
                                        onChange={(e) => setBarcode(e.target.value)}
                                        className="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="è¼¸å…¥æˆ–æƒææ¢ç¢¼ï¼ˆæœƒè‡ªå‹•å¸¶å‡ºå“åï¼‰"
                                        required
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setShowScanner(true)}
                                        className="px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow flex items-center gap-2"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                                        æƒæ
                                    </button>
                                </div>
                            </div>

                            {/* ç›®å‰åº«å­˜é¡¯ç¤º */}
                            {barcode && (
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <span className="text-sm font-medium text-blue-800">
                                        ç›®å‰åº«å­˜é‡ï¼š{currentStock} ä»¶
                                    </span>
                                </div>
                            )}

                            {/* å‡ºåº«æ•¸é‡ */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    å‡ºåº«æ•¸é‡ <span className="text-red-500">*</span>
                                </label>
                                <input
                                    type="number"
                                    min="1"
                                    max={currentStock || 1}
                                    value={quantity}
                                    onChange={(e) => setQuantity(Math.max(1, parseInt(e.target.value) || 1))}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                />
                            </div>

                            <button
                                type="submit"
                                disabled={loading || currentStock === 0}
                                className="w-full py-3 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 disabled:opacity-50"
                            >
                                {loading ? 'è™•ç†ä¸­...' : 'ç¢ºèªå‡ºåº«'}
                            </button>
                        </form>

                        {message && (
                            <div className={`mt-4 p-3 rounded-lg text-sm font-medium text-center ${
                                message.includes('æˆåŠŸ') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                            }`}>
                                {message}
                            </div>
                        )}

                        {/* æ¢ç¢¼æƒæå™¨ Modal (ä¸è®Š) */}
                        {showScanner && (
                            <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
                                    <div className="bg-gray-900 p-4 flex justify-between items-center">
                                        <h3 className="text-white text-lg font-bold">æƒææ¢ç¢¼</h3>
                                        <button onClick={() => setShowScanner(false)} className="text-white text-3xl leading-none">Ã—</button>
                                    </div>
                                    <BarcodeScanner
                                        onDetected={(code) => {
                                            setBarcode(code);
                                            setShowScanner(false);
                                        }}
                                    />
                                    <div className="p-4 text-center text-sm text-gray-600">
                                        å°‡æ¢ç¢¼å°æº–ç•«é¢ä¸­å¤®æ–¹æ¡†å³å¯è‡ªå‹•è¾¨è­˜
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };


            // ----------------------------------------------------------------------
            // 13. ä¸»æ‡‰ç”¨ç¨‹å¼ä»‹é¢ (Main UI)
            // ----------------------------------------------------------------------
            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header/Navbar */}
                    <nav className="bg-white shadow-md sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex-shrink-0 text-xl font-bold text-gray-900">
                                    ğŸ“¦ åº«å­˜ç®¡ç†
                                </div>
                                <div className="text-sm text-gray-500">
                                    ä½¿ç”¨è€… ID: {userId ? userId.substring(0, 8) + '...' : 'N/A'}
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow">
                        <div className="flex border-b border-gray-200">
                            {/* æ¦‚è¦ */}
                            <button
                                onClick={() => setActiveTab('inventory')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'inventory' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                æ¦‚è¦
                            </button>

                            {/* å‡ºåº« */}
                            <button
                                onClick={() => setActiveTab('stockout')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'stockout' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                å‡ºåº«
                            </button>

                            {/* æ–°å¢åŠ  */}
                            <button
                                onClick={() => setActiveTab('add')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'add' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                æ–°å¢åŠ 
                            </button>

                            {/* è¨­å®š */}
                            <button
                                onClick={() => setActiveTab('settings')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'settings' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                è¨­å®š
                            </button>
                        </div>

                        <div className="mt-6">
                        {activeTab === 'add' && settings && (
                            <AddItemForm 
                                supabaseClient={supabaseClient} 
                                userId={userId} 
                                categories={settings.categories} 
                                defaultCurrency={settings.currency}
                                onSuccess={() => {fetchInitialData(); setActiveTab('inventory');}}  
                            />
                        )}

                        {activeTab === 'inventory' && settings && (
                            <InventoryOverview
                                settings={settings}
                                overviewData={overviewData}
                                setSelectedItem={setSelectedItem} 
                            />
                        )}
                        
                        {activeTab === 'stockout' && settings && (
                            <StockOutPage
                                supabaseClient={supabaseClient}
                                userId={userId}
                                inventory={inventory}
                                stockOuts={stockOuts}
                                setActiveTab={setActiveTab}
                            />
                        )}
                            
                        {activeTab === 'settings' && settings && (
                            <SettingsPanel 
                                supabaseClient={supabaseClient} 
                                userId={userId} 
                                currentSettings={settings} 
                                handleLogout={handleLogout} 
                                setActiveTab={setActiveTab}  
                            />
                        )}
                        </div>

                        {/* æ˜ç´°å½ˆçª—æ¸²æŸ“ */}
                        {currentSelectedItem && settings && (
                            <DetailModal
                                item={currentSelectedItem} // ä½¿ç”¨åŒ¹é…æœ€æ–°çš„èšåˆæ•¸æ“š
                                inventory={inventory}
                                stockOuts={stockOuts}
                                onClose={() => setSelectedItem(null)}
                                settings={settings}
                                userId={userId}
                                refreshData={fetchInitialData} 
                            />
                        )}
                    </main>

                    <footer className="py-4 text-center text-sm text-gray-500">
                        <p>Â© 2024å¹´åº«å­˜ç®¡ç†æ‡‰ç”¨ç¨‹å¼ã€‚æ‰€æœ‰è³‡æ–™å‡ä½¿ç”¨ Supabase PostgREST å³æ™‚åŒæ­¥ã€‚</p>
                    </footer>
                </div>
            );
        };

        // æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼åˆ° DOM
        if (typeof ReactDOM !== 'undefined') {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        } else {
             console.error("ReactDOM not found. Please check script loading.");
        }
    </script>
</body>
</html>
