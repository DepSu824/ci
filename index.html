<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 庫存管理應用程式</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

    <style>
        /* 保持原有的 Quagga 掃描器樣式 */
        #interactive.viewport {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }
        #interactive.viewport canvas, video {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        #interactive.viewport .drawingBuffer {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        .drawingBuffer > canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        .laser-box {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 10px;
            margin-left: -40%;
            margin-top: -5px;
            background: red;
            opacity: 0.5;
            box-shadow: 0 0 10px red;
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            from { opacity: 0.5; }
            to { opacity: 0.8; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const { createClient } = supabase;

        // ----------------------------------------------------------------------
        // 1. 設定 Supabase
        // ----------------------------------------------------------------------
        const SUPABASE_URL = 'https://edtoegcycroomrcebywq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkdG9lZ2N5Y3Jvb21yY2VieXdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMjczMzcsImV4cCI6MjA3OTgwMzMzN30.PFVzPDIhxrxW47lDaUW-3aQtD_QbwJcn2muENJRra_s';
        const COMMON_CURRENCIES = ['USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'HKD', 'TWD', 'CNY', 'VND', 'SGD']; 

        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ----------------------------------------------------------------------
        // 2. 輔助函式
        // ----------------------------------------------------------------------

        // 格式化貨幣
        const formatCurrency = (amount, currencyCode = 'USD') => {
            if (typeof amount !== 'number' || isNaN(amount)) return '';
            try {
                const formatter = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currencyCode,
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2,
                });
                return formatter.format(amount);
            } catch (e) {
                return `${currencyCode} ${amount.toFixed(2)}`;
            }
        };

        // 格式化時間戳
        const formatTimestamp = (timestamp) => {
            if (!timestamp) return '-';
            try {
                return new Date(timestamp).toLocaleString();
            } catch (e) {
                return timestamp; // 返回原始值以防解析錯誤
            }
        };


        // 聚合庫存數據
        const aggregateInventoryData = (inventory = [], stockOuts = []) => {
            const grouped = {};
            const stockOutMap = {};

            // 1. 處理出庫數據
            stockOuts.forEach(out => {
                const key = out.barcode;
                stockOutMap[key] = (stockOutMap[key] || 0) + out.quantity;
            });

            // 2. 處理入庫數據並聚合
            inventory.forEach(item => {
                const key = item.barcode;
                const itemCost = item.price || 0; 
                
                if (!grouped[key]) {
                    grouped[key] = {
                        barcode: item.barcode,
                        name: item.name,
                        category: item.category,
                        totalInStock: 0,
                        totalCost: 0,
                        avgCost: 0,
                        currentStock: 0,
                    };
                }
                grouped[key].totalInStock += 1; 
                grouped[key].totalCost += itemCost;
                grouped[key].category = item.category; // 使用最新的 category
                grouped[key].name = item.name; // 使用最新的 name
            });

            // 3. 計算平均成本和剩餘庫存
            Object.values(grouped).forEach(item => {
                // 修正：計算平均成本不應該只基於 totalInStock（數量永遠為 1），而是基於實際購入的記錄數量
                const uniquePurchaseRecords = inventory.filter(inv => inv.barcode === item.barcode);
                item.totalInStock = uniquePurchaseRecords.length;
                item.totalCost = uniquePurchaseRecords.reduce((sum, rec) => sum + (rec.price || 0), 0);
                
                item.avgCost = item.totalInStock > 0 ? item.totalCost / item.totalInStock : 0;
                
                const totalOut = stockOutMap[item.barcode] || 0;
                item.currentStock = item.totalInStock - totalOut;
            });

            return Object.values(grouped);
        };

        // ----------------------------------------------------------------------
        // 3. Supabase 身份驗證/登入組件 (AuthForm)
        // ----------------------------------------------------------------------
        const AuthForm = ({ supabaseClient }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLogin, setIsLogin] = useState(true);
            const [message, setMessage] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMessage('');

                try {
                    if (isLogin) {
                        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                    } else {
                        const { error } = await supabaseClient.auth.signUp({ email, password });
                        if (error) throw error;
                        setMessage('註冊成功！請檢查您的電子郵件以確認帳戶，然後登入。');
                    }
                } catch (error) {
                    const displayMessage = error.message || '操作失敗，請檢查電子郵件/密碼。';
                    setMessage(displayMessage);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                        <h1 className="text-3xl font-bold text-center mb-6 text-gray-800">
                            {isLogin ? '登入' : '註冊'}
                        </h1>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                    placeholder="your@email.com"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">密碼</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                    placeholder="至少 6 位字元"
                                />
                            </div>
                            {message && (
                                <p className={`p-3 text-sm rounded-lg ${message.includes('成功') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {message}
                                </p>
                            )}
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50"
                            >
                                {loading ? '處理中...' : (isLogin ? '登入' : '註冊')}
                            </button>
                        </form>
                        <div className="mt-6 text-center">
                            <button
                                onClick={() => setIsLogin(!isLogin)}
                                className="text-sm text-blue-600 hover:text-blue-800 transition duration-150"
                            >
                                {isLogin ? '還沒有帳戶？點此註冊' : '已經有帳戶了？點此登入'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 4. BarcodeScanner 組件
        // ----------------------------------------------------------------------
        const BarcodeScanner = ({ onDetected }) => {
            const [error, setError] = useState(null);
            const scannerRef = React.useRef(null);

            useEffect(() => {
                if (!Quagga) return;

                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: scannerRef.current,
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment" 
                        },
                    },
                    decoder: {
                        readers: ["ean_reader", "upc_reader", "code_128_reader", "code_39_reader"]
                    },
                }, (err) => {
                    if (err) {
                        setError(`無法啟動相機: ${err.message}`);
                        return;
                    }
                    Quagga.start();
                });

                Quagga.onDetected((data) => {
                    if (data && data.codeResult && data.codeResult.code) {
                        onDetected(data.codeResult.code);
                        Quagga.stop();
                    }
                });

                return () => {
                    Quagga.stop();
                };
            }, [onDetected]);

            return (
                <div className="relative">
                    {error ? (
                        <div className="p-4 text-center text-red-600 bg-red-50">{error}</div>
                    ) : (
                        <div id="interactive" className="viewport" ref={scannerRef}>
                            <div className="laser-box"></div>
                        </div>
                    )}
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 5. 單筆交易編輯/刪除組件 (TransactionRow)
        // ----------------------------------------------------------------------
        const TransactionRow = ({ record, onUpdated, userId }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editData, setEditData] = useState({
                price: record.price || 0,
                currency: record.currency || 'HKD',
                store: record.store || '', // Supabase 使用 store 欄位
                quantity: Math.abs(record.quantity),
            });
            const [saving, setSaving] = useState(false);
            const [message, setMessage] = useState('');

            const isPurchase = record.type === 'PURCHASE';
            const tableName = isPurchase ? 'inventory_items' : 'stock_outs';

            // 處理儲存單筆紀錄
            const handleSave = async () => {
                if (isPurchase && (editData.price < 0 || !editData.currency)) {
                    setMessage('單價與貨幣為必填');
                    return;
                }
                if (!isPurchase && (editData.quantity <= 0)) {
                    setMessage('出庫數量必須大於 0');
                    return;
                }
                setSaving(true);
                setMessage('');
                try {
                    const updateObj = isPurchase
                        ? {
                            price: parseFloat(editData.price),
                            currency: editData.currency.toUpperCase().trim(),
                            store: editData.store.trim() || null,
                          }
                        : { quantity: parseInt(editData.quantity) };
                    
                    const { error } = await supabaseClient
                        .from(tableName) 
                        .update(updateObj)
                        .eq('id', record.id)
                        .eq('user_id', userId); 

                    if (error) throw error;
                    setMessage('已更新！');
                    setIsEditing(false);
                    onUpdated?.(); // 通知父層刷新數據
                } catch (err) {
                    console.error(err);
                    setMessage('更新失敗');
                } finally {
                    setSaving(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };

            // 處理刪除單筆紀錄
            const handleDelete = async () => {
                if (!window.confirm(`確定要永久刪除這筆${isPurchase ? '購入' : '出庫'}紀錄嗎？`)) return;
                setSaving(true);
                setMessage('');
                try {
                    const { error } = await supabaseClient
                        .from(tableName) 
                        .delete()
                        .eq('id', record.id)
                        .eq('user_id', userId);

                    if (error) throw error;
                    setMessage('已刪除！');
                    onUpdated?.();
                } catch (err) {
                    console.error(err);
                    setMessage('刪除失敗');
                } finally {
                    setSaving(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };

            if (isEditing) {
                return (
                    <tr className="bg-yellow-50">
                        <td className="px-4 py-2"><span className={`px-2 py-1 text-xs rounded-full ${isPurchase ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{isPurchase ? '購入' : '出庫'}</span></td>
                        <td className="px-4 py-2">
                            {isPurchase ? '+1' : (
                                <input type="number" min="1" value={editData.quantity} onChange={e => setEditData({ ...editData, quantity: e.target.value })} className="w-20 px-2 py-1 border rounded" />
                            )}
                        </td>
                        <td className="px-4 py-2">
                            {isPurchase ? (
                                <input type="number" step="0.01" value={editData.price} onChange={e => setEditData({ ...editData, price: e.target.value })} className="w-24 px-2 py-1 border rounded" />
                            ) : '-'}
                        </td>
                        <td className="px-4 py-2">
                            {isPurchase ? (
                                <select value={editData.currency} onChange={e => setEditData({ ...editData, currency: e.target.value })} className="px-2 py-1 border rounded text-sm">
                                    {COMMON_CURRENCIES.map(code => (<option key={code} value={code}>{code}</option>))}
                                </select>
                            ) : '-'}
                        </td>
                        <td className="px-4 py-2">
                            {isPurchase ? (
                                <input type="text" value={editData.store} onChange={e => setEditData({ ...editData, store: e.target.value })} className="w-full px-2 py-1 border rounded" placeholder="店名或其他備註" />
                            ) : record.store}
                        </td>
                        <td className="px-4 py-2 text-xs text-gray-500">{formatTimestamp(record.created_at)}</td>
                        <td className="px-4 py-2 text-xs">
                            <div className="flex items-center gap-2">
                                <button onClick={handleSave} disabled={saving} className="text-green-600 font-bold hover:text-green-800">儲存</button>
                                <button onClick={() => setIsEditing(false)} className="text-gray-500 hover:text-gray-700">取消</button>
                            </div>
                            {message && <span className="block text-xs mt-1 text-green-600">{message}</span>}
                        </td>
                    </tr>
                );
            }

            // 一般顯示模式
            return (
                <tr className="hover:bg-gray-50">
                    <td className="px-4 py-2">
                        <span className={`px-2 py-1 text-xs rounded-full ${isPurchase ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                            {isPurchase ? '購入' : '出庫'}
                        </span>
                    </td>
                    <td className={`px-4 py-2 font-semibold ${record.type === 'PURCHASE' ? 'text-green-700' : 'text-red-700'}`}>
                        {record.type === 'PURCHASE' ? '+1' : `-${record.quantity}`}
                    </td>
                    <td className="px-4 py-2">
                        {record.type === 'PURCHASE' ? (
                            record.price > 0 ? (
                                <span className="font-medium text-green-700">
                                    {formatCurrency(record.price, record.currency)}
                                </span>
                            ) : (
                                <span className="text-purple-600 font-medium">贈品</span>
                            )
                        ) : (
                            <span className="text-gray-400">-</span>
                        )}
                    </td>
                    <td className="px-4 py-2">{record.currency || '-'}</td>
                    <td className="px-4 py-2">{record.store || '-'}</td>
                    <td className="px-4 py-2 text-xs text-gray-500">{formatTimestamp(record.created_at)}</td>
                    <td className="px-4 py-2 text-xs">
                        <div className="flex items-center gap-3">
                            <button
                                onClick={() => setIsEditing(true)}
                                className="text-blue-600 hover:text-blue-800 font-medium"
                            >
                                編輯
                            </button>
                            <button
                                onClick={handleDelete}
                                className="text-red-600 hover:text-red-800 font-medium"
                            >
                                刪除
                            </button>
                        </div>
                    </td>
                </tr>
            );
        };

        // ----------------------------------------------------------------------
        // 6. 詳細明細彈窗 (DetailModal) - 包含所有編輯功能
        // ----------------------------------------------------------------------
        const DetailModal = ({ item, inventory, stockOuts, onClose, settings, userId, refreshData }) => {
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            // 編輯狀態
            const [isEditingName, setIsEditingName] = useState(false);
            const [isEditingBarcode, setIsEditingBarcode] = useState(false);
            const [isEditingCategory, setIsEditingCategory] = useState(false);
            const [editName, setEditName] = useState(item.name);
            const [editBarcode, setEditBarcode] = useState(item.barcode);
            const [editCategory, setEditCategory] = useState(item.category);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            
            // 處理交易記錄
            const transactionHistory = useMemo(() => {
                const purchases = inventory
                    .filter(rec => rec.barcode === item.barcode)
                    .map(rec => ({
                        id: rec.id, type: 'PURCHASE', quantity: 1, price: rec.price, currency: rec.currency, store: rec.store, created_at: rec.created_at,
                    }));
                const stockOutsForBarcode = stockOuts
                    .filter(out => out.barcode === item.barcode)
                    .map(out => ({
                        id: out.id, type: 'STOCK_OUT', quantity: out.quantity, price: 0, currency: settings.currency, store: out.store, created_at: out.created_at,
                    }));
                
                // 合併並按時間降序排列 (Supabase 使用 created_at)
                return [...purchases, ...stockOutsForBarcode].sort((a, b) => {
                    return new Date(b.created_at) - new Date(a.created_at);
                });
            }, [inventory, stockOuts, item.barcode, settings.currency]);


            // ── 1. 修改名稱 ─────────────────────────────────────
            const handleUpdateName = async () => {
                if (editName.trim() === '' || editName === item.name) {
                    setIsEditingName(false);
                    return;
                }
                setLoading(true);
                setMessage('');
                try {
                    // Supabase 批次更新: 使用 UPDATE FROM 來更新所有匹配的記錄 (由於 Supabase 不支援真正的批次操作，我們用一個 UPDATE 搭配 EQ 即可)
                    const { error: invError } = await supabaseClient
                        .from('inventory_items')
                        .update({ name: editName.trim() })
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);
                    
                    if (invError) throw invError;
                    
                    // 同步更新 stock_outs 的名稱 (可選, 保持數據一致性)
                    await supabaseClient
                        .from('stock_outs')
                        .update({ name: editName.trim() })
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);

                    setMessage('項目名稱已更新！');
                    setIsEditingName(false);
                    refreshData?.(); // 通知父層重新整理
                } catch (err) {
                    console.error(err);
                    setMessage('更新名稱失敗');
                } finally {
                    setLoading(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };

            // ── 2. 修改條碼（全部相關記錄一起改） ───────────────────────
            const handleUpdateBarcode = async () => {
                const newBarcode = editBarcode.trim();
                if (newBarcode === '' || newBarcode === item.barcode) {
                    setIsEditingBarcode(false);
                    return;
                }
                setLoading(true);
                setMessage('');
                try {
                    // 1. 更新所有 inventory_items
                    const { error: invError } = await supabaseClient
                        .from('inventory_items')
                        .update({ barcode: newBarcode })
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);
                    if (invError) throw invError;

                    // 2. 更新所有 stock_outs
                    const { error: outError } = await supabaseClient
                        .from('stock_outs')
                        .update({ barcode: newBarcode })
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);
                    if (outError) throw outError;

                    setMessage(`條碼已變更為 ${newBarcode}！`);
                    setIsEditingBarcode(false);
                    refreshData?.();
                    // 由於條碼變更，需要關閉 modal 並刷新整個 overview 頁面，才能看到新的聚合數據
                    onClose(); 
                } catch (err) {
                    console.error(err);
                    setMessage('變更條碼失敗');
                } finally {
                    setLoading(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };
            
            // ── 3. 修改分類（全部相關記錄一起改） ───────────────────────
            const handleUpdateCategory = async () => {
                if (editCategory === item.category) {
                    setIsEditingCategory(false);
                    return;
                }
                setLoading(true);
                setMessage('');
                try {
                    // 由於 category 只存在於 inventory_items 中，只需更新該表
                    const { error } = await supabaseClient
                        .from('inventory_items')
                        .update({ category: editCategory })
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);

                    if (error) throw error;
                    
                    setMessage('分類已更新！');
                    setIsEditingCategory(false);
                    refreshData?.();
                } catch (err) {
                    console.error(err);
                    setMessage('更新分類失敗');
                } finally {
                    setLoading(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };


            // ── 4. 刪除整個條碼項目 ───────────────────────
            const handleDeleteAll = async () => {
                if (!window.confirm('⚠️ 確定要「永久刪除」這個條碼的所有購入與出庫紀錄嗎？\n此動作無法復原！')) return;

                setLoading(true);
                setMessage('');

                try {
                    // 1. 刪除所有 inventory_items
                    const { error: invError } = await supabaseClient
                        .from('inventory_items')
                        .delete()
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);
                    if (invError) throw invError;

                    // 2. 刪除所有 stock_outs
                    const { error: outError } = await supabaseClient
                        .from('stock_outs')
                        .delete()
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);
                    if (outError) throw outError;

                    setMessage('已永久刪除此條碼的所有紀錄！');
                    onClose(); // 關閉 modal
                    refreshData?.(); // 刷新主列表
                } catch (err) {
                    console.error("刪除失敗:", err);
                    setMessage('刪除失敗：' + err.message);
                } finally {
                    setLoading(false);
                    setShowDeleteConfirm(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };


            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            
                            {/* 頂部標題與控制項 */}
                            <div className="flex justify-between items-start border-b pb-4 mb-4">
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-800">
                                        項目明細：
                                        {isEditingName ? (
                                            <input 
                                                value={editName} 
                                                onChange={(e) => setEditName(e.target.value)}
                                                onBlur={handleUpdateName}
                                                onKeyDown={(e) => {if (e.key === 'Enter') handleUpdateName()}}
                                                className="border-b border-blue-500 p-1 text-xl font-bold inline-block w-60"
                                                autoFocus
                                            />
                                        ) : (
                                            <span 
                                                className="cursor-pointer hover:bg-yellow-100 p-1 rounded transition"
                                                onClick={() => {setEditName(item.name); setIsEditingName(true);}}
                                            >
                                                {item.name}
                                            </span>
                                        )}
                                    </h2>
                                    <p className="text-sm text-gray-600 mt-1">
                                        條碼: 
                                        {isEditingBarcode ? (
                                            <input 
                                                value={editBarcode} 
                                                onChange={(e) => setEditBarcode(e.target.value)}
                                                onBlur={handleUpdateBarcode}
                                                onKeyDown={(e) => {if (e.key === 'Enter') handleUpdateBarcode()}}
                                                className="border-b border-blue-500 p-1 text-sm inline-block w-40"
                                                autoFocus
                                            />
                                        ) : (
                                            <span 
                                                className="cursor-pointer hover:bg-yellow-100 p-1 rounded transition"
                                                onClick={() => {setEditBarcode(item.barcode); setIsEditingBarcode(true);}}
                                            >
                                                {item.barcode}
                                            </span>
                                        )}
                                    </p>
                                </div>
                                <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-3xl leading-none">×</button>
                            </div>

                            {message && (
                                <p className={`mb-4 p-3 text-sm rounded-lg ${message.includes('成功') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {message}
                                </p>
                            )}
                            
                            {/* 總覽資訊區塊 */}
                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 text-center">
                                <div className="p-4 bg-blue-50 rounded-lg">
                                    <p className="text-xs text-gray-600">現有庫存</p>
                                    <p className="text-2xl font-bold text-blue-800">{item.currentStock}</p>
                                </div>
                                <div className="p-4 bg-green-50 rounded-lg">
                                    <p className="text-xs text-gray-600">平均成本</p>
                                    <p className="text-xl font-bold text-green-800">{formatCurrency(item.avgCost, settings.currency)}</p>
                                </div>
                                <div className="p-4 bg-gray-50 rounded-lg flex flex-col justify-center">
                                    <p className="text-xs text-gray-600">分類</p>
                                    {isEditingCategory ? (
                                        <select
                                            value={editCategory}
                                            onChange={(e) => setEditCategory(e.target.value)}
                                            onBlur={handleUpdateCategory}
                                            className="mt-1 p-1 border border-blue-500 rounded text-center text-md font-bold"
                                            autoFocus
                                        >
                                            {settings.categories.map(cat => (
                                                <option key={cat} value={cat}>{cat}</option>
                                            ))}
                                        </select>
                                    ) : (
                                        <p 
                                            className="text-xl font-bold text-gray-800 cursor-pointer hover:bg-yellow-100 p-1 rounded transition"
                                            onClick={() => {setEditCategory(item.category); setIsEditingCategory(true);}}
                                        >
                                            {item.category}
                                        </p>
                                    )}
                                </div>
                            </div>

                            <h3 className="text-xl font-semibold mb-3 border-b pb-2 text-gray-700">交易歷史記錄</h3>
                            
                            {/* 交易明細表格 */}
                            <div className="overflow-x-auto border rounded-lg">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">類型</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">數量</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">單價/成本</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">貨幣</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">備註/店名</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">時間</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {transactionHistory.length === 0 ? (
                                            <tr><td colSpan="7" className="px-6 py-4 text-center text-gray-500">無詳細交易記錄。</td></tr>
                                        ) : (
                                            transactionHistory.map((record) => (
                                                <TransactionRow 
                                                    key={record.id} 
                                                    record={record} 
                                                    onUpdated={refreshData} // 每次更新後重新載入數據
                                                    userId={userId}
                                                />
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* 底部操作按鈕 */}
                        <div className="p-4 bg-gray-50 border-t flex justify-between items-center">
                            <button
                                onClick={handleDeleteAll}
                                disabled={loading}
                                className="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-300 disabled:opacity-50 text-sm"
                            >
                                永久刪除此條碼所有紀錄
                            </button>
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-300"
                            >
                                關閉
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 7. 應用程式主體：App 組件
        // ----------------------------------------------------------------------
        const App = () => {
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('inventory'); 

            // Data States
            const [inventory, setInventory] = useState([]); 
            const [stockOuts, setStockOuts] = useState([]);
            const [settings, setSettings] = useState(null); 
            const [selectedItem, setSelectedItem] = useState(null); // ✅ 用於明細彈窗

            // Derived State
            const userId = session?.user?.id || null;
            
            // 處理資料獲取和訂閱的函式
            const fetchInitialData = useCallback(async () => {
                if (!userId) return;

                // Fetch Inventory Items (inventory_items table)
                const { data: invData, error: invError } = await supabaseClient
                    .from('inventory_items') 
                    .select('*')
                    .eq('user_id', userId);
                if (invError) console.error("Error fetching inventory:", invError);
                else setInventory(invData);

                // Fetch Stock Outs (stock_outs table)
                const { data: outData, error: outError } = await supabaseClient
                    .from('stock_outs') 
                    .select('*')
                    .eq('user_id', userId);
                if (outError) console.error("Error fetching stock outs:", outError);
                else setStockOuts(outData);

                // Fetch Settings (user_settings table)
                const { data: settingsData, error: settingsError } = await supabaseClient
                    .from('user_settings') 
                    .select('*')
                    .eq('user_id', userId)
                    .maybeSingle(); 
                    
                if (settingsError && settingsError.code !== 'PGRST116') { 
                        console.error("Error fetching settings:", settingsError);
                } else if (settingsData) {
                    // 將 category 欄位（可能為字串或 JSON 陣列）轉換為陣列
                    let categoriesArray = settingsData.categories;
                    if (typeof categoriesArray === 'string') {
                        categoriesArray = categoriesArray.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    }
                    setSettings({ ...settingsData, categories: categoriesArray || [] });

                } else {
                     // Default settings for new user
                     setSettings({ categories: ['電子產品', '服裝', '食品', '書籍', '其他'], currency: 'HKD', user_id: userId });
                }
            }, [userId]);


            // 1. Supabase 身份驗證監聽
            useEffect(() => {
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    setLoading(false);
                });

                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(
                    (_event, session) => {
                        setSession(session);
                        setLoading(false);
                    }
                );

                return () => subscription.unsubscribe();
            }, []);


            // 2. Supabase 即時數據訂閱/初始載入
            useEffect(() => {
                if (!userId) return;

                fetchInitialData();

                // Setup Realtime Subscriptions
                // 這裡的訂閱僅用於觸發重新獲取資料，以確保編輯操作後的數據刷新
                const inventorySubscription = supabaseClient
                    .channel('inventory_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'inventory_items', filter: `user_id=eq.${userId}` }, 
                        (payload) => {
                             fetchInitialData(); 
                        }
                    )
                    .subscribe();

                const stockOutsSubscription = supabaseClient
                    .channel('stock_outs_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'stock_outs', filter: `user_id=eq.${userId}` }, 
                        (payload) => {
                             fetchInitialData(); 
                        }
                    )
                    .subscribe();

                const settingsSubscription = supabaseClient
                    .channel('settings_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'user_settings', filter: `user_id=eq.${userId}` }, 
                        (payload) => {
                             fetchInitialData(); 
                        }
                    )
                    .subscribe();

                return () => {
                    supabaseClient.removeChannel(inventorySubscription);
                    supabaseClient.removeChannel(stockOutsSubscription);
                    supabaseClient.removeChannel(settingsSubscription);
                };
            }, [userId, fetchInitialData]); // 依賴 fetchInitialData

            const handleLogout = async () => {
                await supabaseClient.auth.signOut();
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
                    </div>
                );
            }

            if (!session) {
                return <AuthForm supabaseClient={supabaseClient} />;
            }

            // ----------------------------------------------------------------------
            // 8. 組件 - 庫存概覽 (InventoryOverview) 
            // ----------------------------------------------------------------------
            const InventoryOverview = ({ settings, inventory, stockOuts, setSelectedItem }) => {
                const [filterText, setFilterText] = useState('');
                const [filterCategory, setFilterCategory] = useState('All'); 
                const [sortKey, setSortKey] = useState('currentStock');
                const [sortDirection, setSortDirection] = useState('desc');

                const categories = Array.isArray(settings.categories) ? settings.categories : (settings.categories || '').split(',').map(s => s.trim());
                
                const overviewData = useMemo(() => aggregateInventoryData(inventory, stockOuts), [inventory, stockOuts]);

                const filteredAndSortedData = useMemo(() => {
                    let data = overviewData.filter(item => {
                        const textMatch = item.name.toLowerCase().includes(filterText.toLowerCase()) ||
                                          item.barcode.includes(filterText);
                        
                        const categoryMatch = filterCategory === 'All' || item.category === filterCategory;

                        return textMatch && categoryMatch;
                    });

                    data.sort((a, b) => {
                        const valA = a[sortKey];
                        const valB = b[sortKey];
                        let comparison = 0;

                        if (typeof valA === 'string') {
                            comparison = valA.localeCompare(valB);
                        } else {
                            comparison = valA - valB;
                        }

                        return sortDirection === 'asc' ? comparison : comparison * -1;
                    });
                    return data;
                }, [overviewData, filterText, sortKey, sortDirection, filterCategory]);

                const handleSort = (key) => {
                    if (sortKey === key) {
                        setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                    } else {
                        setSortKey(key);
                        setSortDirection('asc');
                    }
                };

                const totalValue = filteredAndSortedData.reduce((sum, item) => sum + (item.currentStock * item.avgCost), 0);

                const getSortIndicator = (key) => {
                    if (sortKey === key) {
                        return sortDirection === 'asc' ? ' ▲' : ' ▼';
                    }
                    return '';
                };

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-md">
                            <h3 className="text-xl font-semibold text-gray-800">
                                總庫存價值: <span className="text-blue-600">{formatCurrency(totalValue, settings.currency)}</span>
                            </h3>
                            <div className="flex gap-4">
                                {/* 分類篩選器 (Select) */}
                                <select
                                    value={filterCategory}
                                    onChange={(e) => setFilterCategory(e.target.value)}
                                    className="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                >
                                    <option value="All">所有分類</option>
                                    {categories.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                                <input
                                    type="text"
                                    placeholder="🔍 搜尋品名或條碼..."
                                    value={filterText}
                                    onChange={(e) => setFilterText(e.target.value)}
                                    className="p-2 border border-gray-300 rounded-lg w-64 focus:ring-blue-500 focus:border-blue-500"
                                />
                            </div>
                        </div>

                        <div className="overflow-x-auto bg-white rounded-xl shadow-md">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        {['名稱', '條碼', '類別', '現有庫存', '平均成本', '總成本'].map((header, index) => {
                                            const keyMap = ['name', 'barcode', 'category', 'currentStock', 'avgCost', 'totalCost'];
                                            const key = keyMap[index];
                                            const isNumeric = ['currentStock', 'avgCost', 'totalCost'].includes(key);

                                            return (
                                                <th
                                                    key={key}
                                                    onClick={() => handleSort(key)}
                                                    className={`px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer transition duration-150 hover:bg-gray-100 ${isNumeric ? 'text-right' : ''}`}
                                                >
                                                    {header}
                                                    {getSortIndicator(key)}
                                                </th>
                                            );
                                        })}
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredAndSortedData.length === 0 ? (
                                        <tr>
                                            <td colSpan="6" className="px-6 py-4 text-center text-gray-500">
                                                {overviewData.length === 0 ? '目前沒有任何庫存項目。' : '找不到符合條件的項目。'}
                                            </td>
                                        </tr>
                                    ) : (
                                        filteredAndSortedData.map((item) => (
                                            <tr key={item.barcode} className={`${item.currentStock === 0 ? 'bg-red-50 text-gray-500' : 'hover:bg-gray-50'}`}>
                                                <td 
                                                    className="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 hover:text-blue-800 cursor-pointer underline" 
                                                    onClick={() => setSelectedItem(item)} 
                                                >
                                                    {item.name}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.barcode}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.category}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm font-bold text-right ${item.currentStock === 0 ? 'text-red-600' : 'text-green-600'}`}>
                                                    {item.currentStock}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">
                                                    {formatCurrency(item.avgCost, settings.currency)}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">
                                                    {formatCurrency(item.avgCost * item.currentStock, settings.currency)}
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            // ----------------------------------------------------------------------
            // 9. 組件 - 新增加 (AddItemForm) 
            // ----------------------------------------------------------------------
            const AddItemForm = ({ supabaseClient, userId, categories, defaultCurrency, onSuccess }) => {
                const [name, setName] = useState('');
                const [barcode, setBarcode] = useState('');
                const [category, setCategory] = useState(categories[0] || '');
                const [price, setPrice] = useState(0); 
                const [itemCurrency, setItemCurrency] = useState(defaultCurrency); 
                const [quantity, setQuantity] = useState(1);
                const [message, setMessage] = useState('');
                const [loading, setLoading] = useState(false);
                const [showScanner, setShowScanner] = useState(false);
                
                // 獲取最新的 category 列表
                useEffect(() => {
                    if (categories.length > 0 && !categories.includes(category)) {
                        setCategory(categories[0]);
                    } else if (categories.length > 0 && category === '') {
                        setCategory(categories[0]);
                    }
                }, [categories, category]);


                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (!name || !barcode || quantity <= 0 || price < 0) {
                        setMessage('請完整填寫所有欄位並確保數值正確。');
                        return;
                    }

                    setLoading(true);
                    setMessage('');
                    
                    const itemTemplate = {
                        user_id: userId,
                        name: name.trim(),
                        barcode: barcode.trim(),
                        category,
                        price: parseFloat(price), 
                        currency: itemCurrency, 
                        store: '', // 新增時備註欄位暫時留空
                    };

                    try {
                        const itemsToInsert = Array.from({ length: parseInt(quantity, 10) }, () => ({
                            ...itemTemplate
                        }));

                        const { error } = await supabaseClient
                            .from('inventory_items') 
                            .insert(itemsToInsert);

                        if (error) throw error;

                        setMessage(`成功新增 ${quantity} 件「${name}」！`);
                        setName('');
                        setBarcode('');
                        setPrice(0);
                        setItemCurrency(defaultCurrency); 
                        setQuantity(1);
                        setTimeout(() => {
                            setMessage('');
                            onSuccess(); 
                        }, 3000);

                    } catch (err) {
                        console.error("Supabase Insert Error:", err);
                        setMessage('新增失敗，請檢查網路或權限設定。');
                    } finally {
                        setLoading(false);
                    }
                };

                return (
                    <div className="p-6 bg-white shadow-xl rounded-2xl">
                        <h2 className="text-2xl font-bold mb-6 text-gray-800">新增庫存項目</h2>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* 條碼與掃描 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">條碼 (Bar Code) <span className="text-red-500">*</span></label>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={barcode}
                                        onChange={(e) => setBarcode(e.target.value)}
                                        className="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="輸入或掃描條碼"
                                        required
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setShowScanner(true)}
                                        className="px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow flex items-center gap-2"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                                        掃描
                                    </button>
                                </div>
                            </div>
                            
                            {/* 名稱 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">品名 <span className="text-red-500">*</span></label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="輸入商品名稱"
                                    required
                                />
                            </div>

                            {/* 類別 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">類別</label>
                                <select
                                    value={category}
                                    onChange={(e) => setCategory(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                >
                                    {categories.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="flex space-x-4">
                                {/* 成本 (Price) */}
                                <div className="flex-1">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">單件成本/購入價格 <span className="text-red-500">*</span></label>
                                    <input
                                        type="number"
                                        min="0"
                                        step="0.01"
                                        value={price}
                                        onChange={(e) => setPrice(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    />
                                </div>

                                {/* 貨幣選擇 (Select) */}
                                <div className="w-1/4"> 
                                    <label className="block text-sm font-medium text-gray-700 mb-1">貨幣 <span className="text-red-500">*</span></label>
                                    <select
                                        value={itemCurrency}
                                        onChange={(e) => setItemCurrency(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    >
                                        {COMMON_CURRENCIES.map(code => (
                                            <option key={code} value={code}>{code}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* 數量 */}
                                <div className="flex-1">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">數量 <span className="text-red-500">*</span></label>
                                    <input
                                        type="number"
                                        min="1"
                                        value={quantity}
                                        onChange={(e) => setQuantity(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    />
                                </div>
                            </div>

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50"
                            >
                                {loading ? '新增中...' : '確認入庫'}
                            </button>
                        </form>

                        {message && (
                            <div className={`mt-4 p-3 rounded-lg text-sm font-medium text-center ${message.includes('成功') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                {message}
                            </div>
                        )}

                        {/* 條碼掃描器 Modal (不變) */}
                        {showScanner && (
                            <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
                                    <div className="bg-gray-900 p-4 flex justify-between items-center">
                                        <h3 className="text-white text-lg font-bold">掃描條碼</h3>
                                        <button onClick={() => setShowScanner(false)} className="text-white text-3xl leading-none">×</button>
                                    </div>
                                    <BarcodeScanner
                                        onDetected={(code) => {
                                            setBarcode(code);
                                            setShowScanner(false);
                                        }}
                                    />
                                    <div className="p-4 text-center text-sm text-gray-600">
                                        將條碼對準畫面中央方框即可自動辨識
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // ----------------------------------------------------------------------
            // 10. 組件 - 設定面板 (SettingsPanel) 
            // ----------------------------------------------------------------------
            const SettingsPanel = ({ supabaseClient, userId, currentSettings, handleLogout, setActiveTab }) => {
                const [categoriesInput, setCategoriesInput] = useState(
                    Array.isArray(currentSettings.categories) 
                        ? currentSettings.categories.join(', ')
                        : (currentSettings.categories || '').toString()
                );
                const [currency, setCurrency] = useState(currentSettings.currency);
                const [message, setMessage] = useState('');
                const [loading, setLoading] = useState(false);

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    setLoading(true);
                    setMessage('');

                    // 處理 Supabase 的 TEXT[] 格式
                    const newCategories = categoriesInput.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    if (newCategories.length === 0) {
                        setMessage('類別列表不能為空。');
                        setLoading(false);
                        return;
                    }

                    const newSettings = {
                        user_id: userId,
                        categories: newCategories,
                        currency: currency,
                    };

                    try {
                        const { error } = await supabaseClient
                            .from('user_settings') 
                            .upsert(newSettings, { onConflict: 'user_id' }); 

                        if (error) throw error;

                        setMessage('設定已成功儲存！');
                        setTimeout(() => setMessage(''), 3000);
                    } catch (err) {
                        console.error("Supabase Settings Error:", err);
                        setMessage('儲存設定失敗。');
                    } finally {
                        setLoading(false);
                    }
                };

                return (
                    <div className="p-6 bg-white shadow-xl rounded-2xl space-y-8">
                        <h2 className="text-2xl font-bold text-gray-800 border-b pb-4">應用程式設定</h2>

                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* 貨幣設定 - 使用下拉選單 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    預設貨幣代碼 (用於成本/總值)
                                </label>
                                <select
                                    value={currency}
                                    onChange={(e) => setCurrency(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                >
                                    {COMMON_CURRENCIES.map(code => (
                                        <option key={code} value={code}>{code}</option>
                                    ))}
                                </select>
                                <p className="mt-1 text-xs text-gray-500">請選擇三位字母代碼。</p>
                            </div>

                            {/* 類別設定 - 保持 TEXTAREA，但優化說明 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    庫存類別列表 (以逗號分隔，例如：電子產品, 服裝)
                                </label>
                                <textarea
                                    rows="3"
                                    value={categoriesInput}
                                    onChange={(e) => setCategoriesInput(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="電子產品, 書籍, 其他"
                                    required
                                />
                                <p className="mt-1 text-xs text-gray-500">這些類別會顯示在新增項目表單中。</p>
                            </div>

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 disabled:opacity-50"
                            >
                                {loading ? '儲存中...' : '儲存設定'}
                            </button>

                            {message && (
                                <div className={`p-3 text-sm rounded-lg text-center ${message.includes('成功') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                    {message}
                                </div>
                            )}
                        </form>

                        {/* 帳戶操作 */}
                        <div className="border-t pt-6 mt-6 space-y-4">
                            <h3 className="text-xl font-semibold text-gray-800">帳戶管理</h3>
                            <p className="text-sm text-gray-600">應用程式 ID/Supabase URL: <code className="bg-gray-200 p-1 rounded text-xs">...</code></p>
                            <button
                                onClick={handleLogout}
                                className="w-full py-2 px-4 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-300"
                            >
                                登出
                            </button>
                        </div>
                    </div>
                );
            };


            // ----------------------------------------------------------------------
            // 11. 組件 - 出庫頁面 (StockOutPage) 
            // ----------------------------------------------------------------------
            const StockOutPage = ({ supabaseClient, userId, inventory, stockOuts, setActiveTab }) => {
                const [barcode, setBarcode] = useState('');
                const [name, setName] = useState('');
                const [quantity, setQuantity] = useState(1);
                const [showScanner, setShowScanner] = useState(false);
                const [message, setMessage] = useState('');
                const [loading, setLoading] = useState(false);

                // 建立「名稱 → 條碼」的映射表（只包含目前有庫存的項目）
                const nameToBarcodeMap = useMemo(() => {
                    const map = {};
                    const grouped = aggregateInventoryData(inventory, stockOuts);
                    grouped.forEach(item => {
                        if (item.currentStock > 0) {
                            if (!map[item.name]) {
                                map[item.name] = item.barcode;
                            } else if (map[item.name] !== item.barcode) {
                                map[item.name] = null; // 標記為不唯一
                            }
                        }
                    });
                    return map;
                }, [inventory, stockOuts]);

                // 當 barcode 改變 → 自動填名稱
                useEffect(() => {
                    if (!barcode) {
                        setName('');
                        return;
                    }
                    const grouped = aggregateInventoryData(inventory, stockOuts);
                    const found = grouped.find(g => g.barcode === barcode);
                    if (found) {
                        setName(found.name);
                    } else {
                        setName('');
                    }
                }, [barcode, inventory, stockOuts]);

                // 當名稱改變 → 自動填條碼（僅在名稱唯一對應時）
                useEffect(() => {
                    if (!name) {
                        setBarcode('');
                        return;
                    }
                    const possibleBarcode = nameToBarcodeMap[name];
                    if (possibleBarcode) {
                        setBarcode(possibleBarcode);
                    }
                }, [name, nameToBarcodeMap]);

                // 計算目前庫存量
                const currentStock = useMemo(() => {
                    const grouped = aggregateInventoryData(inventory, stockOuts);
                    const item = grouped.find(g => g.barcode === barcode);
                    return item ? item.currentStock : 0;
                }, [barcode, inventory, stockOuts]);

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (!barcode) {
                        setMessage('請輸入或掃描條碼');
                        return;
                    }
                    if (!name) {
                        setMessage('請輸入項目名稱');
                        return;
                    }
                    const qty = parseInt(quantity, 10);
                    if (isNaN(qty) || qty <= 0) {
                        setMessage('請輸入正確的出庫數量');
                        return;
                    }
                    if (qty > currentStock) {
                        setMessage(`出庫數量不能大於目前庫存 ${currentStock} 件`);
                        return;
                    }
                    setLoading(true);
                    setMessage('');
                    
                    const newStockOut = {
                        user_id: userId,
                        barcode: barcode.trim(),
                        name: name.trim(),
                        quantity: qty,
                        // store: '', // Supabase 表格中沒有 store 欄位，如果需要備註請在 stock_outs 增加
                    };

                    try {
                        const { error } = await supabaseClient
                            .from('stock_outs') 
                            .insert([newStockOut]);

                        if (error) throw error;

                        setMessage(`成功出庫 ${qty} 件「${name}」`);
                        setBarcode('');
                        setName('');
                        setQuantity(1);
                        setTimeout(() => {
                            setMessage('');
                            setActiveTab('inventory');
                        }, 4000);
                    } catch (err) {
                        console.error("Supabase Stock Out Error:", err);
                        setMessage('出庫失敗，請再試一次');
                    } finally {
                        setLoading(false);
                    }
                };

                return (
                    <div className="p-6 bg-white shadow-xl rounded-2xl">
                        <h2 className="text-2xl font-bold mb-6 text-gray-800">出庫 / 取貨</h2>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* 名稱輸入框 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    名稱 <span className="text-red-500">*</span>
                                </label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="輸入品名（會自動帶出條碼）"
                                    required
                                />
                                {name && nameToBarcodeMap[name] === null && (
                                    <p className="text-xs text-orange-600 mt-1">
                                        ※ 此品名對應多個條碼，請掃描或手動輸入正確條碼
                                    </p>
                                )}
                            </div>

                            {/* 條碼 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    條碼 (Bar Code) <span className="text-red-500">*</span>
                                </label>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={barcode}
                                        onChange={(e) => setBarcode(e.target.value)}
                                        className="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="輸入或掃描條碼（會自動帶出品名）"
                                        required
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setShowScanner(true)}
                                        className="px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow flex items-center gap-2"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                                        掃描
                                    </button>
                                </div>
                            </div>

                            {/* 目前庫存顯示 */}
                            {barcode && (
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <span className="text-sm font-medium text-blue-800">
                                        目前庫存量：{currentStock} 件
                                    </span>
                                </div>
                            )}

                            {/* 出庫數量 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    出庫數量 <span className="text-red-500">*</span>
                                </label>
                                <input
                                    type="number"
                                    min="1"
                                    max={currentStock || 1}
                                    value={quantity}
                                    onChange={(e) => setQuantity(Math.max(1, parseInt(e.target.value) || 1))}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                />
                            </div>

                            <button
                                type="submit"
                                disabled={loading || currentStock === 0}
                                className="w-full py-3 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 disabled:opacity-50"
                            >
                                {loading ? '處理中...' : '確認出庫'}
                            </button>
                        </form>

                        {message && (
                            <div className={`mt-4 p-3 rounded-lg text-sm font-medium text-center ${
                                message.includes('成功') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                            }`}>
                                {message}
                            </div>
                        )}

                        {/* 條碼掃描器 Modal (不變) */}
                        {showScanner && (
                            <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
                                    <div className="bg-gray-900 p-4 flex justify-between items-center">
                                        <h3 className="text-white text-lg font-bold">掃描條碼</h3>
                                        <button onClick={() => setShowScanner(false)} className="text-white text-3xl leading-none">×</button>
                                    </div>
                                    <BarcodeScanner
                                        onDetected={(code) => {
                                            setBarcode(code);
                                            setShowScanner(false);
                                        }}
                                    />
                                    <div className="p-4 text-center text-sm text-gray-600">
                                        將條碼對準畫面中央方框即可自動辨識
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };


            // ----------------------------------------------------------------------
            // 12. 主應用程式介面 (Main UI)
            // ----------------------------------------------------------------------
            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header/Navbar */}
                    <nav className="bg-white shadow-md sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex-shrink-0 text-xl font-bold text-gray-900">
                                    📦 庫存管理
                                </div>
                                <div className="text-sm text-gray-500">
                                    使用者 ID: {userId ? userId.substring(0, 8) + '...' : 'N/A'}
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow">
                        <div className="flex border-b border-gray-200">
                            {/* 概要 */}
                            <button
                                onClick={() => setActiveTab('inventory')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'inventory' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                概要
                            </button>

                            {/* 出庫 */}
                            <button
                                onClick={() => setActiveTab('stockout')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'stockout' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                出庫
                            </button>

                            {/* 新增加 */}
                            <button
                                onClick={() => setActiveTab('add')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'add' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                新增加
                            </button>

                            {/* 設定 */}
                            <button
                                onClick={() => setActiveTab('settings')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'settings' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                設定
                            </button>
                        </div>

                        <div className="mt-6">
                        {activeTab === 'add' && settings && (
                            <AddItemForm 
                                supabaseClient={supabaseClient} 
                                userId={userId} 
                                categories={settings.categories} 
                                defaultCurrency={settings.currency}
                                onSuccess={() => {fetchInitialData(); setActiveTab('inventory');}}  
                            />
                        )}

                        {activeTab === 'inventory' && settings && (
                            <InventoryOverview
                                settings={settings}
                                inventory={inventory}
                                stockOuts={stockOuts}
                                setSelectedItem={setSelectedItem} 
                            />
                        )}
                        
                        {activeTab === 'stockout' && settings && (
                            <StockOutPage
                                supabaseClient={supabaseClient}
                                userId={userId}
                                inventory={inventory}
                                stockOuts={stockOuts}
                                setActiveTab={setActiveTab}
                            />
                        )}
                            
                        {activeTab === 'settings' && settings && (
                            <SettingsPanel 
                                supabaseClient={supabaseClient} 
                                userId={userId} 
                                currentSettings={settings} 
                                handleLogout={handleLogout} 
                                setActiveTab={setActiveTab}  
                            />
                        )}
                        </div>

                        {/* 明細彈窗渲染 */}
                        {selectedItem && settings && (
                            <DetailModal
                                item={selectedItem}
                                inventory={inventory}
                                stockOuts={stockOuts}
                                onClose={() => setSelectedItem(null)}
                                settings={settings}
                                userId={userId}
                                refreshData={fetchInitialData} // 傳遞刷新函數
                            />
                        )}
                    </main>

                    <footer className="py-4 text-center text-sm text-gray-500">
                        <p>© 2024年庫存管理應用程式。所有資料均使用 Supabase PostgREST 即時同步。</p>
                    </footer>
                </div>
            );
        };

        // 渲染應用程式到 DOM
        if (typeof ReactDOM !== 'undefined') {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        } else {
             console.error("ReactDOM not found. Please check script loading.");
        }
    </script>
</body>
</html>
