<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase åº«å­˜ç®¡ç†æ‡‰ç”¨ç¨‹å¼</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

    <style>
        /* ä¿æŒåŸæœ‰çš„ Quagga æƒæå™¨æ¨£å¼ */
        #interactive.viewport {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }
        #interactive.viewport canvas, video {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        #interactive.viewport .drawingBuffer {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        .drawingBuffer > canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        .laser-box {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 10px;
            margin-left: -40%;
            margin-top: -5px;
            background: red;
            opacity: 0.5;
            box-shadow: 0 0 10px red;
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            from { opacity: 0.5; }
            to { opacity: 0.8; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const { createClient } = supabase;

        // ----------------------------------------------------------------------
        // 1. è¨­å®š Supabase
        // ----------------------------------------------------------------------
        const SUPABASE_URL = 'https://edtoegcycroomrcebywq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkdG9lZ2N5Y3Jvb21yY2VieXdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMjczMzcsImV4cCI6MjA3OTgwMzMzN30.PFVzPDIhxrxW47lDaUW-3aQtD_QbwJcn2muENJRra_s';
        const COMMON_CURRENCIES = ['USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'HKD', 'TWD', 'CNY', 'VND', 'SGD']; // âœ… æ–°å¢å¸¸ç”¨è²¨å¹£åˆ—è¡¨

        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ----------------------------------------------------------------------
        // 2. è¼”åŠ©å‡½å¼
        // ----------------------------------------------------------------------

        // æ ¼å¼åŒ–è²¨å¹£
        const formatCurrency = (amount, currencyCode = 'USD') => {
            if (typeof amount !== 'number') return '';
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currencyCode,
                minimumFractionDigits: 0,
                maximumFractionDigits: 2,
            });
            return formatter.format(amount);
        };

        // èšåˆåº«å­˜æ•¸æ“š
        const aggregateInventoryData = (inventory = [], stockOuts = []) => {
            const grouped = {};
            const stockOutMap = {};

            // 1. è™•ç†å‡ºåº«æ•¸æ“š
            stockOuts.forEach(out => {
                const key = out.barcode;
                stockOutMap[key] = (stockOutMap[key] || 0) + out.quantity;
            });

            // 2. è™•ç†å…¥åº«æ•¸æ“šä¸¦èšåˆ
            inventory.forEach(item => {
                const key = item.barcode;
                const itemCost = item.price || 0; 
                
                if (!grouped[key]) {
                    grouped[key] = {
                        barcode: item.barcode,
                        name: item.name,
                        category: item.category,
                        totalInStock: 0,
                        totalCost: 0,
                        avgCost: 0,
                        currentStock: 0,
                    };
                }
                grouped[key].totalInStock += 1; 
                grouped[key].totalCost += itemCost;
            });

            // 3. è¨ˆç®—å¹³å‡æˆæœ¬å’Œå‰©é¤˜åº«å­˜
            Object.values(grouped).forEach(item => {
                item.avgCost = item.totalInStock > 0 ? item.totalCost / item.totalInStock : 0;
                const totalOut = stockOutMap[item.barcode] || 0;
                item.currentStock = item.totalInStock - totalOut;
            });

            return Object.values(grouped);
        };

        // ----------------------------------------------------------------------
        // 3. Supabase èº«ä»½é©—è­‰/ç™»å…¥çµ„ä»¶ (AuthForm)
        // ----------------------------------------------------------------------
        const AuthForm = ({ supabaseClient }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLogin, setIsLogin] = useState(true);
            const [message, setMessage] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMessage('');

                try {
                    if (isLogin) {
                        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                    } else {
                        const { error } = await supabaseClient.auth.signUp({ email, password });
                        if (error) throw error;
                        setMessage('è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥æ‚¨çš„é›»å­éƒµä»¶ä»¥ç¢ºèªå¸³æˆ¶ï¼Œç„¶å¾Œç™»å…¥ã€‚');
                    }
                } catch (error) {
                    const displayMessage = error.message || 'æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥é›»å­éƒµä»¶/å¯†ç¢¼ã€‚';
                    setMessage(displayMessage);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                        <h1 className="text-3xl font-bold text-center mb-6 text-gray-800">
                            {isLogin ? 'ç™»å…¥' : 'è¨»å†Š'}
                        </h1>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                    placeholder="your@email.com"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">å¯†ç¢¼</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                    placeholder="è‡³å°‘ 6 ä½å­—å…ƒ"
                                />
                            </div>
                            {message && (
                                <p className={`p-3 text-sm rounded-lg ${message.includes('æˆåŠŸ') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {message}
                                </p>
                            )}
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50"
                            >
                                {loading ? 'è™•ç†ä¸­...' : (isLogin ? 'ç™»å…¥' : 'è¨»å†Š')}
                            </button>
                        </form>
                        <div className="mt-6 text-center">
                            <button
                                onClick={() => setIsLogin(!isLogin)}
                                className="text-sm text-blue-600 hover:text-blue-800 transition duration-150"
                            >
                                {isLogin ? 'é‚„æ²’æœ‰å¸³æˆ¶ï¼Ÿé»æ­¤è¨»å†Š' : 'å·²ç¶“æœ‰å¸³æˆ¶äº†ï¼Ÿé»æ­¤ç™»å…¥'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 4. BarcodeScanner çµ„ä»¶
        // ----------------------------------------------------------------------
        const BarcodeScanner = ({ onDetected }) => {
            const [error, setError] = useState(null);
            const scannerRef = React.useRef(null);

            useEffect(() => {
                if (!Quagga) return;

                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: scannerRef.current,
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment" 
                        },
                    },
                    decoder: {
                        readers: ["ean_reader", "upc_reader", "code_128_reader", "code_39_reader"]
                    },
                }, (err) => {
                    if (err) {
                        setError(`ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: ${err.message}`);
                        return;
                    }
                    Quagga.start();
                });

                Quagga.onDetected((data) => {
                    if (data && data.codeResult && data.codeResult.code) {
                        onDetected(data.codeResult.code);
                        Quagga.stop();
                    }
                });

                return () => {
                    Quagga.stop();
                };
            }, [onDetected]);

            return (
                <div className="relative">
                    {error ? (
                        <div className="p-4 text-center text-red-600 bg-red-50">{error}</div>
                    ) : (
                        <div id="interactive" className="viewport" ref={scannerRef}>
                            <div className="laser-box"></div>
                        </div>
                    )}
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 5. è©³ç´°æ˜ç´°å½ˆçª— (DetailModal) âœ… æ–°å¢åŠŸèƒ½
        // ----------------------------------------------------------------------
        const DetailModal = ({ item, inventory, stockOuts, onClose, settings }) => {
            const itemDetails = inventory.filter(inv => inv.barcode === item.barcode)
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); // æŒ‰æ™‚é–“é™åºæ’åˆ—

            const isStockOut = (inventoryItem) => {
                // é€™æ˜¯ç°¡åŒ–çš„é‚è¼¯ã€‚åœ¨æ›´è¤‡é›œçš„ç³»çµ±ä¸­ï¼Œæ‚¨éœ€è¦è¿½è¹¤æ¯å€‹å…¥åº« ID çš„å‡ºåº«æƒ…æ³ã€‚
                // é€™è£¡æˆ‘å€‘åªé¡¯ç¤ºåŸå§‹å…¥åº«åˆ—è¡¨ã€‚
                return false; 
            };

            const isItemOut = (inventoryItem) => {
                // ç‚ºäº†æ¨¡æ“¬ï¼Œæˆ‘å€‘å‡è¨­ä»»ä½•å·²ç¶“ aggregated out çš„ item åœ¨é€™è£¡éƒ½æ˜¯ "å‡ºåº«"
                const outCount = stockOuts.filter(out => out.barcode === item.barcode).reduce((sum, out) => sum + out.quantity, 0);
                return outCount > 0;
            }

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            <h2 className="text-2xl font-bold mb-2 text-gray-800">
                                é …ç›®æ˜ç´°ï¼š{item.name} <span className="text-base text-gray-500 font-normal">({item.barcode})</span>
                            </h2>
                            <p className="mb-4 text-sm text-gray-600">ç›®å‰åº«å­˜ï¼š<span className="font-bold text-blue-600">{item.currentStock}</span> ä»¶</p>
                            
                            <div className="overflow-x-auto border rounded-lg">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç‹€æ…‹</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">è³¼å…¥åƒ¹æ ¼</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">è³¼å…¥æ—¥æœŸ</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">è¨˜éŒ„ ID</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {itemDetails.length === 0 ? (
                                            <tr><td colSpan="4" className="px-6 py-4 text-center text-gray-500">ç„¡è©³ç´°å…¥åº«è¨˜éŒ„ã€‚</td></tr>
                                        ) : (
                                            itemDetails.map((detail) => (
                                                <tr key={detail.id} className={`${isItemOut(detail) ? 'bg-red-50' : 'hover:bg-gray-50'}`}>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                        {item.currentStock > 0 ? (
                                                            <span className="text-green-600">åœ¨åº«</span>
                                                        ) : (
                                                            <span className="text-red-600">å·²å‡ºåº«</span>
                                                        )}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                        {formatCurrency(detail.price, detail.currency)}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                        {new Date(detail.created_at).toLocaleString()}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-xs text-gray-400">
                                                        {detail.id.substring(0, 8)}...
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="p-4 bg-gray-50 border-t flex justify-end">
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-300"
                            >
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 6. æ‡‰ç”¨ç¨‹å¼ä¸»é«”ï¼šApp çµ„ä»¶
        // ----------------------------------------------------------------------
        const App = () => {
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('inventory'); 

            // Data States
            const [inventory, setInventory] = useState([]); 
            const [stockOuts, setStockOuts] = useState([]);
            const [settings, setSettings] = useState(null); 
            const [selectedItem, setSelectedItem] = useState(null); // âœ… æ–°å¢ï¼šç”¨æ–¼æ˜ç´°å½ˆçª—

            // Derived State
            const userId = session?.user?.id || null;
            
            // 1. Supabase èº«ä»½é©—è­‰ç›£è½
            useEffect(() => {
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    setLoading(false);
                });

                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(
                    (_event, session) => {
                        setSession(session);
                        setLoading(false);
                    }
                );

                return () => subscription.unsubscribe();
            }, []);


            // 2. Supabase å³æ™‚æ•¸æ“šè¨‚é–±
            useEffect(() => {
                if (!userId) return;

                const fetchInitialData = async () => {
                    // Fetch Inventory Items (inventory_items table)
                    const { data: invData, error: invError } = await supabaseClient
                        .from('inventory_items') 
                        .select('*')
                        .eq('user_id', userId);
                    if (invError) console.error("Error fetching inventory:", invError);
                    else setInventory(invData);

                    // Fetch Stock Outs (stock_outs table)
                    const { data: outData, error: outError } = await supabaseClient
                        .from('stock_outs') 
                        .select('*')
                        .eq('user_id', userId);
                    if (outError) console.error("Error fetching stock outs:", outError);
                    else setStockOuts(outData);

                    // Fetch Settings (user_settings table)
                    const { data: settingsData, error: settingsError } = await supabaseClient
                        .from('user_settings') 
                        .select('*')
                        .eq('user_id', userId)
                        .maybeSingle(); 
                        
                    if (settingsError && settingsError.code !== 'PGRST116') { 
                         console.error("Error fetching settings:", settingsError);
                    } else if (settingsData) {
                        setSettings(settingsData);
                    } else {
                         // Default settings for new user
                         setSettings({ categories: ['é›»å­ç”¢å“', 'æœè£', 'é£Ÿå“', 'æ›¸ç±', 'å…¶ä»–'], currency: 'HKD', user_id: userId });
                    }
                };

                fetchInitialData();


                // Setup Realtime Subscriptions
                const inventorySubscription = supabaseClient
                    .channel('inventory_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'inventory_items', filter: `user_id=eq.${userId}` }, 
                        (payload) => {
                             fetchInitialData(); 
                        }
                    )
                    .subscribe();

                const stockOutsSubscription = supabaseClient
                    .channel('stock_outs_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'stock_outs', filter: `user_id=eq.${userId}` }, 
                        (payload) => {
                             fetchInitialData(); 
                        }
                    )
                    .subscribe();

                const settingsSubscription = supabaseClient
                    .channel('settings_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'user_settings', filter: `user_id=eq.${userId}` }, 
                        (payload) => {
                             fetchInitialData(); 
                        }
                    )
                    .subscribe();

                return () => {
                    supabaseClient.removeChannel(inventorySubscription);
                    supabaseClient.removeChannel(stockOutsSubscription);
                    supabaseClient.removeChannel(settingsSubscription);
                };
            }, [userId]);


            const handleLogout = async () => {
                await supabaseClient.auth.signOut();
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
                    </div>
                );
            }

            if (!session) {
                return <AuthForm supabaseClient={supabaseClient} />;
            }

            // ----------------------------------------------------------------------
            // 7. çµ„ä»¶ - åº«å­˜æ¦‚è¦½ (InventoryOverview) 
            // ----------------------------------------------------------------------
            const InventoryOverview = ({ settings, inventory, stockOuts, setSelectedItem }) => {
                const [filterText, setFilterText] = useState('');
                const [filterCategory, setFilterCategory] = useState('All'); // âœ… æ–°å¢ï¼šåˆ†é¡ç¯©é¸ç‹€æ…‹
                const [sortKey, setSortKey] = useState('currentStock');
                const [sortDirection, setSortDirection] = useState('desc');

                const categories = Array.isArray(settings.categories) ? settings.categories : (settings.categories || '').split(',').map(s => s.trim());
                
                const overviewData = useMemo(() => aggregateInventoryData(inventory, stockOuts), [inventory, stockOuts]);

                const filteredAndSortedData = useMemo(() => {
                    let data = overviewData.filter(item => {
                        const textMatch = item.name.toLowerCase().includes(filterText.toLowerCase()) ||
                                          item.barcode.includes(filterText);
                        
                        const categoryMatch = filterCategory === 'All' || item.category === filterCategory; // âœ… æ‡‰ç”¨åˆ†é¡ç¯©é¸

                        return textMatch && categoryMatch;
                    });

                    data.sort((a, b) => {
                        const valA = a[sortKey];
                        const valB = b[sortKey];
                        let comparison = 0;

                        if (typeof valA === 'string') {
                            comparison = valA.localeCompare(valB);
                        } else {
                            comparison = valA - valB;
                        }

                        return sortDirection === 'asc' ? comparison : comparison * -1;
                    });
                    return data;
                }, [overviewData, filterText, sortKey, sortDirection, filterCategory]); // âœ… ä¾è³´ filterCategory

                const handleSort = (key) => {
                    if (sortKey === key) {
                        setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                    } else {
                        setSortKey(key);
                        setSortDirection('asc');
                    }
                };

                const totalValue = filteredAndSortedData.reduce((sum, item) => sum + (item.currentStock * item.avgCost), 0);

                const getSortIndicator = (key) => {
                    if (sortKey === key) {
                        return sortDirection === 'asc' ? ' â–²' : ' â–¼';
                    }
                    return '';
                };

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-md">
                            <h3 className="text-xl font-semibold text-gray-800">
                                ç¸½åº«å­˜åƒ¹å€¼: <span className="text-blue-600">{formatCurrency(totalValue, settings.currency)}</span>
                            </h3>
                            <div className="flex gap-4">
                                {/* åˆ†é¡ç¯©é¸å™¨ (Select) âœ… æ–°å¢åŠŸèƒ½ */}
                                <select
                                    value={filterCategory}
                                    onChange={(e) => setFilterCategory(e.target.value)}
                                    className="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                >
                                    <option value="All">æ‰€æœ‰åˆ†é¡</option>
                                    {categories.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                                <input
                                    type="text"
                                    placeholder="ğŸ” æœå°‹å“åæˆ–æ¢ç¢¼..."
                                    value={filterText}
                                    onChange={(e) => setFilterText(e.target.value)}
                                    className="p-2 border border-gray-300 rounded-lg w-64 focus:ring-blue-500 focus:border-blue-500"
                                />
                            </div>
                        </div>

                        <div className="overflow-x-auto bg-white rounded-xl shadow-md">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        {['åç¨±', 'æ¢ç¢¼', 'é¡åˆ¥', 'ç¾æœ‰åº«å­˜', 'å¹³å‡æˆæœ¬', 'ç¸½æˆæœ¬'].map((header, index) => {
                                            const keyMap = ['name', 'barcode', 'category', 'currentStock', 'avgCost', 'totalCost'];
                                            const key = keyMap[index];
                                            const isNumeric = ['currentStock', 'avgCost', 'totalCost'].includes(key);

                                            return (
                                                <th
                                                    key={key}
                                                    onClick={() => handleSort(key)}
                                                    className={`px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer transition duration-150 hover:bg-gray-100 ${isNumeric ? 'text-right' : ''}`}
                                                >
                                                    {header}
                                                    {getSortIndicator(key)}
                                                </th>
                                            );
                                        })}
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredAndSortedData.length === 0 ? (
                                        <tr>
                                            <td colSpan="6" className="px-6 py-4 text-center text-gray-500">
                                                {overviewData.length === 0 ? 'ç›®å‰æ²’æœ‰ä»»ä½•åº«å­˜é …ç›®ã€‚' : 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é …ç›®ã€‚'}
                                            </td>
                                        </tr>
                                    ) : (
                                        filteredAndSortedData.map((item) => (
                                            <tr key={item.barcode} className={`${item.currentStock === 0 ? 'bg-red-50 text-gray-500' : 'hover:bg-gray-50'}`}>
                                                <td 
                                                    className="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 hover:text-blue-800 cursor-pointer underline" 
                                                    onClick={() => setSelectedItem(item)} // âœ… é»æ“Šæ™‚é¡¯ç¤ºæ˜ç´°
                                                >
                                                    {item.name}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.barcode}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.category}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm font-bold text-right ${item.currentStock === 0 ? 'text-red-600' : 'text-green-600'}`}>
                                                    {item.currentStock}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">
                                                    {formatCurrency(item.avgCost, settings.currency)}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">
                                                    {formatCurrency(item.avgCost * item.currentStock, settings.currency)}
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            // ----------------------------------------------------------------------
            // 8. çµ„ä»¶ - æ–°å¢åŠ  (AddItemForm) 
            // ----------------------------------------------------------------------
            const AddItemForm = ({ supabaseClient, userId, categories, defaultCurrency, onSuccess }) => {
                const [name, setName] = useState('');
                const [barcode, setBarcode] = useState('');
                const [category, setCategory] = useState(categories[0] || '');
                const [price, setPrice] = useState(0); 
                const [itemCurrency, setItemCurrency] = useState(defaultCurrency); // âœ… æ–°å¢ï¼šå–®ä»¶è²¨å¹£ç‹€æ…‹
                const [quantity, setQuantity] = useState(1);
                const [message, setMessage] = useState('');
                const [loading, setLoading] = useState(false);
                const [showScanner, setShowScanner] = useState(false);
                
                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (!name || !barcode || quantity <= 0 || price < 0) {
                        setMessage('è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½ä¸¦ç¢ºä¿æ•¸å€¼æ­£ç¢ºã€‚');
                        return;
                    }

                    setLoading(true);
                    setMessage('');
                    
                    const itemTemplate = {
                        user_id: userId,
                        name: name.trim(),
                        barcode: barcode.trim(),
                        category,
                        price: parseFloat(price), 
                        currency: itemCurrency, // âœ… ä½¿ç”¨ itemCurrency
                    };

                    try {
                        const itemsToInsert = Array.from({ length: parseInt(quantity, 10) }, () => ({
                            ...itemTemplate
                        }));

                        const { error } = await supabaseClient
                            .from('inventory_items') 
                            .insert(itemsToInsert);

                        if (error) throw error;

                        setMessage(`æˆåŠŸæ–°å¢ ${quantity} ä»¶ã€Œ${name}ã€ï¼`);
                        setName('');
                        setBarcode('');
                        setPrice(0);
                        setItemCurrency(defaultCurrency); // é‡ç½®
                        setQuantity(1);
                        setTimeout(() => {
                            setMessage('');
                            onSuccess(); 
                        }, 3000);

                    } catch (err) {
                        console.error("Supabase Insert Error:", err);
                        setMessage('æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™è¨­å®šã€‚');
                    } finally {
                        setLoading(false);
                    }
                };

                return (
                    <div className="p-6 bg-white shadow-xl rounded-2xl">
                        <h2 className="text-2xl font-bold mb-6 text-gray-800">æ–°å¢åº«å­˜é …ç›®</h2>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* åç¨±, æ¢ç¢¼, é¡åˆ¥ (ä¸è®Š) */}
                            {/* ... (ç•¥) ... */}

                            {/* æ¢ç¢¼èˆ‡æƒæ */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">æ¢ç¢¼ (Bar Code) <span className="text-red-500">*</span></label>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={barcode}
                                        onChange={(e) => setBarcode(e.target.value)}
                                        className="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="è¼¸å…¥æˆ–æƒææ¢ç¢¼"
                                        required
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setShowScanner(true)}
                                        className="px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow flex items-center gap-2"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                                        æƒæ
                                    </button>
                                </div>
                            </div>
                            
                            {/* åç¨± */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">å“å <span className="text-red-500">*</span></label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="è¼¸å…¥å•†å“åç¨±"
                                    required
                                />
                            </div>

                            {/* é¡åˆ¥ */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">é¡åˆ¥</label>
                                <select
                                    value={category}
                                    onChange={(e) => setCategory(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                >
                                    {categories.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="flex space-x-4">
                                {/* æˆæœ¬ (Price) */}
                                <div className="flex-1">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">å–®ä»¶æˆæœ¬/è³¼å…¥åƒ¹æ ¼ <span className="text-red-500">*</span></label>
                                    <input
                                        type="number"
                                        min="0"
                                        step="0.01"
                                        value={price}
                                        onChange={(e) => setPrice(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    />
                                </div>

                                {/* è²¨å¹£é¸æ“‡ (Select) âœ… æ–°å¢åŠŸèƒ½ */}
                                <div className="w-1/4"> 
                                    <label className="block text-sm font-medium text-gray-700 mb-1">è²¨å¹£ <span className="text-red-500">*</span></label>
                                    <select
                                        value={itemCurrency}
                                        onChange={(e) => setItemCurrency(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    >
                                        {COMMON_CURRENCIES.map(code => (
                                            <option key={code} value={code}>{code}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* æ•¸é‡ */}
                                <div className="flex-1">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">æ•¸é‡ <span className="text-red-500">*</span></label>
                                    <input
                                        type="number"
                                        min="1"
                                        value={quantity}
                                        onChange={(e) => setQuantity(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    />
                                </div>
                            </div>

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50"
                            >
                                {loading ? 'æ–°å¢ä¸­...' : 'ç¢ºèªå…¥åº«'}
                            </button>
                        </form>

                        {message && (
                            <div className={`mt-4 p-3 rounded-lg text-sm font-medium text-center ${message.includes('æˆåŠŸ') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                {message}
                            </div>
                        )}

                        {/* æ¢ç¢¼æƒæå™¨ Modal (ä¸è®Š) */}
                        {showScanner && (
                            <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
                                    <div className="bg-gray-900 p-4 flex justify-between items-center">
                                        <h3 className="text-white text-lg font-bold">æƒææ¢ç¢¼</h3>
                                        <button onClick={() => setShowScanner(false)} className="text-white text-3xl leading-none">Ã—</button>
                                    </div>
                                    <BarcodeScanner
                                        onDetected={(code) => {
                                            setBarcode(code);
                                            setShowScanner(false);
                                        }}
                                    />
                                    <div className="p-4 text-center text-sm text-gray-600">
                                        å°‡æ¢ç¢¼å°æº–ç•«é¢ä¸­å¤®æ–¹æ¡†å³å¯è‡ªå‹•è¾¨è­˜
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // ----------------------------------------------------------------------
            // 9. çµ„ä»¶ - è¨­å®šé¢æ¿ (SettingsPanel) 
            // ----------------------------------------------------------------------
            const SettingsPanel = ({ supabaseClient, userId, currentSettings, handleLogout, setActiveTab }) => {
                const [categoriesInput, setCategoriesInput] = useState(
                    Array.isArray(currentSettings.categories) 
                        ? currentSettings.categories.join(', ')
                        : (currentSettings.categories || '').toString()
                );
                const [currency, setCurrency] = useState(currentSettings.currency);
                const [message, setMessage] = useState('');
                const [loading, setLoading] = useState(false);

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    setLoading(true);
                    setMessage('');

                    // è™•ç† Supabase çš„ TEXT[] æ ¼å¼
                    const newCategories = categoriesInput.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    if (newCategories.length === 0) {
                        setMessage('é¡åˆ¥åˆ—è¡¨ä¸èƒ½ç‚ºç©ºã€‚');
                        setLoading(false);
                        return;
                    }

                    const newSettings = {
                        user_id: userId,
                        categories: newCategories,
                        currency: currency,
                    };

                    try {
                        const { error } = await supabaseClient
                            .from('user_settings') 
                            .upsert(newSettings, { onConflict: 'user_id' }); 

                        if (error) throw error;

                        setMessage('è¨­å®šå·²æˆåŠŸå„²å­˜ï¼');
                        setTimeout(() => setMessage(''), 3000);
                    } catch (err) {
                        console.error("Supabase Settings Error:", err);
                        setMessage('å„²å­˜è¨­å®šå¤±æ•—ã€‚');
                    } finally {
                        setLoading(false);
                    }
                };

                return (
                    <div className="p-6 bg-white shadow-xl rounded-2xl space-y-8">
                        <h2 className="text-2xl font-bold text-gray-800 border-b pb-4">æ‡‰ç”¨ç¨‹å¼è¨­å®š</h2>

                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* è²¨å¹£è¨­å®š - ä½¿ç”¨ä¸‹æ‹‰é¸å–® âœ… æ¢å¾©åŠŸèƒ½ */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    é è¨­è²¨å¹£ä»£ç¢¼ (ç”¨æ–¼æˆæœ¬/ç¸½å€¼)
                                </label>
                                <select
                                    value={currency}
                                    onChange={(e) => setCurrency(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                >
                                    {COMMON_CURRENCIES.map(code => (
                                        <option key={code} value={code}>{code}</option>
                                    ))}
                                </select>
                                <p className="mt-1 text-xs text-gray-500">è«‹é¸æ“‡ä¸‰ä½å­—æ¯ä»£ç¢¼ã€‚</p>
                            </div>

                            {/* é¡åˆ¥è¨­å®š - ä¿æŒ TEXTAREAï¼Œä½†å„ªåŒ–èªªæ˜ âœ… æ¢å¾©åŠŸèƒ½ */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    åº«å­˜é¡åˆ¥åˆ—è¡¨ (ä»¥é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ï¼šé›»å­ç”¢å“, æœè£)
                                </label>
                                <textarea
                                    rows="3"
                                    value={categoriesInput}
                                    onChange={(e) => setCategoriesInput(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="é›»å­ç”¢å“, æ›¸ç±, å…¶ä»–"
                                    required
                                />
                                <p className="mt-1 text-xs text-gray-500">é€™äº›é¡åˆ¥æœƒé¡¯ç¤ºåœ¨æ–°å¢é …ç›®è¡¨å–®ä¸­ã€‚</p>
                            </div>

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 disabled:opacity-50"
                            >
                                {loading ? 'å„²å­˜ä¸­...' : 'å„²å­˜è¨­å®š'}
                            </button>

                            {message && (
                                <div className={`p-3 text-sm rounded-lg text-center ${message.includes('æˆåŠŸ') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                    {message}
                                </div>
                            )}
                        </form>

                        {/* å¸³æˆ¶æ“ä½œ */}
                        <div className="border-t pt-6 mt-6 space-y-4">
                            <h3 className="text-xl font-semibold text-gray-800">å¸³æˆ¶ç®¡ç†</h3>
                            <p className="text-sm text-gray-600">æ‡‰ç”¨ç¨‹å¼ ID/Supabase URL: <code className="bg-gray-200 p-1 rounded text-xs">...</code></p>
                            <button
                                onClick={handleLogout}
                                className="w-full py-2 px-4 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-300"
                            >
                                ç™»å‡º
                            </button>
                        </div>
                    </div>
                );
            };


            // ----------------------------------------------------------------------
            // 10. ä¸»æ‡‰ç”¨ç¨‹å¼ä»‹é¢ (Main UI)
            // ----------------------------------------------------------------------
            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header/Navbar */}
                    <nav className="bg-white shadow-md sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex-shrink-0 text-xl font-bold text-gray-900">
                                    ğŸ“¦ åº«å­˜ç®¡ç†
                                </div>
                                <div className="text-sm text-gray-500">
                                    ä½¿ç”¨è€… ID: {userId ? userId.substring(0, 8) + '...' : 'N/A'}
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow">
                        <div className="flex border-b border-gray-200">
                            {/* æ¦‚è¦ */}
                            <button
                                onClick={() => setActiveTab('inventory')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'inventory' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                æ¦‚è¦
                            </button>

                            {/* å‡ºåº« */}
                            <button
                                onClick={() => setActiveTab('stockout')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'stockout' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                å‡ºåº«
                            </button>

                            {/* æ–°å¢åŠ  */}
                            <button
                                onClick={() => setActiveTab('add')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'add' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                æ–°å¢åŠ 
                            </button>

                            {/* è¨­å®š */}
                            <button
                                onClick={() => setActiveTab('settings')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'settings' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                è¨­å®š
                            </button>
                        </div>

                        <div className="mt-6">
                        {activeTab === 'add' && settings && (
                            <AddItemForm 
                                supabaseClient={supabaseClient} 
                                userId={userId} 
                                categories={settings.categories} 
                                defaultCurrency={settings.currency}
                                onSuccess={() => setActiveTab('inventory')}  
                            />
                        )}

                        {activeTab === 'inventory' && settings && (
                            <InventoryOverview
                                settings={settings}
                                inventory={inventory}
                                stockOuts={stockOuts}
                                setSelectedItem={setSelectedItem} // âœ… å‚³é setSelectedItem
                            />
                        )}
                        
                        {activeTab === 'stockout' && settings && (
                            <StockOutPage
                                supabaseClient={supabaseClient}
                                userId={userId}
                                inventory={inventory}
                                stockOuts={stockOuts}
                                setActiveTab={setActiveTab}
                            />
                        )}
                            
                        {activeTab === 'settings' && settings && (
                            <SettingsPanel 
                                supabaseClient={supabaseClient} 
                                userId={userId} 
                                currentSettings={settings} 
                                handleLogout={handleLogout} 
                                setActiveTab={setActiveTab}  
                            />
                        )}
                        </div>

                        {/* æ˜ç´°å½ˆçª—æ¸²æŸ“ âœ… æ–°å¢æ¸²æŸ“é‚è¼¯ */}
                        {selectedItem && (
                            <DetailModal
                                item={selectedItem}
                                inventory={inventory}
                                stockOuts={stockOuts}
                                onClose={() => setSelectedItem(null)}
                                settings={settings}
                            />
                        )}
                    </main>

                    <footer className="py-4 text-center text-sm text-gray-500">
                        <p>Â© 2024å¹´åº«å­˜ç®¡ç†æ‡‰ç”¨ç¨‹å¼ã€‚æ‰€æœ‰è³‡æ–™å‡ä½¿ç”¨ Supabase PostgREST å³æ™‚åŒæ­¥ã€‚</p>
                    </footer>
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 11. çµ„ä»¶ - å‡ºåº«é é¢ (StockOutPage) 
        // ----------------------------------------------------------------------
        const StockOutPage = ({ supabaseClient, userId, inventory, stockOuts, setActiveTab }) => {
            const [barcode, setBarcode] = useState('');
            const [name, setName] = useState('');
            const [quantity, setQuantity] = useState(1);
            const [showScanner, setShowScanner] = useState(false);
            const [message, setMessage] = useState('');
            const [loading, setLoading] = useState(false);

            // å»ºç«‹ã€Œåç¨± â†’ æ¢ç¢¼ã€çš„æ˜ å°„è¡¨ï¼ˆåªåŒ…å«ç›®å‰æœ‰åº«å­˜çš„é …ç›®ï¼‰
            const nameToBarcodeMap = useMemo(() => {
                const map = {};
                const grouped = aggregateInventoryData(inventory, stockOuts);
                grouped.forEach(item => {
                    if (item.currentStock > 0) {
                        if (!map[item.name]) {
                            map[item.name] = item.barcode;
                        } else if (map[item.name] !== item.barcode) {
                            map[item.name] = null; 
                        }
                    }
                });
                return map;
            }, [inventory, stockOuts]);

            // ç•¶ barcode æ”¹è®Š â†’ è‡ªå‹•å¡«åç¨±
            useEffect(() => {
                if (!barcode) {
                    setName('');
                    return;
                }
                const grouped = aggregateInventoryData(inventory, stockOuts);
                const found = grouped.find(g => g.barcode === barcode);
                if (found) {
                    setName(found.name);
                } else {
                    setName('');
                }
            }, [barcode, inventory, stockOuts]);

            // ç•¶åç¨±æ”¹è®Š â†’ è‡ªå‹•å¡«æ¢ç¢¼ï¼ˆåƒ…åœ¨åç¨±å”¯ä¸€å°æ‡‰æ™‚ï¼‰
            useEffect(() => {
                if (!name) {
                    setBarcode('');
                    return;
                }
                const possibleBarcode = nameToBarcodeMap[name];
                if (possibleBarcode) {
                    setBarcode(possibleBarcode);
                }
            }, [name, nameToBarcodeMap]);

            // è¨ˆç®—ç›®å‰åº«å­˜é‡
            const currentStock = useMemo(() => {
                const grouped = aggregateInventoryData(inventory, stockOuts);
                const item = grouped.find(g => g.barcode === barcode);
                return item ? item.currentStock : 0;
            }, [barcode, inventory, stockOuts]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!barcode) {
                    setMessage('è«‹è¼¸å…¥æˆ–æƒææ¢ç¢¼');
                    return;
                }
                if (!name) {
                    setMessage('è«‹è¼¸å…¥é …ç›®åç¨±');
                    return;
                }
                const qty = parseInt(quantity, 10);
                if (isNaN(qty) || qty <= 0) {
                    setMessage('è«‹è¼¸å…¥æ­£ç¢ºçš„å‡ºåº«æ•¸é‡');
                    return;
                }
                if (qty > currentStock) {
                    setMessage(`å‡ºåº«æ•¸é‡ä¸èƒ½å¤§æ–¼ç›®å‰åº«å­˜ ${currentStock} ä»¶`);
                    return;
                }
                setLoading(true);
                setMessage('');
                
                const newStockOut = {
                    user_id: userId,
                    barcode: barcode.trim(),
                    name: name.trim(),
                    quantity: qty,
                };

                try {
                    const { error } = await supabaseClient
                        .from('stock_outs') 
                        .insert([newStockOut]);

                    if (error) throw error;

                    setMessage(`æˆåŠŸå‡ºåº« ${qty} ä»¶ã€Œ${name}ã€`);
                    setBarcode('');
                    setName('');
                    setQuantity(1);
                    setTimeout(() => {
                        setMessage('');
                        setActiveTab('inventory');
                    }, 4000);
                } catch (err) {
                    console.error("Supabase Stock Out Error:", err);
                    setMessage('å‡ºåº«å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="p-6 bg-white shadow-xl rounded-2xl">
                    <h2 className="text-2xl font-bold mb-6 text-gray-800">å‡ºåº« / å–è²¨</h2>
                    <form onSubmit={handleSubmit} className="space-y-6">
                        {/* åç¨±è¼¸å…¥æ¡† */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                åç¨± <span className="text-red-500">*</span>
                            </label>
                            <input
                                type="text"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                placeholder="è¼¸å…¥å“åï¼ˆæœƒè‡ªå‹•å¸¶å‡ºæ¢ç¢¼ï¼‰"
                                required
                            />
                            {name && nameToBarcodeMap[name] === null && (
                                <p className="text-xs text-orange-600 mt-1">
                                    â€» æ­¤å“åå°æ‡‰å¤šå€‹æ¢ç¢¼ï¼Œè«‹æƒææˆ–æ‰‹å‹•è¼¸å…¥æ­£ç¢ºæ¢ç¢¼
                                </p>
                            )}
                        </div>

                        {/* æ¢ç¢¼ */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                æ¢ç¢¼ (Bar Code) <span className="text-red-500">*</span>
                            </label>
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    value={barcode}
                                    onChange={(e) => setBarcode(e.target.value)}
                                    className="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="è¼¸å…¥æˆ–æƒææ¢ç¢¼ï¼ˆæœƒè‡ªå‹•å¸¶å‡ºå“åï¼‰"
                                    required
                                />
                                <button
                                    type="button"
                                    onClick={() => setShowScanner(true)}
                                    className="px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow flex items-center gap-2"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                                    æƒæ
                                </button>
                            </div>
                        </div>

                        {/* ç›®å‰åº«å­˜é¡¯ç¤º */}
                        {barcode && (
                            <div className="bg-blue-50 p-4 rounded-lg">
                                <span className="text-sm font-medium text-blue-800">
                                    ç›®å‰åº«å­˜é‡ï¼š{currentStock} ä»¶
                                </span>
                            </div>
                        )}

                        {/* å‡ºåº«æ•¸é‡ */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                å‡ºåº«æ•¸é‡ <span className="text-red-500">*</span>
                            </label>
                            <input
                                type="number"
                                min="1"
                                max={currentStock || 1}
                                value={quantity}
                                onChange={(e) => setQuantity(Math.max(1, parseInt(e.target.value) || 1))}
                                className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                            />
                        </div>

                        <button
                            type="submit"
                            disabled={loading || currentStock === 0}
                            className="w-full py-3 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 disabled:opacity-50"
                        >
                            {loading ? 'è™•ç†ä¸­...' : 'ç¢ºèªå‡ºåº«'}
                        </button>
                    </form>

                    {message && (
                        <div className={`mt-4 p-3 rounded-lg text-sm font-medium text-center ${
                            message.includes('æˆåŠŸ') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }`}>
                            {message}
                        </div>
                    )}

                    {/* æ¢ç¢¼æƒæå™¨ Modal (ä¸è®Š) */}
                    {showScanner && (
                        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
                                <div className="bg-gray-900 p-4 flex justify-between items-center">
                                    <h3 className="text-white text-lg font-bold">æƒææ¢ç¢¼</h3>
                                    <button onClick={() => setShowScanner(false)} className="text-white text-3xl leading-none">Ã—</button>
                                </div>
                                <BarcodeScanner
                                    onDetected={(code) => {
                                        setBarcode(code);
                                        setShowScanner(false);
                                    }}
                                />
                                <div className="p-4 text-center text-sm text-gray-600">
                                    å°‡æ¢ç¢¼å°æº–ç•«é¢ä¸­å¤®æ–¹æ¡†å³å¯è‡ªå‹•è¾¨è­˜
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };


        // æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼åˆ° DOM
        if (typeof ReactDOM !== 'undefined') {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        } else {
             console.error("ReactDOM not found. Please check script loading.");
        }
    </script>
</body>
</html>
