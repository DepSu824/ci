<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase åº«å­˜ç®¡ç†æ‡‰ç”¨ç¨‹å¼</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

    <style>
        /* æ¢ç¢¼æƒæå™¨æ¨£å¼ */
        #interactive.viewport {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }
        #interactive.viewport canvas, video {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        #interactive.viewport .drawingBuffer {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        .drawingBuffer > canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        .laser-box {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 10px;
            margin-left: -40%;
            margin-top: -5px;
            background: red;
            opacity: 0.5;
            box-shadow: 0 0 10px red;
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            from { opacity: 0.5; }
            to { opacity: 0.8; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const { createClient } = supabase;

        // ----------------------------------------------------------------------
        // 1. è¨­å®š Supabase & å¸¸æ•¸
        // ----------------------------------------------------------------------
        const SUPABASE_URL = 'https://edtoegcycroomrcebywq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkdG9lZ2N5Y3Jvb21yY2VieXdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMjczMzcsImV4cCI6MjA3OTgwMzMzN30.PFVzPDIhxrxW47lDaUW-3aQtD_QbwJcn2muENJRra_s';
        const FRANKFURTER_API = 'https://api.frankfurter.app'; // åŒ¯ç‡ API åŸºç¤ URL

        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ----------------------------------------------------------------------
        // 2. è¼”åŠ©å‡½å¼
        // ----------------------------------------------------------------------

        // æ ¼å¼åŒ–è²¨å¹£
        const formatCurrency = (amount, currencyCode = 'USD') => {
            if (typeof amount !== 'number' || isNaN(amount)) return '';
            try {
                const formatter = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currencyCode,
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2,
                });
                return formatter.format(amount);
            } catch (e) {
                return `${currencyCode} ${amount.toFixed(2)}`;
            }
        };

        // æ ¼å¼åŒ–æ™‚é–“æˆ³
        const formatTimestamp = (timestamp) => {
            if (!timestamp) return '-';
            try {
                return new Date(timestamp).toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false,
                });
            } catch (e) {
                return timestamp; 
            }
        };

        // è²¨å¹£è½‰æ›å‡½å¼ (ä½¿ç”¨å³æ™‚åŒ¯ç‡)
        const convertCurrency = (amount, fromCurrency, toCurrency, rates) => {
            if (fromCurrency === toCurrency) return amount;
            if (!rates || !rates[fromCurrency] || !rates[toCurrency]) {
                console.warn(`Missing exchange rate for ${fromCurrency} or ${toCurrency}. Conversion failed.`);
                return amount; 
            }
            
            // 1. å°‡ fromCurrency è½‰æ›ç‚º EUR: amount / rates[fromCurrency]
            // 2. å°‡ EUR è½‰æ›ç‚º toCurrency: result * rates[toCurrency]
            const rateFrom = rates[fromCurrency];
            const rateTo = rates[toCurrency];

            return (amount / rateFrom) * rateTo;
        };


        // èšåˆåº«å­˜æ•¸æ“š (ä¿®æ­£ç‰ˆæœ¬ï¼šæ”¯æ´è³¼å…¥æ™‚åŒ¯ç‡ vs. å³æ™‚åŒ¯ç‡)
        const aggregateInventoryData = (inventory = [], stockOuts = [], targetCurrency, rates, useRealtimeRate) => {
            const grouped = {};
            const stockOutMap = {};
            
            // åªæœ‰ç•¶ targetCurrency å’Œ rates éƒ½æœ‰å€¼ä¸” rates ä¸ç‚ºç©ºæ™‚æ‰é€²è¡Œæˆæœ¬è¨ˆç®—
            const needsConversion = targetCurrency && rates && Object.keys(rates).length > 0;

            // 1. è™•ç†å‡ºåº«æ•¸æ“š
            stockOuts.forEach(out => {
                const key = out.barcode;
                stockOutMap[key] = (stockOutMap[key] || 0) + out.quantity;
            });

            // 2. è™•ç†å…¥åº«æ•¸æ“šä¸¦èšåˆ (åˆå§‹åŒ–)
            inventory.forEach(item => {
                const key = item.barcode;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        barcode: item.barcode,
                        name: item.name,
                        category: item.category,
                        totalInStock: 0,
                        totalCostConverted: 0, 
                        avgCostConverted: 0, 
                        avgPurchasePrice: 0, 
                        maxPrice: 0,         
                        minPrice: 0,         
                        currentStock: 0,
                    };
                }
            });

            // 3. è¨ˆç®—æˆæœ¬ã€å¹³å‡è³¼å…¥åƒ¹ã€æœ€é«˜/æœ€ä½åƒ¹å’Œå‰©é¤˜åº«å­˜
            Object.values(grouped).forEach(item => {
                const uniquePurchaseRecords = inventory.filter(inv => inv.barcode === item.barcode);
                
                // æ“´å……ç´€éŒ„ï¼šåŠ å…¥è½‰æ›å¾Œçš„åƒ¹æ ¼
                const recordsWithConvertedPrice = uniquePurchaseRecords.map(rec => {
                    const originalPrice = rec.price || 0;
                    let priceConverted = originalPrice; // é è¨­ç‚ºåŸåƒ¹
                    
                    if (needsConversion) {
                        if (useRealtimeRate) {
                            // æ¨¡å¼ A: ä½¿ç”¨å³æ™‚åŒ¯ç‡é€²è¡Œè½‰æ› (èˆŠé‚è¼¯)
                            priceConverted = convertCurrency(originalPrice, rec.currency, targetCurrency, rates);
                        } else {
                            // æ¨¡å¼ B: ä½¿ç”¨è³¼å…¥æ™‚åŒ¯ç‡ (rate_to_base_currency) é€²è¡Œè½‰æ›
                            // rate_to_base_currency æ˜¯ item.currency æ›ç®—æˆ EUR çš„å€ç‡ (è³¼å…¥æ™‚çš„åŒ¯ç‡)
                            const historicalRateToEur = rec.rate_to_base_currency || (rates[rec.currency] ? 1 / rates[rec.currency] : 0);
                            
                            if (historicalRateToEur > 0) {
                                // 1. å°‡ itemPrice è½‰æ›ç‚º EUR (è³¼å…¥æ™‚çš„ EUR åƒ¹å€¼)
                                const priceInEurHistorical = originalPrice * historicalRateToEur;
                                
                                // 2. å°‡ EUR (Historical) è½‰æ›ç‚º Target Currency (ä½¿ç”¨å³æ™‚ rates)
                                const rateEurToTarget = rates[targetCurrency] || 1; // EUR to Target (Realtime)
                                priceConverted = priceInEurHistorical * rateEurToTarget;
                            } else {
                                // å¦‚æœç¼ºä¹ historical rate æˆ–å³æ™‚ ratesï¼Œå‰‡ä½¿ç”¨ convertCurrency fallback
                                priceConverted = convertCurrency(originalPrice, rec.currency, targetCurrency, rates);
                            }
                        }
                    }
                    
                    return {
                        ...rec,
                        priceConverted: priceConverted,
                        // è½‰æ›å¾Œçš„åƒ¹æ ¼æ˜¯å¦å¤§æ–¼ 0 (ç”¨æ–¼æ’é™¤è´ˆå“)
                        isValidPurchase: originalPrice > 0, 
                    };
                });
                
                const validPurchaseRecords = recordsWithConvertedPrice.filter(rec => rec.isValidPurchase);

                item.totalInStock = recordsWithConvertedPrice.length; 
                item.totalCostConverted = recordsWithConvertedPrice.reduce((sum, rec) => sum + rec.priceConverted, 0);
                item.avgCostConverted = item.totalInStock > 0 ? item.totalCostConverted / item.totalInStock : 0;
                
                // è¨ˆç®—å¹³å‡è³¼å…¥åƒ¹ (æ’é™¤è´ˆå“)
                if (validPurchaseRecords.length > 0 && needsConversion) { 
                    const validTotalCost = validPurchaseRecords.reduce((sum, rec) => sum + rec.priceConverted, 0);
                    item.avgPurchasePrice = validTotalCost / validPurchaseRecords.length;
                    item.maxPrice = Math.max(...validPurchaseRecords.map(rec => rec.priceConverted));
                    item.minPrice = Math.min(...validPurchaseRecords.map(rec => rec.priceConverted));
                } else {
                    item.avgPurchasePrice = 0;
                    item.maxPrice = 0;
                    item.minPrice = 0; 
                }
                
                const totalOut = stockOutMap[item.barcode] || 0;
                item.currentStock = item.totalInStock - totalOut;
            });

            return Object.values(grouped);
        };
        
        // ----------------------------------------------------------------------
        // ğŸ“Œ æ–°å¢è¼”åŠ©å‡½å¼ï¼šJSON æª”æ¡ˆä¸‹è¼‰ (Export Helper)
        // ----------------------------------------------------------------------
        const downloadJsonFile = (data, filename) => {
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };


        // ----------------------------------------------------------------------
        // 3. Supabase èº«ä»½é©—è­‰/ç™»å…¥çµ„ä»¶ (AuthForm)
        // ----------------------------------------------------------------------
        const AuthForm = ({ supabaseClient }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLogin, setIsLogin] = useState(true);
            const [message, setMessage] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMessage('');

                try {
                    if (isLogin) {
                        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                    } else {
                        const { error } = await supabaseClient.auth.signUp({ email, password });
                        if (error) throw error;
                        setMessage('è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥æ‚¨çš„é›»å­éƒµä»¶ä»¥ç¢ºèªå¸³æˆ¶ï¼Œç„¶å¾Œç™»å…¥ã€‚');
                    }
                } catch (error) {
                    const displayMessage = error.message || 'æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥é›»å­éƒµä»¶/å¯†ç¢¼ã€‚';
                    setMessage(displayMessage);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                        <h1 className="text-3xl font-bold text-center mb-6 text-gray-800">
                            {isLogin ? 'ç™»å…¥' : 'è¨»å†Š'}
                        </h1>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                    placeholder="your@email.com"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">å¯†ç¢¼</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                    placeholder="è‡³å°‘ 6 ä½å­—å…ƒ"
                                />
                            </div>
                            {message && (
                                <p className={`p-3 text-sm rounded-lg ${message.includes('æˆåŠŸ') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {message}
                                </p>
                            )}
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50"
                            >
                                {loading ? 'è™•ç†ä¸­...' : (isLogin ? 'ç™»å…¥' : 'è¨»å†Š')}
                            </button>
                        </form>
                        <div className="mt-6 text-center">
                            <button
                                onClick={() => setIsLogin(!isLogin)}
                                className="text-sm text-blue-600 hover:text-blue-800 transition duration-150"
                            >
                                {isLogin ? 'é‚„æ²’æœ‰å¸³æˆ¶ï¼Ÿé»æ­¤è¨»å†Š' : 'å·²ç¶“æœ‰å¸³æˆ¶äº†ï¼Ÿé»æ­¤ç™»å…¥'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 4. BarcodeScanner çµ„ä»¶
        // ----------------------------------------------------------------------
        const BarcodeScanner = ({ onDetected }) => {
            const [error, setError] = useState(null);
            const scannerRef = React.useRef(null);

            useEffect(() => {
                if (!Quagga) return;

                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: scannerRef.current,
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment" 
                        },
                    },
                    decoder: {
                        readers: ["ean_reader", "upc_reader", "code_128_reader", "code_39_reader"]
                    },
                }, (err) => {
                    if (err) {
                        setError(`ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: ${err.message}`);
                        return;
                    }
                    Quagga.start();
                });

                Quagga.onDetected((data) => {
                    if (data && data.codeResult && data.codeResult.code) {
                        onDetected(data.codeResult.code);
                        Quagga.stop();
                    }
                });

                return () => {
                    Quagga.stop();
                };
            }, [onDetected]);

            return (
                <div className="relative">
                    {error ? (
                        <div className="p-4 text-center text-red-600 bg-red-50">{error}</div>
                    ) : (
                        <div id="interactive" className="viewport" ref={scannerRef}>
                            <div className="laser-box"></div>
                        </div>
                    )}
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 5. å–®ç­†äº¤æ˜“ç·¨è¼¯/åˆªé™¤çµ„ä»¶ (TransactionRow)
        // ----------------------------------------------------------------------
        const TransactionRow = ({ record, onUpdated, userId, supportedCurrencies }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editData, setEditData] = useState({
                price: record.price || 0,
                currency: record.currency || 'HKD',
                store: record.store || '', 
                quantity: Math.abs(record.quantity),
            });
            const [saving, setSaving] = useState(false);
            const [message, setMessage] = useState('');

            const isPurchase = record.type === 'PURCHASE';
            const tableName = isPurchase ? 'inventory_items' : 'stock_outs';

            // è™•ç†å„²å­˜å–®ç­†ç´€éŒ„
            const handleSave = async () => {
                if (isPurchase && (editData.price < 0 || !editData.currency)) {
                    setMessage('å–®åƒ¹èˆ‡è²¨å¹£ç‚ºå¿…å¡«');
                    return;
                }
                if (!isPurchase && (editData.quantity <= 0)) {
                    setMessage('å‡ºåº«æ•¸é‡å¿…é ˆå¤§æ–¼ 0');
                    return;
                }
                setSaving(true);
                setMessage('');
                try {
                    const updateObj = isPurchase
                        ? {
                            price: parseFloat(editData.price),
                            currency: editData.currency.toUpperCase().trim(),
                            store: editData.store.trim() || null,
                          }
                        : { quantity: parseInt(editData.quantity) };
                    
                    const { error } = await supabaseClient
                        .from(tableName) 
                        .update(updateObj)
                        .eq('id', record.id)
                        .eq('user_id', userId); 

                    if (error) throw error;
                    setMessage('å·²æ›´æ–°ï¼');
                    setIsEditing(false);
                    onUpdated?.(); 
                } catch (error) { 
                    console.error(error);
                    setMessage('æ›´æ–°å¤±æ•—');
                } finally {
                    setSaving(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };

            // è™•ç†åˆªé™¤å–®ç­†ç´€éŒ„
            const handleDelete = async () => {
                if (!window.confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™ç­†${isPurchase ? 'è³¼å…¥' : 'å‡ºåº«'}ç´€éŒ„å—ï¼Ÿ`)) return;
                setSaving(true);
                setMessage('');
                try {
                    const { error } = await supabaseClient
                        .from(tableName) 
                        .delete()
                        .eq('id', record.id)
                        .eq('user_id', userId);

                    if (error) throw error;
                    setMessage('å·²åˆªé™¤ï¼');
                    onUpdated?.();
                } catch (error) { 
                    console.error(error);
                    setMessage('åˆªé™¤å¤±æ•—');
                } finally {
                    setSaving(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };

            if (isEditing) {
                return (
                    <tr className="bg-yellow-50">
                        <td className="px-4 py-2"><span className={`px-2 py-1 text-xs rounded-full ${isPurchase ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{isPurchase ? 'è³¼å…¥' : 'å‡ºåº«'}</span></td>
                        <td className="px-4 py-2">
                            {isPurchase ? '+1' : (
                                <input type="number" min="1" value={editData.quantity} onChange={e => setEditData({ ...editData, quantity: e.target.value })} className="w-20 px-2 py-1 border rounded" />
                            )}
                        </td>
                        <td className="px-4 py-2">
                            {isPurchase ? (
                                <input type="number" step="0.01" value={editData.price} onChange={e => setEditData({ ...editData, price: e.target.value })} className="w-24 px-2 py-1 border rounded" />
                            ) : '-'}
                        </td>
                        <td className="px-4 py-2">
                            {isPurchase ? (
                                <select value={editData.currency} onChange={e => setEditData({ ...editData, currency: e.target.value })} className="px-2 py-1 border rounded text-sm">
                                    {supportedCurrencies.map(code => (<option key={code} value={code}>{code}</option>))}
                                </select>
                            ) : '-'}
                        </td>
                        <td className="px-4 py-2">
                            {isPurchase ? (
                                <input type="text" value={editData.store} onChange={e => setEditData({ ...editData, store: e.target.value })} className="w-full px-2 py-1 border rounded" placeholder="åº—åæˆ–å…¶ä»–å‚™è¨»" />
                            ) : record.store}
                        </td>
                        <td className="px-4 py-2 text-xs text-gray-500">{formatTimestamp(record.created_at)}</td>
                        <td className="px-4 py-2 text-xs">
                            <div className="flex items-center gap-2">
                                <button onClick={handleSave} disabled={saving} className="text-green-600 font-bold hover:text-green-800">å„²å­˜</button>
                                <button onClick={() => setIsEditing(false)} className="text-gray-500 hover:text-gray-700">å–æ¶ˆ</button>
                            </div>
                            {message && <span className="block text-xs mt-1 text-green-600">{message}</span>}
                        </td>
                    </tr>
                );
            }

            // ä¸€èˆ¬é¡¯ç¤ºæ¨¡å¼
            return (
                <tr className="hover:bg-gray-50">
                    <td className="px-4 py-2">
                        <span className={`px-2 py-1 text-xs rounded-full ${isPurchase ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                            {isPurchase ? 'è³¼å…¥' : 'å‡ºåº«'}
                        </span>
                    </td>
                    <td className={`px-4 py-2 font-semibold ${record.type === 'PURCHASE' ? 'text-green-700' : 'text-red-700'}`}>
                        {record.type === 'PURCHASE' ? '+1' : `-${record.quantity}`}
                    </td>
                    <td className="px-4 py-2">
                        {record.type === 'PURCHASE' ? (
                            record.price > 0 ? (
                                <span className="font-medium text-green-700">
                                    {formatCurrency(record.price, record.currency)}
                                </span>
                            ) : (
                                <span className="text-purple-600 font-medium">è´ˆå“</span>
                            )
                        ) : (
                            <span className="text-gray-400">-</span>
                        )}
                    </td>
                    <td className="px-4 py-2">{record.currency || '-'}</td>
                    <td className="px-4 py-2">{record.store || '-'}</td>
                    <td className="px-4 py-2 text-xs text-gray-500">{formatTimestamp(record.created_at)}</td>
                    <td className="px-4 py-2 text-xs">
                        <div className="flex items-center gap-3">
                            <button
                                onClick={() => setIsEditing(true)}
                                className="text-blue-600 hover:text-blue-800 font-medium"
                            >
                                ç·¨è¼¯
                            </button>
                            <button
                                onClick={handleDelete}
                                className="text-red-600 hover:text-red-800 font-medium"
                            >
                                åˆªé™¤
                            </button>
                        </div>
                    </td>
                </tr>
            );
        };

        // ----------------------------------------------------------------------
        // 6.1. å¿«é€Ÿå–è²¨/å‡ºåº«é¢æ¿ (QuickStockOutPanel)
        // ----------------------------------------------------------------------
        const QuickStockOutPanel = ({ item, currentStock, userId, refreshData }) => {
            const [takeOutQuantity, setTakeOutQuantity] = useState(1);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            const handleTakeOut = async () => {
                const qty = parseInt(takeOutQuantity, 10);
                if (isNaN(qty) || qty <= 0) {
                    setMessage('è«‹è¼¸å…¥æ­£ç¢ºçš„æ•¸é‡');
                    return;
                }
                if (qty > currentStock) {
                    setMessage(`å‡ºåº«æ•¸é‡ä¸èƒ½å¤§æ–¼ç›®å‰åº«å­˜ ${currentStock} ä»¶`);
                    return;
                }

                setLoading(true);
                setMessage('');
                try {
                    const newStockOut = {
                        user_id: userId,
                        barcode: item.barcode,
                        name: item.name,
                        quantity: qty,
                    };

                    const { error } = await supabaseClient
                        .from('stock_outs') 
                        .insert([newStockOut]);

                    if (error) throw error;

                    setMessage(`æˆåŠŸå‡ºåº« ${qty} ä»¶ï¼`);
                    setTakeOutQuantity(1);
                    refreshData?.();
                    
                } catch (error) { 
                    console.error("Supabase Stock Out Error:", error);
                    setMessage('å‡ºåº«å¤±æ•—');
                } finally {
                    setLoading(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };
            
            return (
                <div className="p-4 bg-red-50 border border-red-200 rounded-lg shadow-sm">
                    <h4 className="text-lg font-semibold text-red-700 mb-3">ğŸ“¦ å¿«é€Ÿå–è²¨ / å‡ºåº«</h4>
                    <div className="flex items-center gap-4">
                        <input
                            type="number"
                            min="1"
                            max={currentStock}
                            value={takeOutQuantity}
                            onChange={(e) => setTakeOutQuantity(Math.max(1, parseInt(e.target.value) || 1))}
                            className="w-24 p-2 border border-red-300 rounded-lg text-center"
                            disabled={currentStock <= 0}
                        />
                        <button
                            onClick={handleTakeOut}
                            disabled={loading || currentStock <= 0 || takeOutQuantity > currentStock}
                            className="flex-grow py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-300 disabled:opacity-50"
                        >
                            {loading ? 'è™•ç†ä¸­...' : `å–è²¨å‡ºåº« (${currentStock} å‰©é¤˜)`}
                        </button>
                    </div>
                    {message && <p className={`mt-2 text-sm ${message.includes('æˆåŠŸ') ? 'text-green-700' : 'text-red-700'}`}>{message}</p>}
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 6.2. å¿«é€Ÿè£œè²¨/å…¥åº«é¢æ¿ (QuickStockInPanel)
        // ----------------------------------------------------------------------
        const QuickStockInPanel = ({ item, settings, userId, refreshData, supportedCurrencies, exchangeRates }) => {
            const [addQuantity, setAddQuantity] = useState(1);
            const [priceInput, setPriceInput] = useState(''); 
            const [priceMode, setPriceMode] = useState('unit'); 
            
            const [addCurrency, setAddCurrency] = useState(settings.currency);
            const [addStore, setAddStore] = useState(''); 
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            // æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®—å–®ä»¶åƒ¹æ ¼ (ç”¨æ–¼æ•¸æ“šåº«å„²å­˜)
            const calculateUnitPrice = () => {
                const input = parseFloat(priceInput) || 0;
                const qty = parseInt(addQuantity, 10) || 1;
                
                if (priceMode === 'unit') {
                    return input;
                } else {
                    return input / qty;
                }
            };
            
            const unitPrice = calculateUnitPrice();
            const isValidPrice = unitPrice >= 0 && !isNaN(unitPrice) && priceInput !== '';

            // æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®— itemCurrency åˆ° EUR çš„åŒ¯ç‡ (ç”¨æ–¼å­˜å„² historical rate)
            const getRateToEur = (currency) => {
                if (!exchangeRates || !exchangeRates[currency] || currency === 'EUR') return currency === 'EUR' ? 1 : 0;
                // rate to EUR = 1 / rate EUR to X
                return 1 / exchangeRates[currency];
            };


            const handleAddStock = async () => {
                const qty = parseInt(addQuantity, 10);
                if (isNaN(qty) || qty <= 0 || !isValidPrice || !addCurrency) {
                    setMessage('è«‹æª¢æŸ¥æ•¸é‡ã€åƒ¹æ ¼å’Œè²¨å¹£æ˜¯å¦å¡«å¯«æ­£ç¢º');
                    return;
                }
                
                // è¨ˆç®—ä¸¦å„²å­˜ historical rate
                const rateToEur = getRateToEur(addCurrency);
                if (rateToEur === 0) {
                    setMessage(`ç„¡æ³•ç²å– ${addCurrency} çš„å³æ™‚åŒ¯ç‡ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥APIã€‚`);
                    return;
                }


                setLoading(true);
                setMessage('');
                
                const itemTemplate = {
                    user_id: userId,
                    name: item.name,
                    barcode: item.barcode,
                    category: item.category, 
                    price: unitPrice, 
                    currency: addCurrency, 
                    store: addStore.trim() || null, 
                    rate_to_base_currency: rateToEur, // ğŸ“Œ æ–°å¢æ¬„ä½ï¼šå„²å­˜ç•¶å‰åŒ¯ç‡
                };

                try {
                    const itemsToInsert = Array.from({ length: qty }, () => ({
                        ...itemTemplate
                    }));

                    const { error } = await supabaseClient
                        .from('inventory_items') 
                        .insert(itemsToInsert);

                    if (error) throw error;

                    setMessage(`æˆåŠŸè£œè²¨ ${qty} ä»¶ï¼`);
                    setAddQuantity(1);
                    setPriceInput(''); 
                    setPriceMode('unit'); 
                    setAddStore('');
                    refreshData?.();
                } catch (error) { 
                    console.error("Supabase Insert Error:", error);
                    setMessage('è£œè²¨å¤±æ•—');
                } finally {
                    setLoading(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };

            return (
                <div className="p-4 bg-green-50 border border-green-200 rounded-lg shadow-sm">
                    <h4 className="text-lg font-semibold text-green-700 mb-3">ğŸ›’ å¿«é€Ÿè£œè²¨ / å…¥åº«</h4>
                    
                    <div className="grid grid-cols-1 sm:grid-cols-4 gap-2 mb-3">
                        {/* æ•¸é‡ */}
                        <div>
                            <label className="block text-xs font-medium text-gray-700">æ•¸é‡*</label>
                            <input
                                type="number"
                                min="1"
                                value={addQuantity}
                                onChange={(e) => setAddQuantity(Math.max(1, parseInt(e.target.value) || 1))}
                                className="w-full p-1 border border-green-300 rounded-lg text-center"
                            />
                        </div>
                        {/* è¼¸å…¥æ¨¡å¼ */}
                        <div className="col-span-1 sm:col-span-2"> 
                            <label className="block text-xs font-medium text-gray-700">è¼¸å…¥æ¨¡å¼ / åƒ¹æ ¼*</label>
                            <div className="flex gap-1">
                                <select
                                    value={priceMode}
                                    onChange={(e) => setPriceMode(e.target.value)}
                                    className="w-1/3 p-1 border border-green-300 rounded-l-lg text-xs"
                                >
                                    <option value="unit">å–®ä»¶åƒ¹</option>
                                    <option value="total">ç¸½åƒ¹</option>
                                </select>
                                {/* åƒ¹æ ¼ */}
                                <input
                                    type="number"
                                    step="0.01"
                                    value={priceInput}
                                    onChange={(e) => setPriceInput(e.target.value)}
                                    className={`w-2/3 p-1 border rounded-r-lg text-center text-xs ${isValidPrice ? 'border-green-300' : 'border-red-400'}`}
                                    placeholder="0.00"
                                />
                            </div>
                        </div>
                        {/* è²¨å¹£ */}
                        <div>
                            <label className="block text-xs font-medium text-gray-700">è²¨å¹£*</label>
                            <select
                                value={addCurrency}
                                onChange={(e) => setAddCurrency(e.target.value)}
                                className="w-full p-1 border border-green-300 rounded-lg text-xs"
                            >
                                {supportedCurrencies.map(code => (
                                    <option key={code} value={code}>{code}</option>
                                ))}
                            </select>
                        </div>
                         {/* å‚™è¨»/åº—å */}
                        <div className="col-span-2"> 
                            <label className="block text-xs font-medium text-gray-700">å‚™è¨»/åº—å</label>
                            <input
                                type="text"
                                value={addStore}
                                onChange={(e) => setAddStore(e.target.value)}
                                className="w-full p-1 border border-green-300 rounded-lg text-xs"
                                placeholder="å¯é¸"
                            />
                        </div>
                        {/* è¨ˆç®—å¾Œçš„å–®ä»¶åƒ¹ (è¼”åŠ©è³‡è¨Š) */}
                        <div className="col-span-2 flex items-center">
                            <p className="text-xs text-gray-600 mt-1">
                                 å–®ä»¶åƒ¹: **{formatCurrency(unitPrice, addCurrency)}**
                            </p>
                        </div>

                    </div>

                    <button
                        onClick={handleAddStock}
                        disabled={loading || !isValidPrice || addQuantity <= 0}
                        className="w-full py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-300 disabled:opacity-50 text-sm"
                    >
                        {loading ? 'è™•ç†ä¸­...' : 'ç¢ºèªè£œè²¨å…¥åº«'}
                    </button>
                    {message && <p className={`mt-2 text-sm ${message.includes('æˆåŠŸ') ? 'text-green-700' : 'text-red-700'}`}>{message}</p>}
                </div>
            );
        };
        

        // ----------------------------------------------------------------------
        // 7. è©³ç´°æ˜ç´°å½ˆçª— (DetailModal) - å®Œæ•´å¯¦ä½œç·¨è¼¯/åˆªé™¤é‚è¼¯
        // ----------------------------------------------------------------------
        const DetailModal = ({ item, inventory, stockOuts, onClose, settings, userId, refreshData, supportedCurrencies, exchangeRates }) => {
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            const [isEditingName, setIsEditingName] = useState(false);
            const [isEditingBarcode, setIsEditingBarcode] = useState(false);
            const [isEditingCategory, setIsEditingCategory] = useState(false);
            const [editName, setEditName] = useState(item.name);
            const [editBarcode, setEditBarcode] = useState(item.barcode);
            const [editCategory, setEditCategory] = useState(item.category);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);

            // äº¤æ˜“æ­·å²è¨˜éŒ„ 
            const transactionHistory = useMemo(() => {
                const purchases = inventory
                    .filter(rec => rec.barcode === item.barcode)
                    .map(rec => ({
                        id: rec.id, type: 'PURCHASE', quantity: 1, price: rec.price, currency: rec.currency, store: rec.store, created_at: rec.created_at,
                    }));
                const stockOutsForBarcode = stockOuts
                    .filter(out => out.barcode === item.barcode)
                    .map(out => ({
                        id: out.id, type: 'STOCK_OUT', quantity: out.quantity, price: 0, currency: settings.currency, store: out.store, created_at: out.created_at,
                    }));
                
                // åˆä½µä¸¦æŒ‰æ™‚é–“é™åºæ’åˆ— (Supabase ä½¿ç”¨ created_at)
                return [...purchases, ...stockOutsForBarcode].sort((a, b) => {
                    return new Date(b.created_at) - new Date(a.created_at);
                });
            }, [inventory, stockOuts, item.barcode, settings.currency]);


            // --- ç·¨è¼¯/åˆªé™¤é‚è¼¯ ---
            
            const handleUpdateField = async (field, value, setIsEditing) => {
                if (value.trim() === item[field]) {
                    setIsEditing(false);
                    return;
                }
                
                // ç‚ºäº†åŸå­æ€§ï¼Œæˆ‘å€‘åªéœ€è¦æ›´æ–° inventory_itemsï¼Œå› ç‚º stock_outs ä¸­åªæœ‰ name æ˜¯å†—é¤˜å­—æ®µ
                const targetTable = field === 'category' ? 'inventory_items' : 'inventory_items'; // æ¢ç¢¼éœ€è¦åŒæ™‚æ›´æ–°å…©é‚Š
                
                setLoading(true);
                setMessage('');

                try {
                    // 1. æ›´æ–° inventory_items
                    const { error: invError } = await supabaseClient
                        .from('inventory_items')
                        .update({ [field]: value.trim() })
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);

                    if (invError) throw invError;
                    
                    // 2. å¦‚æœæ˜¯æ›´æ–° barcode æˆ– nameï¼Œä¹Ÿæ›´æ–° stock_outs
                    if (field === 'barcode' || field === 'name') {
                        const updateObj = { [field]: value.trim() };
                        const matchField = field === 'barcode' ? 'barcode' : 'name';

                        const { error: outError } = await supabaseClient
                            .from('stock_outs')
                            .update(updateObj)
                            .eq(matchField, item.barcode) // ä½¿ç”¨èˆŠçš„ barcode æŸ¥æ‰¾
                            .eq('user_id', userId);
                        
                        if (outError) console.warn("Stock outs update warning:", outError);
                    }


                    setMessage(`å·²æˆåŠŸæ›´æ–° ${field === 'name' ? 'åç¨±' : field === 'barcode' ? 'æ¢ç¢¼' : 'åˆ†é¡'}ï¼`);
                    setIsEditing(false);
                    refreshData(); // é‡æ–°è¼‰å…¥æ•¸æ“šä»¥æ›´æ–°ç¸½è¦½
                } catch (error) {
                    console.error("Update failed:", error);
                    setMessage(`æ›´æ–°å¤±æ•—: ${error.message}`);
                } finally {
                    setLoading(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };

            const handleUpdateName = () => handleUpdateField('name', editName, setIsEditingName);
            const handleUpdateBarcode = () => handleUpdateField('barcode', editBarcode, setIsEditingBarcode);
            const handleUpdateCategory = () => handleUpdateField('category', editCategory, setIsEditingCategory);


            // è™•ç†åˆªé™¤æ­¤æ¢ç¢¼ä¸‹çš„æ‰€æœ‰ç´€éŒ„
            const handleDeleteAll = async () => {
                if (!showDeleteConfirm) {
                    setShowDeleteConfirm(true);
                    return;
                }
                
                setLoading(true);
                setMessage('');

                try {
                    // 1. åˆªé™¤æ‰€æœ‰å…¥åº«ç´€éŒ„
                    const { error: invError } = await supabaseClient
                        .from('inventory_items')
                        .delete()
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);

                    if (invError) throw invError;

                    // 2. åˆªé™¤æ‰€æœ‰å‡ºåº«ç´€éŒ„
                    const { error: outError } = await supabaseClient
                        .from('stock_outs')
                        .delete()
                        .eq('barcode', item.barcode)
                        .eq('user_id', userId);

                    if (outError) console.warn("Stock outs deletion warning:", outError);

                    setMessage('æ­¤æ¢ç¢¼æ‰€æœ‰ç´€éŒ„å·²æ°¸ä¹…åˆªé™¤ï¼');
                    onClose(); // é—œé–‰æ¨¡æ…‹æ¡†
                    refreshData(); // é‡æ–°è¼‰å…¥ç¸½è¦½æ•¸æ“š
                } catch (error) {
                    console.error("Deletion failed:", error);
                    setMessage(`åˆªé™¤å¤±æ•—: ${error.message}`);
                } finally {
                    setLoading(false);
                    setShowDeleteConfirm(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };
            

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            
                            {/* é ‚éƒ¨æ¨™é¡Œèˆ‡æ§åˆ¶é … */}
                            <div className="flex justify-between items-start border-b pb-4 mb-4">
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-800">
                                        é …ç›®æ˜ç´°ï¼š
                                        {isEditingName ? (
                                            <input 
                                                value={editName} 
                                                onChange={(e) => setEditName(e.target.value)}
                                                onBlur={handleUpdateName}
                                                onKeyDown={(e) => {if (e.key === 'Enter') handleUpdateName()}}
                                                className="border-b border-blue-500 p-1 text-xl font-bold inline-block w-60"
                                                autoFocus
                                            />
                                        ) : (
                                            <span 
                                                className="cursor-pointer hover:bg-yellow-100 p-1 rounded transition"
                                                onClick={() => {setEditName(item.name); setIsEditingName(true);}}
                                            >
                                                {item.name}
                                            </span>
                                        )}
                                    </h2>
                                    <p className="text-sm text-gray-600 mt-1">
                                        æ¢ç¢¼: 
                                        {isEditingBarcode ? (
                                            <input 
                                                value={editBarcode} 
                                                onChange={(e) => setEditBarcode(e.target.value)}
                                                onBlur={handleUpdateBarcode}
                                                onKeyDown={(e) => {if (e.key === 'Enter') handleUpdateBarcode()}}
                                                className="border-b border-blue-500 p-1 text-sm inline-block w-40"
                                                autoFocus
                                            />
                                        ) : (
                                            <span 
                                                className="cursor-pointer hover:bg-yellow-100 p-1 rounded transition"
                                                onClick={() => {setEditBarcode(item.barcode); setIsEditingBarcode(true);}}
                                            >
                                                {item.barcode}
                                            </span>
                                        )}
                                    </p>
                                </div>
                                <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-3xl leading-none">Ã—</button>
                            </div>

                            {message && (
                                <p className={`mb-4 p-3 text-sm rounded-lg ${message.includes('æˆåŠŸ') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {message}
                                </p>
                            )}
                            
                            {/* ç¸½è¦½è³‡è¨Šå€å¡Š */}
                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 text-center">
                                <div className="p-4 bg-blue-50 rounded-lg">
                                    <p className="text-xs text-gray-600">ç¾æœ‰åº«å­˜</p>
                                    <p className="text-2xl font-bold text-blue-800">{item.currentStock}</p>
                                </div>
                                <div className="p-4 bg-green-50 rounded-lg">
                                    <p className="text-xs text-gray-600">
                                        å¹³å‡è³¼å…¥åƒ¹ ({settings.currency}) 
                                        <span className="block font-normal italic text-gray-500">
                                            ({settings.use_realtime_rate ? 'å³æ™‚åŒ¯ç‡' : 'è³¼å…¥æ™‚åŒ¯ç‡'})
                                        </span>
                                    </p>
                                    <p className="text-xl font-bold text-green-800">{formatCurrency(item.avgPurchasePrice, settings.currency)}</p>
                                </div>
                                <div className="p-4 bg-gray-50 rounded-lg flex flex-col justify-center">
                                    <p className="text-xs text-gray-600">åˆ†é¡</p>
                                    {isEditingCategory ? (
                                        <select
                                            value={editCategory}
                                            onChange={(e) => setEditCategory(e.target.value)}
                                            onBlur={handleUpdateCategory}
                                            className="mt-1 p-1 border border-blue-500 rounded text-center text-md font-bold"
                                            autoFocus
                                        >
                                            {settings.categories.map(cat => (
                                                <option key={cat} value={cat}>{cat}</option>
                                            ))}
                                        </select>
                                    ) : (
                                        <p 
                                            className="text-xl font-bold text-gray-800 cursor-pointer hover:bg-yellow-100 p-1 rounded transition"
                                            onClick={() => {setEditCategory(item.category); setIsEditingCategory(true);}}
                                        >
                                            {item.category}
                                        </p>
                                    )}
                                </div>
                            </div>
                            
                            {/* å¿«é€Ÿå–è²¨èˆ‡è£œè²¨é¢æ¿ */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                                <QuickStockOutPanel 
                                    item={item} 
                                    currentStock={item.currentStock} 
                                    userId={userId} 
                                    refreshData={refreshData}
                                />
                                <QuickStockInPanel
                                    item={item}
                                    settings={settings}
                                    userId={userId}
                                    refreshData={refreshData}
                                    supportedCurrencies={supportedCurrencies} 
                                    exchangeRates={exchangeRates} // ğŸ“Œ å‚³éå³æ™‚åŒ¯ç‡
                                />
                            </div>

                            <h3 className="text-xl font-semibold mb-3 border-b pb-2 text-gray-700">äº¤æ˜“æ­·å²è¨˜éŒ„</h3>
                            
                            {/* äº¤æ˜“æ˜ç´°è¡¨æ ¼ */}
                            <div className="overflow-x-auto border rounded-lg">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">é¡å‹</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ•¸é‡</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å–®åƒ¹/æˆæœ¬</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">è²¨å¹£</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å‚™è¨»/åº—å</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ™‚é–“</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {transactionHistory.length === 0 ? (
                                            <tr><td colSpan="7" className="px-6 py-4 text-center text-gray-500">ç„¡è©³ç´°äº¤æ˜“è¨˜éŒ„ã€‚</td></tr>
                                        ) : (
                                            transactionHistory.map((record) => (
                                                <TransactionRow 
                                                    key={record.id} 
                                                    record={record} 
                                                    onUpdated={refreshData} 
                                                    userId={userId}
                                                    supportedCurrencies={supportedCurrencies} 
                                                />
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* åº•éƒ¨æ“ä½œæŒ‰éˆ• */}
                        <div className="p-4 bg-gray-50 border-t flex justify-between items-center">
                            <button
                                onClick={handleDeleteAll}
                                disabled={loading}
                                className={`px-4 py-2 text-white font-semibold rounded-lg transition duration-300 disabled:opacity-50 text-sm ${showDeleteConfirm ? 'bg-red-700 hover:bg-red-800' : 'bg-red-500 hover:bg-red-600'}`}
                            >
                                {showDeleteConfirm ? 'é»æ“Šå†æ¬¡ç¢ºèªæ°¸ä¹…åˆªé™¤æ‰€æœ‰ç´€éŒ„' : 'æ°¸ä¹…åˆªé™¤æ­¤æ¢ç¢¼æ‰€æœ‰ç´€éŒ„'}
                            </button>
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-300"
                            >
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 8. æ‡‰ç”¨ç¨‹å¼ä¸»é«”ï¼šApp çµ„ä»¶ (ä¿®æ­£åŒ¯ç‡ç²å–é‚è¼¯)
        // ----------------------------------------------------------------------
        const App = () => {
            // --- ç‹€æ…‹ Hooks ---
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('inventory'); 

            // Data States
            const [inventory, setInventory] = useState([]); 
            const [stockOuts, setStockOuts] = useState([]);
            const [settings, setSettings] = useState(null); 
            const [selectedItem, setSelectedItem] = useState(null); 
            const [exchangeRates, setExchangeRates] = useState(null); 
            const [supportedCurrencies, setSupportedCurrencies] = useState([]); 
            const [rateError, setRateError] = useState(null);

            const userId = session?.user?.id || null;
            
            // è™•ç†è³‡æ–™ç²å–å’Œè¨‚é–±çš„å‡½å¼ (useCallback)
            const fetchInitialData = useCallback(async () => {
                if (!userId) return;
                
                // 1. Fetch Settings (å¿…é ˆå…ˆåŸ·è¡Œï¼Œä»¥ç²å–ç›®æ¨™è²¨å¹£å’Œæ–°è¨­å®š)
                let currentSettings = null;
                const { data: settingsData, error: settingsError } = await supabaseClient
                    .from('user_settings') 
                    .select('*')
                    .eq('user_id', userId)
                    .maybeSingle(); 
                    
                if (settingsError && settingsError.code !== 'PGRST116') { 
                        console.error("Error fetching settings:", settingsError);
                } else if (settingsData) {
                    let categoriesArray = settingsData.categories;
                    if (typeof categoriesArray === 'string') {
                        categoriesArray = categoriesArray.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    }
                    // ğŸ“Œ æ–°å¢ï¼šuse_realtime_rate é è¨­ç‚º true
                    currentSettings = { 
                        ...settingsData, 
                        categories: categoriesArray || [],
                        // ç¢ºä¿æ–°æ¬„ä½æœ‰é è¨­å€¼ï¼Œå³ä½¿æ•¸æ“šåº«ä¸­ä¸å­˜åœ¨
                        use_realtime_rate: settingsData.use_realtime_rate !== undefined ? settingsData.use_realtime_rate : true,
                    };
                    setSettings(currentSettings);
                } else {
                    // é è¨­è¨­å®š
                    currentSettings = { 
                        categories: ['é›»å­ç”¢å“', 'æœè£', 'é£Ÿå“', 'æ›¸ç±', 'å…¶ä»–'], 
                        currency: 'HKD', 
                        user_id: userId,
                        use_realtime_rate: true, // ğŸ“Œ é è¨­ç‚ºå³æ™‚åŒ¯ç‡
                    };
                    setSettings(currentSettings);
                }

                // 2. Fetch Exchange Rates and Supported Currencies
                let supportedCodes = [];
                let rates = null;
                const fallbackCurrencies = ['USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'HKD', 'TWD', 'CNY', 'VND', 'SGD']; 
                
                try {
                    // 2a. Fetch the full list of currencies (for dropdowns)
                    const currencyResponse = await fetch(`${FRANKFURTER_API}/currencies`);
                    if (!currencyResponse.ok) throw new Error(`HTTP error! status: ${currencyResponse.status}`);
                    const currencyData = await currencyResponse.json(); 
                    supportedCodes = Object.keys(currencyData).sort();
                    setSupportedCurrencies(supportedCodes); 
                    
                    // 2b. Fetch all latest rates (for conversion)
                    const rateUrl = `${FRANKFURTER_API}/latest?from=EUR`; 
                    const rateResponse = await fetch(rateUrl);
                    if (!rateResponse.ok) throw new Error(`HTTP error! status: ${rateResponse.status}`);
                    const rateData = await rateResponse.json();
                    
                    rates = { ...rateData.rates, EUR: 1 };
                    setExchangeRates(rates);
                    setRateError(null);
                } catch (error) {
                    console.error("Error fetching exchange data:", error);
                    setRateError("ç„¡æ³•ç²å–å³æ™‚åŒ¯ç‡æˆ–è²¨å¹£åˆ—è¡¨ï¼Œæˆæœ¬è¨ˆç®—å’Œå…¥åº«æ“ä½œå¯èƒ½ä¸æº–ç¢ºã€‚");
                    setExchangeRates({}); 
                    setSupportedCurrencies(fallbackCurrencies); 
                }
                
                // 3. Fetch Inventory Items
                const { data: invData, error: invError } = await supabaseClient
                    .from('inventory_items') 
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false }); 
                if (invError) console.error("Error fetching inventory:", invError);
                else setInventory(invData);

                // 4. Fetch Stock Outs
                const { data: outData, error: outError } = await supabaseClient
                    .from('stock_outs') 
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });
                if (outError) console.error("Error fetching stock outs:", outError);
                else setStockOuts(outData);

            }, [userId]);


            // 1. Supabase èº«ä»½é©—è­‰ç›£è½ (useEffect)
            useEffect(() => {
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    setLoading(false);
                });

                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(
                    (_event, session) => {
                        setSession(session);
                        setLoading(false);
                    }
                );

                return () => subscription.unsubscribe();
            }, []);


            // 2. Supabase å³æ™‚æ•¸æ“šè¨‚é–±/åˆå§‹è¼‰å…¥ (useEffect)
            useEffect(() => {
                if (!userId) return;

                fetchInitialData();

                // Setup Realtime Subscriptions (ä¾è³´ fetchInitialData)
                const inventorySubscription = supabaseClient
                    .channel('inventory_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'inventory_items', filter: `user_id=eq.${userId}` }, 
                        (payload) => {
                             fetchInitialData(); 
                        }
                    )
                    .subscribe();

                const stockOutsSubscription = supabaseClient
                    .channel('stock_outs_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'stock_outs', filter: `user_id=eq.${userId}` }, 
                        (payload) => {
                             fetchInitialData(); 
                        }
                    )
                    .subscribe();

                const settingsSubscription = supabaseClient
                    .channel('settings_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'user_settings', filter: `user_id=eq.${userId}` }, 
                        (payload) => {
                             fetchInitialData(); 
                        }
                    )
                    .subscribe();

                return () => {
                    supabaseClient.removeChannel(inventorySubscription);
                    supabaseClient.removeChannel(stockOutsSubscription);
                    supabaseClient.removeChannel(settingsSubscription);
                };
            }, [userId, fetchInitialData]); 

            // --- æ´¾ç”Ÿç‹€æ…‹ Hooks ---
            // èšåˆæ•¸æ“šï¼šä½¿ç”¨ settings.currency å’Œ exchangeRates é€²è¡Œè½‰æ›
            const overviewData = useMemo(() => {
                if (!settings || !exchangeRates) return [];
                const targetCurrency = settings.currency;
                const useRealtimeRate = settings.use_realtime_rate; // ğŸ“Œ æ–°å¢ï¼šè®€å–è¨­å®š
                
                return aggregateInventoryData(inventory, stockOuts, targetCurrency, exchangeRates, useRealtimeRate); // ğŸ“Œ å‚³éæ–°è¨­å®š
            }, [inventory, stockOuts, settings, exchangeRates]);

            // å°‹æ‰¾é¸ä¸­çš„é …ç›®
            const currentSelectedItem = useMemo(() => {
                if (!selectedItem) return null;
                const latestItem = overviewData.find(item => item.barcode === selectedItem.barcode);
                return latestItem || selectedItem;
            }, [selectedItem, overviewData]);


            const handleLogout = async () => {
                await supabaseClient.auth.signOut();
            };

            // --- æ¢ä»¶æ¸²æŸ“ (åœ¨ Hooks èª¿ç”¨ä¹‹å¾Œ) ---
            if (loading || !settings) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
                        <p className="ml-4 text-gray-700">è¼‰å…¥ä¸­...</p>
                    </div>
                );
            }

            if (!session) {
                return <AuthForm supabaseClient={supabaseClient} />;
            }
            
            // ----------------------------------------------------------------------
            // 9. çµ„ä»¶ - åº«å­˜æ¦‚è¦½ (InventoryOverview)
            // ----------------------------------------------------------------------
            const InventoryOverview = ({ settings, overviewData, setSelectedItem, rateError }) => {
                const [filterText, setFilterText] = useState('');
                const [filterCategory, setFilterCategory] = useState('All'); 
                const [sortKey, setSortKey] = useState('currentStock');
                const [sortDirection, setSortDirection] = useState('desc');

                const categories = Array.isArray(settings.categories) ? settings.categories : (settings.categories || '').split(',').map(s => s.trim());
                
                const filteredAndSortedData = useMemo(() => {
                    let data = overviewData.filter(item => {
                        const textMatch = item.name.toLowerCase().includes(filterText.toLowerCase()) ||
                                          item.barcode.includes(filterText);
                        
                        const categoryMatch = filterCategory === 'All' || item.category === filterCategory;

                        return textMatch && categoryMatch;
                    });

                    data.sort((a, b) => {
                        const valA = a[sortKey];
                        const valB = b[sortKey];
                        let comparison = 0;

                        if (typeof valA === 'string') {
                            comparison = valA.localeCompare(valB);
                        } else {
                            comparison = valA - valB;
                        }

                        return sortDirection === 'asc' ? comparison : comparison * -1;
                    });
                    return data;
                }, [overviewData, filterText, sortKey, sortDirection, filterCategory]);

                const handleSort = (key) => {
                    if (sortKey === key) {
                        setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                    } else {
                        setSortKey(key);
                        setSortDirection('asc');
                    }
                };

                const getSortIndicator = (key) => {
                    if (sortKey === key) {
                        return sortDirection === 'asc' ? ' â–²' : ' â–¼';
                    }
                    return '';
                };
                
                // æ±ºå®šæˆæœ¬è¨ˆç®—æ¨¡å¼åç¨±
                const rateModeName = settings.use_realtime_rate ? 'å³æ™‚åŒ¯ç‡' : 'è³¼å…¥æ™‚åŒ¯ç‡';


                return (
                    <div className="space-y-6">
                        
                        {/* âš ï¸ åŒ¯ç‡éŒ¯èª¤æç¤º */}
                        {rateError && (
                            <div className="p-4 bg-yellow-100 text-yellow-800 rounded-lg border border-yellow-300 text-sm font-medium">
                                âš ï¸ {rateError} æ‚¨çš„æˆæœ¬è¨ˆç®—çµæœå¯èƒ½ä¸æº–ç¢ºã€‚
                            </div>
                        )}

                        <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-md">
                            <p className="text-sm font-medium text-gray-600">
                                æˆæœ¬è¨ˆç®—æ¨¡å¼: <span className="font-bold text-blue-700">{rateModeName}</span>
                            </p>
                            <div className="flex gap-4">
                                {/* åˆ†é¡ç¯©é¸å™¨ (Select) */}
                                <select
                                    value={filterCategory}
                                    onChange={(e) => setFilterCategory(e.target.value)}
                                    className="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                >
                                    <option value="All">æ‰€æœ‰åˆ†é¡</option>
                                    {categories.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                                <input
                                    type="text"
                                    placeholder="ğŸ” æœå°‹å“åæˆ–æ¢ç¢¼..."
                                    value={filterText}
                                    onChange={(e) => setFilterText(e.target.value)}
                                    className="p-2 border border-gray-300 rounded-lg w-64 focus:ring-blue-500 focus:border-blue-500"
                                />
                            </div>
                        </div>

                        <div className="overflow-x-auto bg-white rounded-xl shadow-md">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        {/* ä¿®æ­£æ¨™é¡Œä»¥é¡¯ç¤ºåŒ¯ç‡æ¨¡å¼ */}
                                        {['åç¨±', 'æ¢ç¢¼', 'é¡åˆ¥', 'ç¾æœ‰åº«å­˜', `å¹³å‡è³¼å…¥åƒ¹ (${settings.currency})`, `æœ€é«˜åƒ¹ (${settings.currency})`, `æœ€ä½åƒ¹ (${settings.currency})`].map((header, index) => {
                                            const keyMap = ['name', 'barcode', 'category', 'currentStock', 'avgPurchasePrice', 'maxPrice', 'minPrice'];
                                            const key = keyMap[index];
                                            
                                            const isNumeric = ['currentStock', 'avgPurchasePrice', 'maxPrice', 'minPrice'].includes(key);

                                            return (
                                                <th
                                                    key={key}
                                                    onClick={() => handleSort(key)}
                                                    className={`px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer transition duration-150 hover:bg-gray-100 ${isNumeric ? 'text-right' : ''}`}
                                                >
                                                    {header}
                                                    {getSortIndicator(key)}
                                                </th>
                                            );
                                        })}
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredAndSortedData.length === 0 ? (
                                        <tr>
                                            <td colSpan="7" className="px-6 py-4 text-center text-gray-500">
                                                {overviewData.length === 0 ? 'ç›®å‰æ²’æœ‰ä»»ä½•åº«å­˜é …ç›®ã€‚' : 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é …ç›®ã€‚'}
                                            </td>
                                        </tr>
                                    ) : (
                                        filteredAndSortedData.map((item) => (
                                            <tr key={item.barcode} className={`${item.currentStock === 0 ? 'bg-red-50 text-gray-500' : 'hover:bg-gray-50'}`}>
                                                <td 
                                                    className="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 hover:text-blue-800 cursor-pointer underline" 
                                                    onClick={() => setSelectedItem(item)} 
                                                >
                                                    {item.name}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.barcode}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.category}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm font-bold text-right ${item.currentStock === 0 ? 'text-red-600' : 'text-green-600'}`}>
                                                    {item.currentStock}
                                                </td>
                                                
                                                {/* å¹³å‡è³¼å…¥åƒ¹ (å·²è½‰æ›) */}
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800 text-right">
                                                    {formatCurrency(item.avgPurchasePrice, settings.currency)}
                                                </td>
                                                
                                                {/* æœ€é«˜åƒ¹ (å·²è½‰æ›) */}
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right">
                                                    {item.maxPrice > 0 ? formatCurrency(item.maxPrice, settings.currency) : '-'}
                                                </td>
                                                
                                                {/* æœ€ä½åƒ¹ (å·²è½‰æ›) */}
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right">
                                                    {item.minPrice > 0 ? formatCurrency(item.minPrice, settings.currency) : '-'}
                                                </td>
                                                
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            // ----------------------------------------------------------------------
            // 10. çµ„ä»¶ - æ–°å¢åŠ  (AddItemForm)
            // ----------------------------------------------------------------------
            const AddItemForm = ({ supabaseClient, userId, categories, defaultCurrency, onSuccess, supportedCurrencies, exchangeRates }) => {
                const [name, setName] = useState('');
                const [barcode, setBarcode] = useState('');
                const [category, setCategory] = useState(categories[0] || '');
                const [priceInput, setPriceInput] = useState(0); 
                const [priceMode, setPriceMode] = useState('unit'); 
                const [itemCurrency, setItemCurrency] = useState(defaultCurrency); 
                const [quantity, setQuantity] = useState(1);
                const [message, setMessage] = useState('');
                const [loading, setLoading] = useState(false);
                const [showScanner, setShowScanner] = useState(false);
                
                // ç¢ºä¿ category åˆ—è¡¨æœ€æ–°
                useEffect(() => {
                    if (categories.length > 0 && !categories.includes(category)) {
                        setCategory(categories[0]);
                    } else if (categories.length > 0 && category === '') {
                        setCategory(categories[0]);
                    }
                }, [categories, category]);

                // æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®—å–®ä»¶åƒ¹æ ¼ (ç”¨æ–¼æ•¸æ“šåº«å„²å­˜)
                const calculateUnitPrice = () => {
                    const input = parseFloat(priceInput) || 0;
                    const qty = parseInt(quantity, 10) || 1;
                    return priceMode === 'unit' ? input : input / qty;
                };

                // æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®— itemCurrency åˆ° EUR çš„åŒ¯ç‡ (ç”¨æ–¼å­˜å„² historical rate)
                const getRateToEur = (currency) => {
                    if (!exchangeRates || !exchangeRates[currency] || currency === 'EUR') return currency === 'EUR' ? 1 : 0;
                    // rate to EUR = 1 / rate EUR to X
                    return 1 / exchangeRates[currency];
                };


                const handleSubmit = async (e) => {
                    e.preventDefault();
                    
                    const unitPrice = calculateUnitPrice(); 
                    
                    if (!name || !barcode || quantity <= 0 || unitPrice < 0 || isNaN(unitPrice)) {
                        setMessage('è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½ä¸¦ç¢ºä¿æ•¸å€¼æ­£ç¢ºã€‚');
                        return;
                    }

                    // ğŸ“Œ æ–°å¢ï¼šç²å–è³¼å…¥æ™‚åŒ¯ç‡
                    const rateToEur = getRateToEur(itemCurrency);
                    if (rateToEur === 0) {
                        setMessage(`ç„¡æ³•ç²å– ${itemCurrency} çš„å³æ™‚åŒ¯ç‡ï¼Œå…¥åº«å¤±æ•—ã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ– APIã€‚`);
                        return;
                    }


                    setLoading(true);
                    setMessage('');
                    
                    const itemTemplate = {
                        user_id: userId,
                        name: name.trim(),
                        barcode: barcode.trim(),
                        category,
                        price: unitPrice, 
                        currency: itemCurrency, 
                        store: '', 
                        rate_to_base_currency: rateToEur, // ğŸ“Œ å„²å­˜è³¼å…¥æ™‚åŒ¯ç‡
                    };

                    try {
                        const itemsToInsert = Array.from({ length: parseInt(quantity, 10) }, () => ({
                            ...itemTemplate
                        }));

                        const { error } = await supabaseClient
                            .from('inventory_items') 
                            .insert(itemsToInsert);

                        if (error) throw error;

                        setMessage(`æˆåŠŸæ–°å¢ ${quantity} ä»¶ã€Œ${name}ã€ï¼`);
                        setName('');
                        setBarcode('');
                        setPriceInput(0); 
                        setPriceMode('unit'); 
                        setItemCurrency(defaultCurrency); 
                        setQuantity(1);
                        setTimeout(() => {
                            setMessage('');
                            onSuccess(); 
                        }, 3000);

                    } catch (error) { 
                        console.error("Supabase Insert Error:", error);
                        setMessage('æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«æ¬„ä½æˆ–æ¬Šé™è¨­å®šã€‚');
                    } finally {
                        setLoading(false);
                    }
                };

                return (
                    <div className="p-6 bg-white shadow-xl rounded-2xl">
                        <h2 className="text-2xl font-bold mb-6 text-gray-800">æ–°å¢åº«å­˜é …ç›®</h2>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* æ¢ç¢¼èˆ‡æƒæ */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">æ¢ç¢¼ (Bar Code) <span className="text-red-500">*</span></label>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={barcode}
                                        onChange={(e) => setBarcode(e.target.value)}
                                        className="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="è¼¸å…¥æˆ–æƒææ¢ç¢¼"
                                        required
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setShowScanner(true)}
                                        className="px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow flex items-center gap-2"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                                        æƒæ
                                    </button>
                                </div>
                            </div>
                            
                            {/* åç¨± */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">å“å <span className="text-red-500">*</span></label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="è¼¸å…¥å•†å“åç¨±"
                                    required
                                />
                            </div>

                            {/* é¡åˆ¥ */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">é¡åˆ¥</label>
                                <select
                                    value={category}
                                    onChange={(e) => setCategory(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                >
                                    {categories.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                            </div>

                            {/* åƒ¹æ ¼è¼¸å…¥å€å¡Š (æ–°çš„ Grid ä½ˆå±€) */}
                            <div className="flex space-x-4">
                                {/* è¼¸å…¥æ¨¡å¼é¸æ“‡ */}
                                <div className="w-1/4"> 
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        è¼¸å…¥æ¨¡å¼ <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={priceMode}
                                        onChange={(e) => setPriceMode(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    >
                                        <option value="unit">å–®ä»¶åƒ¹</option>
                                        <option value="total">ç¸½è³¼å…¥åƒ¹</option>
                                    </select>
                                </div>

                                {/* æˆæœ¬/åƒ¹æ ¼è¼¸å…¥ */}
                                <div className="flex-1">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        {priceMode === 'unit' ? 'å–®ä»¶åƒ¹' : 'ç¸½è³¼å…¥åƒ¹'} <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="number"
                                        min="0"
                                        step="0.01"
                                        value={priceInput}
                                        onChange={(e) => setPriceInput(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    />
                                </div>

                                {/* è²¨å¹£é¸æ“‡ (Select) */}
                                <div className="w-1/4"> 
                                    <label className="block text-sm font-medium text-gray-700 mb-1">è²¨å¹£ <span className="text-red-500">*</span></label>
                                    <select
                                        value={itemCurrency}
                                        onChange={(e) => setItemCurrency(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    >
                                        {supportedCurrencies.map(code => (
                                            <option key={code} value={code}>{code}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* æ•¸é‡ */}
                                <div className="flex-1">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">æ•¸é‡ <span className="text-red-500">*</span></label>
                                    <input
                                        type="number"
                                        min="1"
                                        value={quantity}
                                        onChange={(e) => setQuantity(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    />
                                </div>
                            </div>
                            
                            {/* é¡¯ç¤ºè¨ˆç®—å¾Œçš„å–®ä»¶åƒ¹ (è¼”åŠ©è³‡è¨Š) */}
                            <p className="text-sm text-gray-600">
                                * ç³»çµ±å°‡ä»¥å–®ä»¶åƒ¹ **{formatCurrency(calculateUnitPrice(), itemCurrency)}** é€²è¡Œå…¥åº«è¨˜éŒ„
                            </p>

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50"
                            >
                                {loading ? 'æ–°å¢ä¸­...' : 'ç¢ºèªå…¥åº«'}
                            </button>
                        </form>

                        {message && (
                            <div className={`mt-4 p-3 rounded-lg text-sm font-medium text-center ${message.includes('æˆåŠŸ') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                {message}
                            </div>
                        )}

                        {/* æ¢ç¢¼æƒæå™¨ Modal */}
                        {showScanner && (
                            <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
                                    <div className="bg-gray-900 p-4 flex justify-between items-center">
                                        <h3 className="text-white text-lg font-bold">æƒææ¢ç¢¼</h3>
                                        <button onClick={() => setShowScanner(false)} className="text-white text-3xl leading-none">Ã—</button>
                                    </div>
                                    <BarcodeScanner
                                        onDetected={(code) => {
                                            setBarcode(code);
                                            setShowScanner(false);
                                        }}
                                    />
                                    <div className="p-4 text-center text-sm text-gray-600">
                                        å°‡æ¢ç¢¼å°æº–ç•«é¢ä¸­å¤®æ–¹æ¡†å³å¯è‡ªå‹•è¾¨è­˜
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // ----------------------------------------------------------------------
            // 11. çµ„ä»¶ - è¨­å®šé¢æ¿ (SettingsPanel) - å®Œæ•´å¯¦ä½œé¡åˆ¥å’ŒåŒ¯å…¥/åŒ¯å‡ºé‚è¼¯
            // ----------------------------------------------------------------------
            const SettingsPanel = ({ supabaseClient, userId, currentSettings, handleLogout, setActiveTab, supportedCurrencies, onSettingsSaved }) => {
                
                const [categories, setCategories] = useState(currentSettings.categories || []);
                const [newCategoryName, setNewCategoryName] = useState('');
                const [currency, setCurrency] = useState(currentSettings.currency);
                const [useRealtimeRate, setUseRealtimeRate] = useState(currentSettings.use_realtime_rate); 
                
                // åŒ¯å…¥/åŒ¯å‡ºç‹€æ…‹
                const [importFile, setImportFile] = useState(null);
                const [message, setMessage] = useState('');
                const [loading, setLoading] = useState(false);
                
                // ğŸ“Œ æ–°å¢ç‹€æ…‹ï¼šæ˜¯å¦æ¸…é™¤ç¾æœ‰æ•¸æ“š
                const [clearExistingData, setClearExistingData] = useState(false);
                
                // --- åŒ¯å‡ºé‚è¼¯ (ç„¡è®Šå‹•) ---
                const handleExportData = async () => {
                    setLoading(true);
                    setMessage('æ­£åœ¨æº–å‚™åŒ¯å‡ºæ•¸æ“š...');
                    try {
                        // 1. ç²å–æ‰€æœ‰ inventory_items
                        const { data: invData, error: invError } = await supabaseClient
                            .from('inventory_items')
                            .select('*')
                            .eq('user_id', userId);
                        if (invError) throw invError;

                        // 2. ç²å–æ‰€æœ‰ stock_outs
                        const { data: outData, error: outError } = await supabaseClient
                            .from('stock_outs')
                            .select('*')
                            .eq('user_id', userId);
                        if (outError) throw outError;
                        
                        // 3. çµ„åˆæˆå–®ä¸€ç‰©ä»¶
                        const exportData = {
                            metadata: {
                                created_at: new Date().toISOString(),
                                user_id_original: userId, 
                                app_version: 'v1.0.0_with_import_export'
                            },
                            inventory_items: invData,
                            stock_outs: outData,
                        };

                        // 4. ä¸‹è¼‰æª”æ¡ˆ
                        const filename = `inventory_backup_${new Date().toISOString().substring(0, 10)}.json`;
                        downloadJsonFile(exportData, filename);

                        setMessage('æˆåŠŸåŒ¯å‡ºæ‰€æœ‰æ•¸æ“šï¼');
                    } catch (error) {
                        console.error('Export Error:', error);
                        setMessage('åŒ¯å‡ºæ•¸æ“šå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–é€£ç·šã€‚');
                    } finally {
                        setLoading(false);
                        setTimeout(() => setMessage(''), 5000);
                    }
                };

                // --- åŒ¯å…¥é‚è¼¯ (æ–°å¢æ¸…é™¤èˆŠæ•¸æ“šé‚è¼¯) ---
                const handleFileChange = (e) => {
                    setImportFile(e.target.files[0]);
                };

                const handleImportData = async () => {
                    if (!importFile) {
                        setMessage('è«‹å…ˆé¸æ“‡è¦åŒ¯å…¥çš„ JSON æª”æ¡ˆã€‚');
                        return;
                    }

                    let confirmMessage = `æ‚¨ç¢ºå®šè¦åŒ¯å…¥æ•¸æ“šå—ï¼Ÿç¸½å…±å°‡æ–°å¢ç´„ ${Math.round(importFile.size / 1024)} KB çš„æ•¸æ“šã€‚`;
                    if (clearExistingData) {
                        confirmMessage = `è­¦å‘Šï¼šæ‚¨å·²é¸æ“‡ **æ¸…é™¤æ‰€æœ‰ç¾æœ‰åº«å­˜æ•¸æ“š** å¾Œå†åŒ¯å…¥ã€‚æ­¤æ“ä½œä¸å¯é€†ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`;
                    } else {
                        confirmMessage += ` (æ³¨æ„: æ•¸æ“šå°‡ä»¥æ–°å¢æ–¹å¼åŒ¯å…¥ï¼Œå¯èƒ½æœƒæœ‰é‡è¤‡)`;
                    }

                    if (!window.confirm(confirmMessage)) {
                        return;
                    }

                    setLoading(true);
                    setMessage('æ­£åœ¨è®€å–ä¸¦è™•ç†åŒ¯å…¥æª”æ¡ˆ...');

                    try {
                        const fileText = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.onerror = (e) => reject(e);
                            reader.readAsText(importFile);
                        });

                        const importJson = JSON.parse(fileText);
                        
                        if (!importJson.inventory_items || !importJson.stock_outs) {
                            throw new Error('JSON æ ¼å¼éŒ¯èª¤ï¼šç¼ºå°‘å¿…è¦çš„ inventory_items æˆ– stock_outs æ¬„ä½ã€‚');
                        }
                        
                        // ğŸ“Œ 1. æ¸…é™¤ç¾æœ‰æ•¸æ“š
                        if (clearExistingData) {
                            setMessage('æ­£åœ¨æ¸…é™¤æ‰€æœ‰ç¾æœ‰æ•¸æ“š...');
                            // åˆªé™¤ stock_outs
                            const { error: outDelError } = await supabaseClient
                                .from('stock_outs')
                                .delete()
                                .eq('user_id', userId);
                            if (outDelError) console.warn("Stock outs deletion warning during import:", outDelError);

                            // åˆªé™¤ inventory_items
                            const { error: invDelError } = await supabaseClient
                                .from('inventory_items')
                                .delete()
                                .eq('user_id', userId);
                            if (invDelError) throw invDelError;
                            
                            setMessage('èˆŠæ•¸æ“šæ¸…é™¤å®Œæˆã€‚');
                        }


                        // 2. æ¸…ç†ä¸¦æº–å‚™æ’å…¥æ•¸æ“š (æœ€é‡è¦ï¼šè¦†è“‹ user_id)
                        const itemsToInsert = importJson.inventory_items.map(item => {
                            // ç§»é™¤ ID å’Œ created_atï¼Œè®“ Supabase é‡æ–°ç”Ÿæˆ
                            const { id, created_at, ...rest } = item;
                            return { ...rest, user_id: userId };
                        });

                        const outsToInsert = importJson.stock_outs.map(out => {
                            const { id, created_at, ...rest } = out;
                            return { ...rest, user_id: userId };
                        });
                        
                        let totalInserted = 0;

                        // 3. æ‰¹æ¬¡æ’å…¥ inventory_items
                        if (itemsToInsert.length > 0) {
                            setMessage(`æ­£åœ¨æ’å…¥ ${itemsToInsert.length} ç­†å…¥åº«è¨˜éŒ„...`);
                            const { error } = await supabaseClient
                                .from('inventory_items')
                                .insert(itemsToInsert);
                            if (error) throw error;
                            totalInserted += itemsToInsert.length;
                        }

                        // 4. æ‰¹æ¬¡æ’å…¥ stock_outs
                        if (outsToInsert.length > 0) {
                            setMessage(`æ­£åœ¨æ’å…¥ ${outsToInsert.length} ç­†å‡ºåº«è¨˜éŒ„...`);
                            const { error } = await supabaseClient
                                .from('stock_outs')
                                .insert(outsToInsert);
                            if (error) throw error;
                            totalInserted += outsToInsert.length;
                        }

                        setMessage(`åŒ¯å…¥æˆåŠŸï¼ç¸½å…±æ–°å¢ ${totalInserted} ç­†è¨˜éŒ„ã€‚`);
                        setImportFile(null);
                        document.getElementById('import-file-input').value = '';
                        onSettingsSaved(); // é‡æ–°è¼‰å…¥æ‰€æœ‰æ•¸æ“š
                        
                        setTimeout(() => {
                            setMessage('');
                            setActiveTab('inventory');
                        }, 5000);

                    } catch (error) {
                        console.error('Import Error:', error);
                        setMessage(`åŒ¯å…¥å¤±æ•—: ${error.message || 'æª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–æ•¸æ“šåº«æ’å…¥å¤±æ•—ã€‚'}`);
                        setLoading(false);
                        setTimeout(() => setMessage(''), 8000);
                    }
                };
                
                
                // è™•ç†æ–°å¢é¡åˆ¥ (ç„¡è®Šå‹•)
                const handleAddCategory = () => {
                    const name = newCategoryName.trim();
                    if (name && !categories.map(c => c.toLowerCase()).includes(name.toLowerCase())) {
                        setCategories([...categories, name]);
                        setNewCategoryName('');
                    } else if (name) {
                        setMessage('é¡åˆ¥åç¨±é‡è¤‡ï¼');
                        setTimeout(() => setMessage(''), 3000);
                    }
                };

                // è™•ç†åˆªé™¤é¡åˆ¥ (ç„¡è®Šå‹•)
                const handleDeleteCategory = (name) => {
                    setCategories(categories.filter(cat => cat !== name));
                };


                const handleSaveSettings = async (e) => {
                    e.preventDefault();
                    setLoading(true);
                    setMessage('');

                    if (categories.length === 0) {
                        setMessage('é¡åˆ¥åˆ—è¡¨ä¸èƒ½ç‚ºç©ºã€‚');
                        setLoading(false);
                        return;
                    }

                    const newSettings = {
                        user_id: userId,
                        categories: categories, 
                        currency: currency,
                        use_realtime_rate: useRealtimeRate, 
                    };

                    try {
                        const { error } = await supabaseClient
                            .from('user_settings') 
                            .upsert(newSettings, { onConflict: 'user_id' }); 

                        if (error) throw error;

                        setMessage('è¨­å®šå·²æˆåŠŸå„²å­˜ï¼');

                        setTimeout(() => {
                            setMessage('');
                            onSettingsSaved(); 
                            setActiveTab('inventory');
                        }, 3000); 
                        
                    } catch (error) { 
                        console.error("Supabase Settings Error:", error);
                        setMessage('å„²å­˜è¨­å®šå¤±æ•—ã€‚');
                        setTimeout(() => setMessage(''), 3000);
                    } finally {
                        setLoading(false);
                    }
                };

                return (
                    <div className="p-6 bg-white shadow-xl rounded-2xl space-y-8">
                        <h2 className="text-2xl font-bold text-gray-800 border-b pb-4">æ‡‰ç”¨ç¨‹å¼è¨­å®š</h2>

                        {message && (
                            <div className={`p-3 text-sm rounded-lg text-center ${message.includes('æˆåŠŸ') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                {message}
                            </div>
                        )}

                        <form onSubmit={handleSaveSettings} className="space-y-6">
                            {/* è²¨å¹£è¨­å®š - ä½¿ç”¨ä¸‹æ‹‰é¸å–® (ç„¡è®Šå‹•) */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    é è¨­è²¨å¹£ä»£ç¢¼ (ç”¨æ–¼æˆæœ¬/ç¸½å€¼)
                                </label>
                                <select
                                    value={currency}
                                    onChange={(e) => setCurrency(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                >
                                    {supportedCurrencies.map(code => (
                                        <option key={code} value={code}>{code}</option>
                                    ))}
                                </select>
                                <p className="mt-1 text-xs text-gray-500">è«‹é¸æ“‡ä¸‰ä½å­—æ¯ä»£ç¢¼ã€‚</p>
                            </div>
                            
                            {/* åŒ¯ç‡è¨ˆç®—æ¨¡å¼é–‹é—œ (ç„¡è®Šå‹•) */}
                            <div className="border border-gray-200 p-4 rounded-lg bg-gray-50 flex justify-between items-center">
                                <div>
                                    <label className="text-sm font-medium text-gray-700 block">
                                        æˆæœ¬åŒ¯ç‡è¨ˆç®—æ¨¡å¼
                                    </label>
                                    <p className="text-xs text-gray-500 mt-1">
                                        {useRealtimeRate 
                                            ? 'ç›®å‰: ä½¿ç”¨å³æ™‚åŒ¯ç‡è¨ˆç®—æˆæœ¬' 
                                            : 'ç›®å‰: ä½¿ç”¨è³¼å…¥æ™‚åŒ¯ç‡è¨ˆç®—æˆæœ¬ (éœ€è³‡æ–™åº«æ”¯æ´)'
                                        }
                                    </p>
                                </div>
                                {/* ON/OFF åˆ‡æ›é–‹é—œ */}
                                <button
                                    type="button"
                                    onClick={() => setUseRealtimeRate(!useRealtimeRate)}
                                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${useRealtimeRate ? 'bg-blue-600' : 'bg-gray-200'}`}
                                >
                                    <span
                                        className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${useRealtimeRate ? 'translate-x-6' : 'translate-x-1'}`}
                                    />
                                </button>
                            </div>


                            {/* é¡åˆ¥è¨­å®š (ç„¡è®Šå‹•) */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    åº«å­˜é¡åˆ¥åˆ—è¡¨
                                </label>
                                <div className="flex gap-2 mb-3">
                                    <input
                                        type="text"
                                        value={newCategoryName}
                                        onChange={(e) => setNewCategoryName(e.target.value)}
                                        onKeyDown={(e) => {if (e.key === 'Enter') {e.preventDefault(); handleAddCategory();}}}
                                        className="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="è¼¸å…¥æ–°é¡åˆ¥åç¨±"
                                    />
                                    <button
                                        type="button"
                                        onClick={handleAddCategory}
                                        disabled={newCategoryName.trim() === ''}
                                        className="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition disabled:opacity-50"
                                    >
                                        æ–°å¢
                                    </button>
                                </div>
                                <div className="flex flex-wrap gap-2 p-2 border border-gray-200 rounded-lg min-h-[40px] bg-gray-50">
                                    {categories.length === 0 ? (
                                        <span className="text-sm text-gray-500">å°šç„¡é¡åˆ¥</span>
                                    ) : (
                                        categories.map(cat => (
                                            <span 
                                                key={cat} 
                                                onClick={() => handleDeleteCategory(cat)}
                                                className="inline-flex items-center px-3 py-1 text-sm font-medium bg-indigo-100 text-indigo-800 rounded-full cursor-pointer hover:bg-indigo-200 transition"
                                            >
                                                {cat}
                                                <svg className="ml-2 h-4 w-4 text-indigo-500 hover:text-indigo-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                            </span>
                                        ))
                                    )}
                                </div>
                                <p className="mt-1 text-xs text-gray-500">é»æ“Šé¡åˆ¥åç¨±å³å¯åˆªé™¤ã€‚</p>
                            </div>

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 disabled:opacity-50"
                            >
                                {loading ? 'å„²å­˜ä¸­...' : 'å„²å­˜è¨­å®š'}
                            </button>
                        </form>
                        
                        {/* --- åŒ¯å…¥/åŒ¯å‡ºå€å¡Š --- */}
                        <div className="border-t pt-6 mt-6 space-y-4">
                            <h3 className="text-xl font-semibold text-gray-800">è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h3>
                            
                            {/* åŒ¯å‡ºå€å¡Š (ç„¡è®Šå‹•) */}
                            <div className="border border-blue-200 p-4 rounded-lg bg-blue-50">
                                <p className="text-sm font-medium text-blue-800 mb-2">åŒ¯å‡ºæ‰€æœ‰æ•¸æ“š (å‚™ä»½)</p>
                                <p className="text-xs text-blue-600 mb-3">åŒ¯å‡ºæª”æ¡ˆåŒ…å«æ‰€æœ‰å…¥åº«å’Œå‡ºåº«è¨˜éŒ„ã€‚å»ºè­°å®šæœŸå‚™ä»½ã€‚</p>
                                <button
                                    onClick={handleExportData}
                                    disabled={loading}
                                    className="w-full py-2 px-4 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition disabled:opacity-50"
                                >
                                    {loading ? 'åŒ¯å‡ºä¸­...' : 'ä¸‹è¼‰å‚™ä»½ JSON æª”æ¡ˆ'}
                                </button>
                            </div>

                            {/* åŒ¯å…¥å€å¡Š (æ–°å¢æ¸…é™¤é¸é …) */}
                            <div className="border border-orange-200 p-4 rounded-lg bg-orange-50">
                                <p className="text-sm font-medium text-orange-800 mb-2">åŒ¯å…¥æ•¸æ“š (é‚„åŸ/é·ç§»)</p>
                                
                                {/* ğŸ“Œ æ–°å¢ï¼šæ¸…é™¤ç¾æœ‰æ•¸æ“šé¸é … */}
                                <div className="flex items-center mb-3">
                                    <input
                                        id="clear-data-checkbox"
                                        type="checkbox"
                                        checked={clearExistingData}
                                        onChange={(e) => setClearExistingData(e.target.checked)}
                                        className="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500"
                                    />
                                    <label htmlFor="clear-data-checkbox" className="ml-2 text-sm font-bold text-red-700">
                                        åŒ¯å…¥å‰æ¸…é™¤æ‰€æœ‰ç¾æœ‰æ•¸æ“š (ä¸å¯é€†)
                                    </label>
                                </div>

                                <p className="text-xs text-orange-600 mb-3">
                                    {clearExistingData
                                        ? '**è­¦å‘Šï¼š** æ­¤æ“ä½œå°‡åœ¨åŒ¯å…¥å‰åˆªé™¤æ‚¨ç¾æœ‰çš„æ‰€æœ‰åº«å­˜åŠå‡ºåº«è¨˜éŒ„ã€‚'
                                        : '**æ³¨æ„ï¼š** æ•¸æ“šå°‡ä»¥æ–°å¢æ–¹å¼åŒ¯å…¥ï¼Œèˆ‡ç¾æœ‰è¨˜éŒ„åˆä½µã€‚'
                                    }
                                </p>
                                <div className="flex gap-2">
                                    <input
                                        type="file"
                                        id="import-file-input"
                                        accept=".json"
                                        onChange={handleFileChange}
                                        className="flex-grow p-1 text-sm text-gray-700 border border-orange-300 rounded-lg file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-100 file:text-orange-700 hover:file:bg-orange-200"
                                    />
                                    <button
                                        onClick={handleImportData}
                                        disabled={loading || !importFile}
                                        className="py-2 px-4 bg-orange-500 text-white font-semibold rounded-lg shadow-md hover:bg-orange-600 transition disabled:opacity-50 text-sm"
                                    >
                                        {loading ? 'åŒ¯å…¥ä¸­...' : 'é–‹å§‹åŒ¯å…¥'}
                                    </button>
                                </div>
                            </div>


                            {/* å¸³æˆ¶æ“ä½œ (ç„¡è®Šå‹•) */}
                            <div className="border-t pt-6 mt-6 space-y-4">
                                <h3 className="text-xl font-semibold text-gray-800">å¸³æˆ¶ç®¡ç†</h3>
                                <p className="text-sm text-gray-600">
                                    æ‚¨çš„ Supabase ID: <code className="bg-gray-200 p-1 rounded text-xs">{userId}</code>
                                </p>
                                <button
                                    onClick={handleLogout}
                                    className="w-full py-2 px-4 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-300"
                                >
                                    ç™»å‡º
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };


            // ----------------------------------------------------------------------
            // 12. çµ„ä»¶ - å‡ºåº«é é¢ (StockOutPage)
            // ----------------------------------------------------------------------
            const StockOutPage = ({ supabaseClient, userId, inventory, stockOuts, setActiveTab }) => {
                const [barcode, setBarcode] = useState('');
                const [name, setName] = useState('');
                const [quantity, setQuantity] = useState(1);
                const [showScanner, setShowScanner] = useState(false);
                const [message, setMessage] = useState('');
                const [loading, setLoading] = useState(false);

                // å»ºç«‹ã€Œåç¨± â†’ æ¢ç¢¼ã€çš„æ˜ å°„è¡¨ï¼ˆåªåŒ…å«ç›®å‰æœ‰åº«å­˜çš„é …ç›®ï¼‰
                const nameToBarcodeMap = useMemo(() => {
                    const map = {};
                    // å‚³é null, null, null ç¢ºä¿åªè¨ˆç®—åº«å­˜ï¼Œä¸é€²è¡Œæˆæœ¬è½‰æ›
                    const grouped = aggregateInventoryData(inventory, stockOuts, null, null, null); 
                    grouped.forEach(item => {
                        if (item.currentStock > 0) {
                            if (!map[item.name]) {
                                map[item.name] = item.barcode;
                            } else if (map[item.name] !== item.barcode) {
                                map[item.name] = null; // åç¨±ä¸å”¯ä¸€
                            }
                        }
                    });
                    return map;
                }, [inventory, stockOuts]);

                // ç•¶ barcode æ”¹è®Š â†’ è‡ªå‹•å¡«åç¨±
                useEffect(() => {
                    if (!barcode) {
                        setName('');
                        return;
                    }
                    const grouped = aggregateInventoryData(inventory, stockOuts, null, null, null);
                    const found = grouped.find(g => g.barcode === barcode);
                    if (found) {
                        setName(found.name);
                    } else {
                        setName('');
                    }
                }, [barcode, inventory, stockOuts]);

                // ç•¶åç¨±æ”¹è®Š â†’ è‡ªå‹•å¡«æ¢ç¢¼ï¼ˆåƒ…åœ¨åç¨±å”¯ä¸€å°æ‡‰æ™‚ï¼‰
                useEffect(() => {
                    if (!name) {
                        setBarcode('');
                        return;
                    }
                    const possibleBarcode = nameToBarcodeMap[name];
                    if (possibleBarcode) {
                        setBarcode(possibleBarcode);
                    }
                }, [name, nameToBarcodeMap]);

                // è¨ˆç®—ç›®å‰åº«å­˜é‡
                const currentStock = useMemo(() => {
                    const grouped = aggregateInventoryData(inventory, stockOuts, null, null, null);
                    const item = grouped.find(g => g.barcode === barcode);
                    return item ? item.currentStock : 0;
                }, [barcode, inventory, stockOuts]);

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    const qty = parseInt(quantity, 10);

                    if (!barcode || !name || qty <= 0) {
                        setMessage('è«‹å®Œæ•´å¡«å¯«æ¢ç¢¼ã€å“åå’Œæ•¸é‡');
                        return;
                    }
                    if (qty > currentStock) {
                        setMessage(`å‡ºåº«æ•¸é‡ä¸èƒ½å¤§æ–¼ç›®å‰åº«å­˜ ${currentStock} ä»¶`);
                        return;
                    }
                    
                    setLoading(true);
                    setMessage('');
                    
                    const newStockOut = {
                        user_id: userId,
                        barcode: barcode.trim(),
                        name: name.trim(),
                        quantity: qty,
                    };

                    try {
                        const { error } = await supabaseClient
                            .from('stock_outs') 
                            .insert([newStockOut]);

                        if (error) throw error;

                        setMessage(`æˆåŠŸå‡ºåº« ${newStockOut.quantity} ä»¶ã€Œ${newStockOut.name}ã€`);
                        setBarcode('');
                        setName('');
                        setQuantity(1);
                        // æˆåŠŸå¾Œåˆ‡æ›åˆ°ç¸½è¦½é é¢
                        setTimeout(() => {
                            setMessage('');
                            setActiveTab('inventory');
                        }, 2000);
                    } catch (error) { 
                        console.error("Supabase Stock Out Error:", error);
                        setMessage('å‡ºåº«å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡');
                    } finally {
                        setLoading(false);
                    }
                };

                return (
                    <div className="p-6 bg-white shadow-xl rounded-2xl">
                        <h2 className="text-2xl font-bold mb-6 text-gray-800">å‡ºåº« / å–è²¨</h2>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* åç¨±è¼¸å…¥æ¡† */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    åç¨± <span className="text-red-500">*</span>
                                </label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="è¼¸å…¥å“åï¼ˆæœƒè‡ªå‹•å¸¶å‡ºæ¢ç¢¼ï¼‰"
                                    list="name-suggestions"
                                    required
                                />
                                <datalist id="name-suggestions">
                                    {Object.keys(nameToBarcodeMap).filter(n => nameToBarcodeMap[n] !== null).map(name => (
                                        <option key={name} value={name} />
                                    ))}
                                </datalist>
                                {name && nameToBarcodeMap[name] === null && (
                                    <p className="text-xs text-orange-600 mt-1">
                                        â€» æ­¤å“åå°æ‡‰å¤šå€‹æ¢ç¢¼ï¼Œè«‹æƒææˆ–æ‰‹å‹•è¼¸å…¥æ­£ç¢ºæ¢ç¢¼
                                    </p>
                                )}
                            </div>

                            {/* æ¢ç¢¼ */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    æ¢ç¢¼ (Bar Code) <span className="text-red-500">*</span>
                                </label>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={barcode}
                                        onChange={(e) => setBarcode(e.target.value)}
                                        className="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="è¼¸å…¥æˆ–æƒææ¢ç¢¼ï¼ˆæœƒè‡ªå‹•å¸¶å‡ºå“åï¼‰"
                                        required
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setShowScanner(true)}
                                        className="px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow flex items-center gap-2"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                                        æƒæ
                                    </button>
                                </div>
                            </div>

                            {/* ç›®å‰åº«å­˜é¡¯ç¤º */}
                            {barcode && (
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <span className="text-sm font-medium text-blue-800">
                                        ç›®å‰åº«å­˜é‡ï¼š{currentStock} ä»¶
                                    </span>
                                </div>
                            )}

                            {/* å‡ºåº«æ•¸é‡ */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    å‡ºåº«æ•¸é‡ <span className="text-red-500">*</span>
                                </label>
                                <input
                                    type="number"
                                    min="1"
                                    max={currentStock || 1}
                                    value={quantity}
                                    onChange={(e) => setQuantity(Math.max(1, parseInt(e.target.value) || 1))}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                    disabled={currentStock === 0}
                                />
                                {currentStock === 0 && <p className="text-xs text-red-600 mt-1">æ­¤é …ç›®ç„¡åº«å­˜ï¼Œç„¡æ³•å‡ºåº«ã€‚</p>}
                            </div>

                            <button
                                type="submit"
                                disabled={loading || currentStock === 0 || !barcode || !name}
                                className="w-full py-3 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 disabled:opacity-50"
                            >
                                {loading ? 'è™•ç†ä¸­...' : 'ç¢ºèªå‡ºåº«'}
                            </button>
                        </form>

                        {message && (
                            <div className={`mt-4 p-3 rounded-lg text-sm font-medium text-center ${
                                message.includes('æˆåŠŸ') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                            }`}>
                                {message}
                            </div>
                        )}

                        {/* æ¢ç¢¼æƒæå™¨ Modal */}
                        {showScanner && (
                            <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
                                    <div className="bg-gray-900 p-4 flex justify-between items-center">
                                        <h3 className="text-white text-lg font-bold">æƒææ¢ç¢¼</h3>
                                        <button onClick={() => setShowScanner(false)} className="text-white text-3xl leading-none">Ã—</button>
                                    </div>
                                    <BarcodeScanner
                                        onDetected={(code) => {
                                            setBarcode(code);
                                            setShowScanner(false);
                                        }}
                                    />
                                    <div className="p-4 text-center text-sm text-gray-600">
                                        å°‡æ¢ç¢¼å°æº–ç•«é¢ä¸­å¤®æ–¹æ¡†å³å¯è‡ªå‹•è¾¨è­˜
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };


            // ----------------------------------------------------------------------
            // 13. ä¸»æ‡‰ç”¨ç¨‹å¼ä»‹é¢ (Main UI)
            // ----------------------------------------------------------------------
            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header/Navbar */}
                    <nav className="bg-white shadow-md sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex-shrink-0 text-xl font-bold text-gray-900">
                                    ğŸ“¦ åº«å­˜ç®¡ç†
                                </div>
                                <div className="text-sm text-gray-500">
                                    ä½¿ç”¨è€… ID: {userId ? userId.substring(0, 8) + '...' : 'N/A'}
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow">
                        <div className="flex border-b border-gray-200">
                            {/* æ¦‚è¦ */}
                            <button
                                onClick={() => setActiveTab('inventory')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'inventory' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                æ¦‚è¦
                            </button>

                            {/* å‡ºåº« */}
                            <button
                                onClick={() => setActiveTab('stockout')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'stockout' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                å‡ºåº«
                            </button>

                            {/* æ–°å¢åŠ  */}
                            <button
                                onClick={() => setActiveTab('add')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'add' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                æ–°å¢åŠ 
                            </button>

                            {/* è¨­å®š */}
                            <button
                                onClick={() => setActiveTab('settings')}
                                className={`py-3 px-6 text-lg font-medium transition duration-200 ${
                                    activeTab === 'settings' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                è¨­å®š
                            </button>
                        </div>

                        <div className="mt-6">
                        {activeTab === 'add' && settings && (
                            <AddItemForm 
                                supabaseClient={supabaseClient} 
                                userId={userId} 
                                categories={settings.categories} 
                                defaultCurrency={settings.currency}
                                onSuccess={() => {fetchInitialData(); setActiveTab('inventory');}}
                                supportedCurrencies={supportedCurrencies} 
                                exchangeRates={exchangeRates} // ğŸ“Œ å‚³éå³æ™‚åŒ¯ç‡
                            />
                        )}

                        {activeTab === 'inventory' && settings && (
                            <InventoryOverview
                                settings={settings}
                                overviewData={overviewData}
                                setSelectedItem={setSelectedItem} 
                                rateError={rateError}
                            />
                        )}
                        
                        {activeTab === 'stockout' && settings && (
                            <StockOutPage
                                supabaseClient={supabaseClient}
                                userId={userId}
                                inventory={inventory}
                                stockOuts={stockOuts}
                                setActiveTab={setActiveTab}
                            />
                        )}
                            
                        {activeTab === 'settings' && settings && (
                            <SettingsPanel 
                                supabaseClient={supabaseClient} 
                                userId={userId} 
                                currentSettings={settings} 
                                handleLogout={handleLogout} 
                                setActiveTab={setActiveTab}
                                supportedCurrencies={supportedCurrencies} 
                                onSettingsSaved={fetchInitialData} 
                            />
                        )}
                        </div>

                        {/* æ˜ç´°å½ˆçª—æ¸²æŸ“ */}
                        {currentSelectedItem && settings && (
                            <DetailModal
                                item={currentSelectedItem} 
                                inventory={inventory}
                                stockOuts={stockOuts}
                                onClose={() => setSelectedItem(null)}
                                settings={settings}
                                userId={userId}
                                refreshData={fetchInitialData}
                                supportedCurrencies={supportedCurrencies} 
                                exchangeRates={exchangeRates} // ğŸ“Œ å‚³éå³æ™‚åŒ¯ç‡
                            />
                        )}
                    </main>

                    <footer className="py-4 text-center text-sm text-gray-500">
                        <p>Â© 2024å¹´åº«å­˜ç®¡ç†æ‡‰ç”¨ç¨‹å¼ã€‚æ‰€æœ‰è³‡æ–™å‡ä½¿ç”¨ Supabase PostgREST å³æ™‚åŒæ­¥ã€‚åŒ¯ç‡ç”± Frankfurter API æä¾›ã€‚</p>
                    </footer>
                </div>
            );
        };

        // æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼åˆ° DOM
        if (typeof ReactDOM !== 'undefined') {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        } else {
             console.error("ReactDOM not found. Please check script loading.");
        }
    </script>
</body>
</html>
